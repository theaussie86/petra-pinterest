# Testing

## Quick Start

```bash
npm test              # Run all tests
npm test -- --watch   # Watch mode (re-runs on file changes)
npm test -- --coverage # Generate coverage report
```

## Stack

- **Vitest** — Test runner (separate config from Vite to avoid loading TanStack Start plugins)
- **jsdom** — Browser API simulation
- **@testing-library/react** — Available for future component tests

## File Layout

Tests are colocated next to their source files:

```
src/lib/
├── utils.ts
├── utils.test.ts
├── api/
│   ├── pins.ts
│   ├── pins.test.ts
│   ├── articles.ts
│   ├── articles.test.ts
│   ├── blog-projects.ts
│   ├── blog-projects.test.ts
│   ├── metadata.ts
│   └── metadata.test.ts
├── server/
│   ├── metadata.ts
│   ├── metadata.test.ts
│   ├── scraping.ts
│   ├── scraping.test.ts
│   ├── pinterest-publishing.ts
│   ├── pinterest-publishing.test.ts
│   ├── gemini-key.ts
│   └── gemini-key.test.ts
└── gemini/
    ├── client.ts
    └── client.test.ts
```

## Test Infrastructure

All shared test utilities live in `src/test/`:

| File | Purpose |
|------|---------|
| `setup.ts` | Global setup — stubs `import.meta.env`, clears mocks between tests |
| `mocks/supabase.ts` | Chainable Supabase client mock factory |
| `mocks/auth.ts` | `ensureProfile()` mock with default tenant_id |
| `factories.ts` | Test data builders (`buildPin()`, `buildArticle()`, etc.) |

### Supabase Mock

The mock mirrors the Supabase JS client's chainable query-builder API:

```ts
import { createMockQueryBuilder, createMockSupabaseClient } from '@/test/mocks/supabase'

// Create a query builder that resolves with specific data
const qb = createMockQueryBuilder({ data: [{ id: '1', title: 'Test' }] })

// Configure the mock client
const mockFrom = vi.mocked(supabase.from)
mockFrom.mockReturnValue(qb as any)

// For functions that call .from() multiple times:
mockFrom
  .mockReturnValueOnce(firstQb as any)   // first call
  .mockReturnValueOnce(secondQb as any)  // second call
```

### Data Factories

Factories return valid objects with sensible defaults. Override any field:

```ts
import { buildPin, buildArticle, buildBlogProject } from '@/test/factories'

const pin = buildPin()                           // all defaults
const pin = buildPin({ status: 'published' })    // override status
const pin = buildPin({ title: null })            // nullable field
```

### Server Function Testing

Server functions (`createServerFn`) are tested by mocking the TanStack Start wrapper as a passthrough, then mocking the Supabase server clients with `vi.hoisted()`:

```ts
const { mockServerClient, mockServiceClient } = vi.hoisted(() => ({
  mockServerClient: {
    from: vi.fn(),
    auth: { getUser: vi.fn().mockResolvedValue({ data: { user: { id: 'test-user' } }, error: null }) },
  },
  mockServiceClient: {
    functions: { invoke: vi.fn().mockResolvedValue({ data: null, error: null }) },
    rpc: vi.fn(),
  },
}))

vi.mock('@tanstack/react-start', () => ({
  createServerFn: () => ({
    inputValidator: (validator: any) => ({
      handler: (handler: any) => (input: any) => handler({ data: validator(input.data) }),
    }),
  }),
}))

vi.mock('./supabase', () => ({
  getSupabaseServerClient: () => mockServerClient,
  getSupabaseServiceClient: () => mockServiceClient,
}))
```

## What's Tested

| Layer | What | Why |
|-------|------|-----|
| **Utilities** | `cn()`, `sanitizeHtml()` | Pure functions, no mocking needed |
| **API** | All CRUD functions in `src/lib/api/` | Validates correct Supabase queries, filters, ordering |
| **Server functions** | Metadata generation, scraping, publishing, Gemini key management | Complex multi-step business logic with status machines |
| **Gemini client** | Metadata generation, feedback flow, article extraction | External API integration with structured output parsing |

## What's NOT Tested (and why)

- **Hooks** — Thin wrappers around TanStack Query; uniform pattern (query + toast + invalidation), low risk
- **React components** — Business logic lives in hooks/API/server layers which are covered
- **shadcn/ui primitives** — Tested upstream
- **Route definitions** — Auto-generated by TanStack Router

## CI

Tests run automatically on push and PR to `main` via GitHub Actions (`.github/workflows/test.yml`). No external services needed — all tests use mocks.
