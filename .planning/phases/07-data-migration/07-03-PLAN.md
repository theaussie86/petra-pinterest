---
phase: 07-data-migration
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - scripts/migration/migrate-boards.ts
autonomous: true

must_haves:
  truths:
    - "All Airtable Boards records are upserted into Supabase boards table"
    - "Board pinterest_id is correctly mapped from Airtable pinterest_id field"
    - "Board blog_project_id FK correctly references migrated projects"
    - "Board cover_image_url is preserved from Airtable attachment URL (temporary)"
    - "Script is idempotent -- re-running updates existing records without duplicates"
  artifacts:
    - path: "scripts/migration/migrate-boards.ts"
      provides: "Board migration script"
      contains: "migrate-boards"
  key_links:
    - from: "scripts/migration/migrate-boards.ts"
      to: "scripts/migration/data/id-maps.json"
      via: "Project ID mapping for blog_project_id FK"
      pattern: "projectIdMap|id-maps"
    - from: "scripts/migration/migrate-boards.ts"
      to: "scripts/migration/lib/airtable-client.ts"
      via: "fetchAllRecords for Boards table"
      pattern: "fetchAllRecords"
---

<objective>
Migrate boards from Airtable to Supabase.

Purpose: Boards must be migrated before pins (pins reference boards via FK). Board records are straightforward -- name, pinterest_id, and project reference. Board cover images are handled in Plan 05 (separate image migration pass).

Output: CLI script that reads boards from Airtable API and upserts into Supabase.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-data-migration/07-CONTEXT.md
@.planning/phases/07-data-migration/07-01-SUMMARY.md
@supabase/migrations/00005_pins_and_boards.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create board migration script</name>
  <files>scripts/migration/migrate-boards.ts</files>
  <action>
Create `scripts/migration/migrate-boards.ts` -- a CLI script run with `npx tsx scripts/migration/migrate-boards.ts`.

**Prerequisites:** `migrate-projects.ts` must have run first (needs project ID mappings in id-maps.json).

**Algorithm:**

1. Load ID mappings from `scripts/migration/data/id-maps.json`
2. Verify project mappings exist (abort if empty with helpful error message)
3. Fetch all records from Airtable "Boards" table (`tblhrv8QYrWYrFpis`)
4. Get `MIGRATION_TENANT_ID` from env
5. For each Airtable record:
   a. Map fields:
      - `name` = fields["Name"]
      - `pinterest_board_id` = fields["pinterest_id"] (the Pinterest external ID string)
      - `cover_image_url` = First attachment URL from fields["Cover"] array, or null
        - Note: This is an Airtable CDN URL (temporary). Plan 05 will download and re-upload to Supabase Storage, then update this field.
   b. Map `blog_project_id`:
      - fields["Blog Projekt"] is an array of linked record IDs
      - Look up in id-maps.json projects mapping to get Supabase UUID
      - If no project mapping found, log error and skip this board
   c. Set `tenant_id` = MIGRATION_TENANT_ID

6. **Upsert strategy**: Use the unique constraint on `(blog_project_id, pinterest_board_id)` for boards that have a pinterest_board_id.
   - For boards WITH pinterest_board_id: upsert with `onConflict: 'blog_project_id,pinterest_board_id'`
   - For boards WITHOUT pinterest_board_id (unlikely but handle): check by name + project, insert if not exists
   - After upsert, read back the record to get its Supabase UUID
   - Store Airtable-to-Supabase ID mapping in id-maps.json under "boards"

7. Save updated ID mapping file
8. Log results using `logMigrationResult()`

**Data volume:** ~130 boards across 2 projects. No batch optimization needed but handle gracefully.

**Boards with Pins linked:** The Airtable Board record has a "Pins" linked field, but we don't use it for migration -- pins are linked to boards in the pin migration step (Plan 04) via the pin's Board field.
  </action>
  <verify>
Run `npx tsx scripts/migration/migrate-boards.ts` and verify:
1. Console output shows "Boards: X created, Y updated, Z errors"
2. Check Supabase: `SELECT id, name, pinterest_board_id, blog_project_id FROM boards LIMIT 5;` returns migrated boards
3. Verify pinterest_board_id is populated: `SELECT COUNT(*) FROM boards WHERE pinterest_board_id IS NOT NULL;`
4. Run script again -- idempotent (0 created, X updated)
5. id-maps.json updated with board mappings
  </verify>
  <done>All boards migrated from Airtable to Supabase with pinterest_board_id and project FK. ID mappings persisted for pin migration. Cover image URLs stored temporarily (migrated to Storage in Plan 05).</done>
</task>

</tasks>

<verification>
1. All Airtable Boards records exist in Supabase boards table
2. Board pinterest_board_id correctly mapped from Airtable pinterest_id field
3. Board blog_project_id FK references correct project
4. Board cover_image_url contains Airtable CDN URL (temporary, Plan 05 migrates to Storage)
5. ID mapping file contains board mappings
6. Script is idempotent (re-run produces 0 creates)
</verification>

<success_criteria>
All boards (~130) are migrated to Supabase with correct pinterest_board_id and project FK relationships. Re-running the script updates existing records without duplicates. Board ID mappings enable pin migration in Plan 04.
</success_criteria>

<output>
After completion, create `.planning/phases/07-data-migration/07-03-SUMMARY.md`
</output>
