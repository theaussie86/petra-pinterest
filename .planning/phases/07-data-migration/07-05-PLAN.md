---
phase: 07-data-migration
plan: 05
type: execute
wave: 4
depends_on: ["07-04"]
files_modified:
  - scripts/migration/migrate-images.ts
  - scripts/migration/validate.ts
autonomous: true

must_haves:
  truths:
    - "Board cover images are downloaded from Airtable and uploaded to Supabase board-covers bucket"
    - "Brand kit files are downloaded from Airtable and uploaded to Supabase brand-kit bucket"
    - "boards.cover_image_url updated to point to Supabase Storage URL (not Airtable CDN)"
    - "Validation report confirms field-by-field accuracy for all migrated entities"
    - "Validation report identifies any mismatches between Airtable source and Supabase data"
    - "Validation report saved to file for review"
  artifacts:
    - path: "scripts/migration/migrate-images.ts"
      provides: "Board cover and brand kit file migration"
      contains: "board-covers|brand-kit"
    - path: "scripts/migration/validate.ts"
      provides: "Full validation report comparing Airtable vs Supabase"
      contains: "validate"
  key_links:
    - from: "scripts/migration/migrate-images.ts"
      to: "scripts/migration/lib/helpers.ts"
      via: "downloadFile and uploadToStorage"
      pattern: "downloadFile|uploadToStorage"
    - from: "scripts/migration/validate.ts"
      to: "scripts/migration/lib/airtable-client.ts"
      via: "Re-reads all Airtable records for comparison"
      pattern: "fetchAllRecords"
    - from: "scripts/migration/validate.ts"
      to: "scripts/migration/lib/supabase-admin.ts"
      via: "Reads all Supabase records for comparison"
      pattern: "supabaseAdmin"
---

<objective>
Migrate board cover images and brand kit files to Supabase Storage, then run full validation comparing Airtable source data against Supabase.

Purpose: Completes all image/file migration and provides confidence that 100% of data was migrated correctly. The validation report is the final artifact that confirms migration accuracy.

Output: Image migration script, validation script, and saved validation report.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-data-migration/07-CONTEXT.md
@.planning/phases/07-data-migration/07-01-SUMMARY.md
@.planning/phases/07-data-migration/07-02-SUMMARY.md
@.planning/phases/07-data-migration/07-03-SUMMARY.md
@.planning/phases/07-data-migration/07-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate board cover images and brand kit files</name>
  <files>scripts/migration/migrate-images.ts</files>
  <action>
Create `scripts/migration/migrate-images.ts` -- a CLI script run with `npx tsx scripts/migration/migrate-images.ts`.

**Board cover images:**

1. Load board ID mappings from `scripts/migration/data/id-maps.json`
2. Fetch all records from Airtable "Boards" table
3. For each board with a "Cover" attachment:
   a. Download image from Airtable CDN URL using `downloadFile()`
   b. Get the Supabase board UUID from id-maps
   c. Upload to `board-covers` bucket: path `{tenant_id}/{board_id}.{ext}`
   d. Update the Supabase board record's `cover_image_url` to the Supabase Storage public URL
      - Construct URL: `{SUPABASE_URL}/storage/v1/object/public/board-covers/{tenant_id}/{board_id}.{ext}`
   e. If download fails: log error, skip, continue
   f. Rate limit: 200ms delay between uploads

4. Log results: "Board covers: X uploaded, Y skipped, Z errors"

**Brand kit files:**

1. Fetch all records from Airtable "Blog Projekte" table
2. For each project with a "Brand Kit" attachment:
   a. fields["Brand Kit"] is an array of attachment objects
   b. For each attachment:
      - Download from Airtable CDN
      - Get the Supabase project UUID from id-maps
      - Upload to `brand-kit` bucket: path `{tenant_id}/{project_id}/{original_filename}`
      - Preserve original filename for identification
   c. If download fails: log error, skip, continue
   d. Rate limit: 200ms delay between uploads

3. Log results: "Brand kit files: X uploaded, Y skipped, Z errors"

**Note:** Brand kit files are stored in Storage but NOT referenced by a database column. They're available via Storage API listing. This is sufficient for v1 -- if a UI is needed later, a brand_kit_files table can be added.

**Idempotent:** Check if file exists in bucket before downloading. Skip existing files unless `--force` flag passed.
  </action>
  <verify>
Run `npx tsx scripts/migration/migrate-images.ts` and verify:
1. Console shows "Board covers: X uploaded" and "Brand kit files: X uploaded"
2. Check Supabase Storage: board-covers bucket has files
3. Check Supabase: `SELECT id, name, cover_image_url FROM boards WHERE cover_image_url LIKE '%supabase%' LIMIT 3;` -- URLs point to Supabase Storage
4. Check brand-kit bucket has files
5. Re-run: shows "X skipped" (idempotent)
  </verify>
  <done>Board cover images uploaded to board-covers bucket. Brand kit files uploaded to brand-kit bucket. Board cover_image_url updated to Supabase Storage URLs.</done>
</task>

<task type="auto">
  <name>Task 2: Create validation report comparing Airtable vs Supabase</name>
  <files>scripts/migration/validate.ts</files>
  <action>
Create `scripts/migration/validate.ts` -- a CLI script run with `npx tsx scripts/migration/validate.ts`.

**Algorithm:**

1. Load ID mappings from `scripts/migration/data/id-maps.json`
2. Fetch ALL records from ALL 4 Airtable tables
3. Read ALL records from ALL 4 Supabase tables
4. Run field-by-field comparison for each entity type:

**Projects validation:**
For each Airtable project:
- Find corresponding Supabase record via id-maps
- Compare: name, blog_url, description, all 16 branding fields
- Record mismatches as `{ entity: 'project', airtableId, field, airtableValue, supabaseValue }`

**Articles validation:**
For each Airtable article:
- Find corresponding Supabase record via id-maps
- Compare: title, url, content (first 200 chars for comparison), published_at
- Verify blog_project_id FK matches expected project

**Boards validation:**
For each Airtable board:
- Find corresponding Supabase record via id-maps
- Compare: name, pinterest_board_id
- Verify blog_project_id FK matches expected project
- Verify cover_image_url points to Supabase Storage (not still Airtable CDN)

**Pins validation:**
For each Airtable pin:
- Find corresponding Supabase record via id-maps
- Compare: title, description, alt_text, error_message
- Verify status was correctly mapped (PIN_STATUS_MAP)
- Verify scheduled_at matches Veroffentlichungsdatum
- Verify blog_article_id FK matches expected article
- Verify board_id FK matches expected board (or both null)
- Verify image exists in Supabase Storage (check image_path)

5. **Record counts validation:**
- Compare total records per table: Airtable count vs Supabase count
- If counts differ, list missing or extra records

6. **Storage validation:**
- Count files in pin-images bucket vs pin count
- Count files in board-covers bucket vs boards with covers
- Count files in brand-kit bucket vs projects with brand kit

7. **Generate report:**

Save to `scripts/migration/data/validation-report.json`:
```typescript
{
  timestamp: string,
  summary: {
    projects: { total: N, matched: N, mismatches: N, missing: N },
    articles: { total: N, matched: N, mismatches: N, missing: N },
    boards: { total: N, matched: N, mismatches: N, missing: N },
    pins: { total: N, matched: N, mismatches: N, missing: N },
    storage: {
      pin_images: { expected: N, actual: N, missing: N },
      board_covers: { expected: N, actual: N, missing: N },
      brand_kit: { expected: N, actual: N, missing: N },
    }
  },
  mismatches: [{ entity, airtableId, supabaseId, field, expected, actual }],
  missing: [{ entity, airtableId, reason }],
  errors: string[]
}
```

Also save human-readable version to `scripts/migration/data/validation-report.md` with:
- Summary table
- Mismatch details
- Missing records
- Storage status
- Pass/fail verdict

8. Console output: summary with pass/fail per entity type

**Per decisions:** "Mismatches auto-fixed on re-run: running migration again overwrites Supabase with Airtable values, then re-validate." The validation script does NOT fix mismatches itself -- it reports them so the user can re-run migration scripts then re-validate.
  </action>
  <verify>
Run `npx tsx scripts/migration/validate.ts` and verify:
1. Console shows validation summary per entity type
2. `scripts/migration/data/validation-report.json` exists with structured data
3. `scripts/migration/data/validation-report.md` exists with human-readable report
4. If all records match: report shows 100% match across all entities
5. If mismatches exist: report lists specific field-level differences
  </verify>
  <done>Validation report generated comparing all Airtable records against Supabase. Reports saved as JSON and Markdown. Any mismatches identified for review.</done>
</task>

</tasks>

<verification>
1. Board cover images exist in board-covers Supabase Storage bucket
2. Brand kit files exist in brand-kit Supabase Storage bucket
3. Board cover_image_url fields point to Supabase Storage URLs
4. Validation report exists in both JSON and Markdown format
5. Validation summary shows record counts per entity type
6. Validation covers field-by-field comparison for all entity types
7. Storage file counts match expected values
8. All entity types pass validation (or mismatches documented for review)
</verification>

<success_criteria>
All board covers and brand kit files migrated to Supabase Storage. Validation report confirms 100% migration accuracy across all entity types (projects, articles, boards, pins) with field-by-field comparison. Any discrepancies are clearly documented with specific field-level details for resolution.
</success_criteria>

<output>
After completion, create `.planning/phases/07-data-migration/07-05-SUMMARY.md`
</output>
