---
phase: 06-visual-calendar
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/calendar/pin-sidebar.tsx
  - src/components/pins/edit-pin-dialog.tsx
  - src/lib/hooks/use-pins.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Sidebar inline editing saves pin changes successfully when board is unassigned"
    - "Edit pin dialog saves changes successfully when board is unassigned"
    - "Error toasts show actual Supabase error messages for debugging"
  artifacts:
    - path: "src/components/calendar/pin-sidebar.tsx"
      provides: "Board select with __none__ sentinel"
      pattern: "board_id: pin\\.board_id \\|\\| '__none__'"
    - path: "src/components/pins/edit-pin-dialog.tsx"
      provides: "Board select with __none__ sentinel"
      pattern: "board_id: pin\\.board_id \\|\\| '__none__'"
    - path: "src/lib/hooks/use-pins.ts"
      provides: "Error toast with actual error message"
      pattern: "toast\\.error\\(`Failed to update pin: \\$\\{.*error.*\\}`\\)"
  key_links:
    - from: "pin-sidebar.tsx"
      to: "form state"
      via: "board_id initialization"
      pattern: "board_id: pin\\.board_id \\|\\| '__none__'"
    - from: "form state"
      to: "API mutation"
      via: "onSubmit conversion"
      pattern: "board_id: data\\.board_id === '__none__' \\? null : data\\.board_id"
---

<objective>
Fix board select value mismatch causing "Failed to update pin" error in sidebar inline editing and edit dialog.

**Purpose:** Resolve controlled component value inconsistency between form state (empty string) and Select options (__none__ sentinel).

**Output:** Working inline editing in sidebar and edit dialog with proper error messages for debugging.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

## Gap Source
@.planning/phases/06-visual-calendar/06-UAT.md

## Affected Components
@src/components/calendar/pin-sidebar.tsx
@src/components/pins/edit-pin-dialog.tsx
@src/lib/hooks/use-pins.ts

## Related Implementations
@.planning/phases/06-visual-calendar/06-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Fix board_id sentinel mismatch in pin-sidebar.tsx</name>
  <files>src/components/calendar/pin-sidebar.tsx</files>
  <action>
**Root cause:** Form initializes board_id to empty string ('') when pin.board_id is null, but Radix Select options use '__none__' sentinel. Empty string doesn't match any SelectItem value, causing controlled component issues.

**Changes:**

1. **Line 89** — Change board_id initialization:
   - FROM: `board_id: pin.board_id || '',`
   - TO: `board_id: pin.board_id || '__none__',`

2. **Line 118** — Update onSubmit conversion logic:
   - FROM: `board_id: data.board_id || null,`
   - TO: `board_id: data.board_id === '__none__' ? null : data.board_id,`

3. **Line 229** — Remove redundant conversion in onValueChange (already handling sentinel correctly):
   - FROM: `onValueChange={(value) => setValue('board_id', value === '__none__' ? '' : value)}`
   - TO: `onValueChange={(value) => setValue('board_id', value)}`

**Why this fixes it:** Form state now uses the same sentinel value ('__none__') that exists in SelectItem options, preventing value mismatch. Conversion to null only happens at submission boundary (line 118).
  </action>
  <verify>
Read src/components/calendar/pin-sidebar.tsx lines 89, 118, 229 and confirm:
- Line 89: `board_id: pin.board_id || '__none__',`
- Line 118: `board_id: data.board_id === '__none__' ? null : data.board_id,`
- Line 229: `onValueChange={(value) => setValue('board_id', value)}`
  </verify>
  <done>pin-sidebar.tsx uses '__none__' sentinel consistently in form state and converts to null only on submit</done>
</task>

<task type="auto">
  <name>Fix board_id sentinel mismatch in edit-pin-dialog.tsx</name>
  <files>src/components/pins/edit-pin-dialog.tsx</files>
  <action>
Apply identical fix to EditPinDialog component (same systemic issue).

**Changes:**

1. **Line 83** — Change board_id initialization:
   - FROM: `board_id: pin.board_id || '',`
   - TO: `board_id: pin.board_id || '__none__',`

2. **Line 96** — Update onSubmit conversion logic:
   - FROM: `board_id: data.board_id || null,`
   - TO: `board_id: data.board_id === '__none__' ? null : data.board_id,`

3. **Line 166** — Remove redundant conversion in onValueChange:
   - FROM: `onValueChange={(value) => setValue('board_id', value === '__none__' ? '' : value)}`
   - TO: `onValueChange={(value) => setValue('board_id', value)}`

Ensures consistent behavior across both sidebar and dialog edit flows.
  </action>
  <verify>
Read src/components/pins/edit-pin-dialog.tsx lines 83, 96, 166 and confirm:
- Line 83: `board_id: pin.board_id || '__none__',`
- Line 96: `board_id: data.board_id === '__none__' ? null : data.board_id,`
- Line 166: `onValueChange={(value) => setValue('board_id', value)}`
  </verify>
  <done>edit-pin-dialog.tsx uses '__none__' sentinel consistently, matching pin-sidebar.tsx pattern</done>
</task>

<task type="auto">
  <name>Surface actual error messages in useUpdatePin toast</name>
  <files>src/lib/hooks/use-pins.ts</files>
  <action>
Generic "Failed to update pin" toast hides the actual Supabase error, making debugging impossible.

**Change in useUpdatePin function (lines 82-84):**

FROM:
```typescript
onError: () => {
  toast.error('Failed to update pin')
},
```

TO:
```typescript
onError: (error: Error) => {
  toast.error(`Failed to update pin: ${error.message}`)
},
```

**Why:** Exposes actual database constraint violations, RLS errors, or other Supabase errors to the user for debugging. Critical for diagnosing issues like this board_id mismatch.

Apply same pattern to other error handlers if they also use generic messages (useCreatePin line 52, useDeletePin line 98, etc.) for consistency.
  </action>
  <verify>
Read src/lib/hooks/use-pins.ts useUpdatePin function and confirm:
- onError callback accepts `error: Error` parameter
- toast.error includes `${error.message}` in the message string

Run: `grep -n "onError:" src/lib/hooks/use-pins.ts` to verify all mutation hooks show actual error messages
  </verify>
  <done>Error toasts in use-pins.ts hooks display actual error messages instead of generic "Failed to..." text</done>
</task>

</tasks>

<verification>
1. **Sidebar edit flow:**
   - Open calendar, click a pin to open sidebar
   - Change pin board from assigned → "Not assigned" and save
   - Verify: Pin updates successfully, toast shows "Pin updated" (not "Failed to update")
   - Change board from "Not assigned" → actual board and save
   - Verify: Pin updates successfully

2. **Edit dialog flow:**
   - Go to pins list or pin detail page
   - Open edit dialog
   - Test same board assignment toggling (assigned ↔ Not assigned)
   - Verify: Both directions work without errors

3. **Error message verification:**
   - Trigger an intentional error (e.g., try to update a deleted pin or one you don't own if RLS blocks it)
   - Verify: Toast shows actual error message with details, not generic "Failed to update pin"

4. **Regression check:**
   - Test editing title, description, alt_text, status without touching board field
   - Verify: All fields save correctly as before
</verification>

<success_criteria>
- [ ] Sidebar inline editing saves board assignments successfully (both assigning and unassigning boards)
- [ ] Edit pin dialog saves board assignments successfully (both directions)
- [ ] Error toasts display actual Supabase error messages for all pin mutations
- [ ] No controlled/uncontrolled component warnings in browser console
- [ ] UAT test #8 passes (sidebar inline editing works without "failed to update" message)
</success_criteria>

<output>
After completion, create `.planning/phases/06-visual-calendar/06-05-SUMMARY.md` documenting:
- Root cause: Form state used '' for null board_id, but Select options used '__none__' sentinel
- Solution: Use '__none__' consistently in form state, convert to null only at submission boundary
- Pattern: Sentinel value consistency critical for controlled Radix UI Select components
- Side benefit: Improved error messages across all pin mutation hooks
</output>
