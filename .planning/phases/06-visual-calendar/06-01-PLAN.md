---
phase: 06-visual-calendar
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/api/pins.ts
  - src/lib/hooks/use-pins.ts
  - src/routes/_authed/calendar.tsx
  - src/components/layout/header.tsx
autonomous: true

must_haves:
  truths:
    - "Calendar page loads at /calendar route behind auth guard"
    - "Blog project dropdown filters pins — 'All projects' or single project"
    - "Status toggle chips filter pins by multiple statuses simultaneously"
    - "Filters persist in URL params and survive page refresh"
    - "Tab toggle switches between Calendar and Unscheduled views"
    - "Header navigation includes Calendar link"
  artifacts:
    - path: "src/lib/api/pins.ts"
      provides: "getAllPins function for cross-project pin fetching"
      contains: "getAllPins"
    - path: "src/lib/hooks/use-pins.ts"
      provides: "useAllPins hook for calendar data"
      contains: "useAllPins"
    - path: "src/routes/_authed/calendar.tsx"
      provides: "Calendar page route with filter state and URL params"
      contains: "createFileRoute"
    - path: "src/components/layout/header.tsx"
      provides: "Calendar nav link"
      contains: "/calendar"
  key_links:
    - from: "src/routes/_authed/calendar.tsx"
      to: "src/lib/hooks/use-pins.ts"
      via: "useAllPins hook"
      pattern: "useAllPins"
    - from: "src/routes/_authed/calendar.tsx"
      to: "URL search params"
      via: "TanStack Router validateSearch"
      pattern: "validateSearch"
---

<objective>
Create the calendar page data layer, route, filtering system, and navigation entry point.

Purpose: Establishes the foundation for the visual calendar — the route, cross-project pin fetching, filtering infrastructure (project dropdown + status chips + URL param persistence), and tab toggle between Calendar and Unscheduled views.

Output: Working calendar route at /calendar with filter controls, tab toggle, and header navigation link. Calendar and Unscheduled content areas are placeholder divs pending Plans 02-04.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/api/pins.ts
@src/lib/hooks/use-pins.ts
@src/routes/_authed.tsx
@src/routes/_authed/dashboard.tsx
@src/components/layout/header.tsx
@src/types/pins.ts
@src/lib/hooks/use-blog-projects.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cross-project pin fetching to data layer</name>
  <files>src/lib/api/pins.ts, src/lib/hooks/use-pins.ts</files>
  <action>
Add `getAllPins()` to the API layer (`src/lib/api/pins.ts`):
- Queries `pins` table with `select('*')` ordered by `scheduled_at` ascending (nulls last), then `created_at` descending
- No project filter — returns ALL pins for the authenticated tenant (RLS handles isolation)
- Returns `Pin[]`

Add `useAllPins()` hook to `src/lib/hooks/use-pins.ts`:
- Query key: `['pins', 'all']`
- Calls `getAllPins()`
- staleTime: 30000 (matches existing pattern)
- No `enabled` guard needed (always fetches)
  </action>
  <verify>TypeScript compiles with no errors: `npx tsc --noEmit`</verify>
  <done>getAllPins API function and useAllPins hook exist, TypeScript compiles clean</done>
</task>

<task type="auto">
  <name>Task 2: Create calendar route with filter controls and tab toggle</name>
  <files>src/routes/_authed/calendar.tsx, src/components/layout/header.tsx</files>
  <action>
Create `src/routes/_authed/calendar.tsx` as a TanStack Router file-based route:

**Route search params (URL-based filter persistence):**
Use TanStack Router's `validateSearch` to define search params:
- `project`: string | undefined — selected project ID (undefined = "All projects")
- `statuses`: string[] | undefined — array of active status filter keys
- `tab`: 'calendar' | 'unscheduled' — active tab (default: 'calendar')

**Page component structure:**
```
<Header user={user} />
<main className="container mx-auto px-4 py-6 max-w-7xl">
  {/* Toolbar row */}
  <div className="flex items-center justify-between mb-6">
    <h1>Calendar</h1>
    <div className="flex items-center gap-3">
      {/* Project dropdown */}
      {/* Tab toggle (Calendar / Unscheduled) */}
    </div>
  </div>

  {/* Status filter chips */}
  <div className="flex flex-wrap gap-2 mb-4">
    {statusChips}
  </div>

  {/* Content area - placeholder for now */}
  {tab === 'calendar' ? (
    <div>Calendar view placeholder</div>
  ) : (
    <div>Unscheduled view placeholder</div>
  )}
</main>
```

**Project dropdown filter:**
- Use `useBlogProjects()` hook to get project list
- Render as a `Select` component (shadcn/ui) with options:
  - "All Projects" (value: empty string / clears param)
  - Each project by name (value: project ID)
- On change, update URL search param `project` via `navigate({ search: ... })`

**Status toggle chips:**
- Render one chip per status from `PIN_STATUS` (excluding 'deleted')
- Each chip is a small button with the status badge color
- Toggle behavior: clicking adds/removes the status from the `statuses` URL param array
- All chips off = show all statuses (no filtering)
- Use the existing `getStatusBadgeClasses()` for active chip styling, muted for inactive

**Tab toggle:**
- Two buttons styled as a segmented control (similar to table/grid toggle in PinsList)
- Values: "Calendar" and "Unscheduled"
- Updates `tab` URL search param

**Data fetching:**
- Call `useAllPins()` to get all pins
- Apply client-side filters based on URL params:
  - If `project` is set, filter to pins where `blog_project_id === project`
  - If `statuses` has values, filter to pins where status is in the array
- Split filtered pins into two groups:
  - `scheduledPins`: pins where `scheduled_at` is not null
  - `unscheduledPins`: pins where `scheduled_at` is null

**Header navigation link:**
Add "Calendar" link to the header (`src/components/layout/header.tsx`):
- Add a `Link` component from TanStack Router pointing to `/calendar`
- Place it next to the "Petra" branding or in the center of the header
- Style as navigation text: `text-sm font-medium text-slate-600 hover:text-slate-900`
- Also add a "Dashboard" link next to it for navigation between the two main views
  </action>
  <verify>
Run `npm run dev` and verify:
1. Navigate to /calendar — page renders with filter controls
2. Project dropdown shows "All Projects" and project names
3. Status chips toggle on/off
4. Tab toggle switches between Calendar/Unscheduled placeholders
5. URL params update when filters change
6. Refresh page — filters persist from URL
7. Header shows Calendar and Dashboard nav links
  </verify>
  <done>Calendar route renders with working project dropdown, status chips, tab toggle, all persisted in URL params, and header nav links</done>
</task>

</tasks>

<verification>
1. `/calendar` route is accessible and protected by auth guard
2. `useAllPins()` fetches all pins across all projects
3. Project dropdown filters pins client-side
4. Status chips filter pins by multiple statuses simultaneously
5. Tab toggle switches content area between calendar/unscheduled
6. All filter state persists in URL and survives refresh
7. Header includes Calendar navigation link
8. TypeScript compiles with no errors
</verification>

<success_criteria>
Calendar page loads at /calendar with functional filter controls (project dropdown, status chips, tab toggle), all state persisted in URL params, and a navigation link in the header. Content areas show placeholder text for Calendar and Unscheduled views.
</success_criteria>

<output>
After completion, create `.planning/phases/06-visual-calendar/06-01-SUMMARY.md`
</output>
