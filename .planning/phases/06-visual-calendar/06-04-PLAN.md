---
phase: 06-visual-calendar
plan: 04
type: execute
wave: 4
depends_on: ["06-03"]
files_modified:
  - src/components/calendar/calendar-day-cell.tsx
  - src/components/calendar/calendar-grid.tsx
  - src/components/calendar/unscheduled-pins-list.tsx
  - src/routes/_authed/calendar.tsx
autonomous: true

must_haves:
  truths:
    - "User can drag a pin from one day cell to another to reschedule it (keeps same time)"
    - "Unscheduled tab shows pins without scheduled_at in a sortable table"
    - "User can bulk-schedule unscheduled pins using existing Phase 5 bulk schedule dialog"
    - "Shared filters (project dropdown + status chips) apply to both calendar and unscheduled views"
    - "Calendar performs smoothly with many pins (lazy loading thumbnails, efficient re-renders)"
  artifacts:
    - path: "src/components/calendar/unscheduled-pins-list.tsx"
      provides: "Table view for unscheduled pins with selection and bulk schedule"
      contains: "UnscheduledPinsList"
  key_links:
    - from: "src/components/calendar/calendar-day-cell.tsx"
      to: "src/lib/hooks/use-pins.ts"
      via: "useUpdatePin for drag-drop rescheduling"
      pattern: "useUpdatePin|onDrop"
    - from: "src/components/calendar/unscheduled-pins-list.tsx"
      to: "src/components/pins/bulk-schedule-dialog.tsx"
      via: "BulkScheduleDialog for scheduling selected pins"
      pattern: "BulkScheduleDialog"
    - from: "src/routes/_authed/calendar.tsx"
      to: "src/components/calendar/unscheduled-pins-list.tsx"
      via: "Rendered in unscheduled tab"
      pattern: "UnscheduledPinsList"
---

<objective>
Add drag-and-drop rescheduling between calendar days and build the Unscheduled pins table with bulk scheduling.

Purpose: Completes the calendar feature set with drag-and-drop rescheduling (the most intuitive way to move pins between days) and the Unscheduled section where users manage pins that haven't been scheduled yet.

Output: Fully functional calendar with drag-and-drop and a complete Unscheduled tab with table view and bulk scheduling.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-visual-calendar/06-01-SUMMARY.md
@.planning/phases/06-visual-calendar/06-02-SUMMARY.md
@.planning/phases/06-visual-calendar/06-03-SUMMARY.md
@src/components/pins/pins-list.tsx
@src/components/pins/bulk-schedule-dialog.tsx
@src/types/pins.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add drag-and-drop rescheduling to calendar day cells</name>
  <files>src/components/calendar/calendar-day-cell.tsx, src/components/calendar/calendar-grid.tsx</files>
  <action>
Implement drag-and-drop using the native HTML5 Drag and Drop API (no external library needed — the interaction is simple: drag pin thumbnail from one day to another).

**CalendarDayCell updates (`calendar-day-cell.tsx`):**

Add new props:
- `onPinDrop: (pinId: string, targetDate: Date) => void`

Make pin thumbnails draggable:
- Add `draggable` attribute to each pin thumbnail div
- `onDragStart`: Set `dataTransfer.setData('text/plain', pin.id)` and add `dataTransfer.effectAllowed = 'move'`
- Add visual feedback: reduce opacity on the dragged thumbnail (`opacity-50` during drag via state)

Make day cells drop targets:
- `onDragOver`: `e.preventDefault()` + `e.dataTransfer.dropEffect = 'move'` — allows drop
- `onDragEnter`: Add visual highlight to the cell (`ring-2 ring-blue-400 bg-blue-50` via state)
- `onDragLeave`: Remove highlight (careful with child element events — use a counter or check relatedTarget)
- `onDrop`: Extract pinId from `dataTransfer.getData('text/plain')`, call `onPinDrop(pinId, date)`, remove highlight

**CalendarGrid updates (`calendar-grid.tsx`):**

Add drop handler:
```typescript
const updatePin = useUpdatePin()

const handlePinDrop = (pinId: string, targetDate: Date) => {
  // Find the pin to get its existing scheduled_at time
  const pin = pins.find(p => p.id === pinId)
  if (!pin || !pin.scheduled_at) return

  const existingDate = new Date(pin.scheduled_at)
  const newDate = new Date(targetDate)
  // Keep the same time, change the date
  newDate.setHours(existingDate.getHours(), existingDate.getMinutes(), 0, 0)

  updatePin.mutate({
    id: pinId,
    scheduled_at: newDate.toISOString(),
  })
}
```

Pass `onPinDrop={handlePinDrop}` to each CalendarDayCell.

**Performance note:** Use `React.memo` on CalendarDayCell with a custom comparison function that checks `pins` array length and pin IDs (not deep equality on all pin fields) to prevent unnecessary re-renders during drag operations.
  </action>
  <verify>
Run `npm run dev` and verify:
1. Pin thumbnails on calendar are draggable (cursor changes, opacity reduces)
2. Day cells highlight when dragging a pin over them
3. Dropping a pin on a different day reschedules it (updates the date, keeps the time)
4. Pin appears in the new day cell after drop
5. The database is updated (refresh confirms new schedule)
  </verify>
  <done>Pins can be dragged between day cells to reschedule. Drop updates the scheduled_at date while preserving the time. Visual feedback shows during drag.</done>
</task>

<task type="auto">
  <name>Task 2: Build UnscheduledPinsList and wire into calendar route</name>
  <files>src/components/calendar/unscheduled-pins-list.tsx, src/routes/_authed/calendar.tsx</files>
  <action>
Create `src/components/calendar/unscheduled-pins-list.tsx`:

**Props:**
```typescript
interface UnscheduledPinsListProps {
  pins: Pin[]
  onPinClick: (pinId: string) => void
}
```

**Component structure** — follows the same table pattern as PinsList but simplified:

State:
- `selectedIds` (Set<string>) for bulk selection
- `bulkScheduleOpen` (boolean) for schedule dialog
- `sortField` / `sortDirection` for sorting

Table columns:
- Checkbox (selection)
- Image (thumbnail 40x40)
- Title (link that calls `onPinClick` instead of navigating — opens sidebar)
- Article (article title via `useArticles` or passed articles prop — or just show project name instead to avoid per-project queries)
- Status (PinStatusBadge)
- Created (formatted date)

Wait — unscheduled pins come from all projects, so we can't use `useArticles(projectId)`. Instead:
- Show the blog project name by looking up from `useBlogProjects()` data
- Column: "Project" instead of "Article"

Toolbar above table:
- Select all checkbox
- When selection active: "Schedule (N)" button that opens BulkScheduleDialog
- Sort dropdown (same pattern as PinsList)

Selection + bulk schedule:
- Reuse `BulkScheduleDialog` from `@/components/pins/bulk-schedule-dialog.tsx`
- Pass `pinIds={Array.from(selectedIds)}`
- On dialog close, clear selection

Empty state: "No unscheduled pins match your filters." with CalendarIcon

**Wire into calendar route (`src/routes/_authed/calendar.tsx`):**

Replace the "Unscheduled view placeholder" div:
- Import `UnscheduledPinsList`
- Pass `pins={unscheduledPins}` (already computed in Plan 01 — filtered pins with `scheduled_at === null`)
- Pass `onPinClick={handlePinClick}` (same handler as calendar, opens sidebar)

**Shared filters verification:**
Ensure that both Calendar tab and Unscheduled tab use the same filtered data:
- Project dropdown filters both
- Status chips filter both
- The split into scheduledPins/unscheduledPins happens AFTER filter application
  </action>
  <verify>
Run `npm run dev` and verify:
1. Switch to "Unscheduled" tab — table shows pins without scheduled dates
2. Table has columns: checkbox, image, title, project, status, created
3. Select pins and click "Schedule" — bulk schedule dialog opens
4. Scheduling pins moves them from unscheduled tab to calendar view
5. Project filter affects both calendar and unscheduled views
6. Status filter affects both calendar and unscheduled views
7. Clicking a pin title in unscheduled list opens the sidebar
8. Empty state shows when no unscheduled pins match filters
  </verify>
  <done>Unscheduled tab shows table of unscheduled pins with selection, bulk scheduling, sorting, and shared filters with the calendar view</done>
</task>

</tasks>

<verification>
1. Drag-and-drop works: drag pin thumbnail from one day to another reschedules it
2. Drag keeps same time, only changes date
3. Visual feedback during drag (opacity, cell highlight)
4. Unscheduled tab shows sortable table of unscheduled pins
5. Bulk schedule dialog works for selected unscheduled pins
6. Scheduling pins moves them to the calendar view
7. Shared filters (project + status) apply to both views
8. Clicking pins in unscheduled list opens sidebar
9. Empty states for both views
10. TypeScript compiles cleanly
</verification>

<success_criteria>
Users can drag pins between days on the calendar to reschedule while keeping the same time. The Unscheduled tab provides a table view of unscheduled pins with bulk scheduling via the existing Phase 5 dialog. Both views share the same filter controls.
</success_criteria>

<output>
After completion, create `.planning/phases/06-visual-calendar/06-04-SUMMARY.md`
</output>
