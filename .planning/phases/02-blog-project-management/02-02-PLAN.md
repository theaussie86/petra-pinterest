---
phase: 02-blog-project-management
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/types/blog-projects.ts
  - src/lib/api/blog-projects.ts
  - src/lib/hooks/use-blog-projects.ts
autonomous: true

must_haves:
  truths:
    - "TypeScript types for BlogProject match the database schema"
    - "API functions perform CRUD operations against Supabase blog_projects table"
    - "TanStack Query hooks provide reactive data fetching and mutations with optimistic updates"
    - "Create mutation includes tenant_id from user profile"
    - "Delete pre-check queries related article/pin counts"
  artifacts:
    - path: "src/types/blog-projects.ts"
      provides: "BlogProject, BlogProjectInsert, BlogProjectUpdate types"
      exports: ["BlogProject", "BlogProjectInsert", "BlogProjectUpdate"]
    - path: "src/lib/api/blog-projects.ts"
      provides: "Supabase CRUD functions"
      exports: ["getBlogProjects", "getBlogProject", "createBlogProject", "updateBlogProject", "deleteBlogProject", "checkProjectRelatedData"]
    - path: "src/lib/hooks/use-blog-projects.ts"
      provides: "TanStack Query hooks"
      exports: ["useBlogProjects", "useBlogProject", "useCreateBlogProject", "useUpdateBlogProject", "useDeleteBlogProject"]
  key_links:
    - from: "src/lib/api/blog-projects.ts"
      to: "src/lib/supabase.ts"
      via: "supabase client import"
      pattern: "import.*supabase.*from.*@/lib/supabase"
    - from: "src/lib/hooks/use-blog-projects.ts"
      to: "src/lib/api/blog-projects.ts"
      via: "API function imports used as queryFn/mutationFn"
      pattern: "import.*from.*@/lib/api/blog-projects"
    - from: "src/lib/api/blog-projects.ts"
      to: "src/types/blog-projects.ts"
      via: "type imports for return types"
      pattern: "import.*type.*from.*@/types/blog-projects"
---

<objective>
Create the complete data layer for blog project management: TypeScript types, Supabase API functions (CRUD + related data check), and TanStack Query hooks with optimistic updates and toast notifications.

Purpose: This data layer is consumed by all UI components in Plans 03 and 04. Clean separation of concerns: types define shape, API functions talk to Supabase, hooks provide reactivity.
Output: Three files forming the data layer — types, API, hooks.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-blog-project-management/02-RESEARCH.md
@src/lib/supabase.ts
@src/lib/auth.ts
@supabase/migrations/00002_blog_projects.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TypeScript types and Supabase API functions</name>
  <files>
    src/types/blog-projects.ts
    src/lib/api/blog-projects.ts
  </files>
  <action>
    1. Create `src/types/blog-projects.ts` with:
       ```typescript
       export interface BlogProject {
         id: string
         tenant_id: string
         name: string
         blog_url: string
         rss_url: string | null
         scraping_frequency: 'daily' | 'weekly' | 'manual'
         description: string | null
         created_at: string
         updated_at: string
       }

       export type BlogProjectInsert = Pick<BlogProject, 'name' | 'blog_url'> & {
         rss_url?: string | null
         scraping_frequency?: 'daily' | 'weekly' | 'manual'
         description?: string | null
       }

       export type BlogProjectUpdate = {
         id: string
         name?: string
         blog_url?: string
         rss_url?: string | null
         scraping_frequency?: 'daily' | 'weekly' | 'manual'
         description?: string | null
       }
       ```

    2. Create `src/lib/api/blog-projects.ts` with CRUD functions:
       - `getBlogProjects()`: SELECT * from blog_projects ordered by created_at desc. Returns `BlogProject[]`.
       - `getBlogProject(id: string)`: SELECT single by id. Returns `BlogProject`.
       - `createBlogProject(project: BlogProjectInsert)`: INSERT with tenant_id from user profile.
         - Get user via `supabase.auth.getUser()`
         - Query `profiles` table for `tenant_id` using user.id
         - Insert project with `{ ...project, tenant_id: profile.tenant_id }`
         - Use `.select().single()` to return the created project
       - `updateBlogProject({ id, ...updates }: BlogProjectUpdate)`: UPDATE by id, return updated project.
       - `deleteBlogProject(id: string)`: DELETE by id.
       - `checkProjectRelatedData(id: string)`: Query counts from `blog_articles` and `pins` tables (use `{ count: 'exact', head: true }`). Return `{ articles: number, pins: number }`. These tables don't exist yet — wrap in try/catch and return `{ articles: 0, pins: 0 }` if tables don't exist (graceful degradation for Phase 2).

       All functions throw on Supabase errors. Import `supabase` from `@/lib/supabase` and types from `@/types/blog-projects`.
  </action>
  <verify>
    - `src/types/blog-projects.ts` exports BlogProject, BlogProjectInsert, BlogProjectUpdate
    - `src/lib/api/blog-projects.ts` exports 6 functions: getBlogProjects, getBlogProject, createBlogProject, updateBlogProject, deleteBlogProject, checkProjectRelatedData
    - createBlogProject includes tenant_id lookup from profiles table
    - `npm run build` passes TypeScript checks
  </verify>
  <done>TypeScript types match database schema. API functions perform all CRUD operations with tenant isolation. Related data check gracefully handles missing tables.</done>
</task>

<task type="auto">
  <name>Task 2: Create TanStack Query hooks with optimistic updates</name>
  <files>src/lib/hooks/use-blog-projects.ts</files>
  <action>
    Create `src/lib/hooks/use-blog-projects.ts` with React Query hooks:

    1. `useBlogProjects()` — useQuery hook:
       - queryKey: `['blog-projects']`
       - queryFn: `getBlogProjects`
       - staleTime: 30000 (30s)

    2. `useBlogProject(id: string)` — useQuery hook:
       - queryKey: `['blog-projects', id]`
       - queryFn: `() => getBlogProject(id)`
       - enabled: `!!id` (don't fetch if id is empty)

    3. `useCreateBlogProject()` — useMutation hook:
       - mutationFn: `createBlogProject`
       - onMutate: Cancel outgoing queries, snapshot previous data, optimistically add temp item to cache
       - onError: Rollback to snapshot, show `toast.error('Failed to create project')`
       - onSuccess: `toast.success('Project created')`
       - onSettled: `queryClient.invalidateQueries({ queryKey: ['blog-projects'] })`

    4. `useUpdateBlogProject()` — useMutation hook:
       - mutationFn: `updateBlogProject`
       - onSuccess: `toast.success('Project updated')`, invalidate `['blog-projects']`
       - onError: `toast.error('Failed to update project')`

    5. `useDeleteBlogProject()` — useMutation hook:
       - mutationFn: `deleteBlogProject`
       - onSuccess: `toast.success('Project deleted')`, invalidate `['blog-projects']`
       - onError: `toast.error('Failed to delete project')`

    Import `useQuery`, `useMutation`, `useQueryClient` from `@tanstack/react-query`.
    Import `toast` from `sonner`.
    Import API functions from `@/lib/api/blog-projects`.
  </action>
  <verify>
    - `src/lib/hooks/use-blog-projects.ts` exports 5 hooks
    - Hooks import from `@tanstack/react-query`, `sonner`, and `@/lib/api/blog-projects`
    - useCreateBlogProject has onMutate optimistic update with rollback in onError
    - `npm run build` passes
  </verify>
  <done>TanStack Query hooks provide reactive CRUD with optimistic updates, cache invalidation, and toast notifications for all blog project operations.</done>
</task>

</tasks>

<verification>
- Types file has BlogProject matching database schema columns
- API file has 6 exported functions all using supabase client
- Hooks file has 5 exported hooks using TanStack Query
- createBlogProject correctly fetches tenant_id from profiles
- useCreateBlogProject has optimistic update with rollback
- All mutations show toast notifications on success/error
- `npm run build` succeeds
</verification>

<success_criteria>
- Complete type-safe data layer: types -> API -> hooks
- CRUD operations work against Supabase blog_projects table
- Tenant isolation enforced in create operation
- Optimistic updates on create with error rollback
- Toast notifications for all mutation outcomes
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-blog-project-management/02-02-SUMMARY.md`
</output>
