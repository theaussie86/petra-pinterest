---
phase: 03-blog-scraping-articles
plan: 07
type: execute
wave: 2
depends_on: ["03-06"]
files_modified:
  - src/lib/api/articles.ts
  - vite.config.ts
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "Scrape Blog button fetches articles from the user's blog and populates the table"
    - "Add Article dialog submits a URL and the article appears in the table"
    - "Vite dev server proxies /api/* requests to Express server on port 3001"
  artifacts:
    - path: "src/lib/api/articles.ts"
      provides: "API functions calling Express scraping endpoints instead of Edge Function"
      contains: "/api/scrape"
    - path: "vite.config.ts"
      provides: "Vite dev proxy configuration for /api/* to port 3001"
      contains: "proxy"
  key_links:
    - from: "src/lib/api/articles.ts"
      to: "server/index.ts"
      via: "fetch /api/scrape with Bearer token"
      pattern: "fetch.*api/scrape"
    - from: "vite.config.ts"
      to: "server/index.ts"
      via: "Vite proxy /api -> localhost:3001"
      pattern: "proxy.*3001"
---

<objective>
Wire the client API layer to call the new Express scraping endpoints instead of the broken Supabase Edge Function, and configure Vite's dev proxy to route `/api/*` to the Express server.

Purpose: Closes both UAT blocker gaps (scrape blog + add article) by replacing the CORS-blocked Edge Function invocations with same-origin API calls proxied through Vite.

Output: Updated article API functions and Vite proxy config that make scraping work end-to-end.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/03-blog-scraping-articles/03-06-SUMMARY.md

# Files to modify:
@src/lib/api/articles.ts
@src/lib/hooks/use-articles.ts
@src/lib/supabase.ts
@vite.config.ts
@src/types/articles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update client API layer and Vite proxy</name>
  <files>
    src/lib/api/articles.ts
    vite.config.ts
  </files>
  <action>
    **1. Update `src/lib/api/articles.ts`** — Replace the `scrapeBlog()` and `addArticleManually()` functions to call the Express server endpoints instead of `supabase.functions.invoke()`.

    Replace `scrapeBlog()`:
    ```typescript
    export async function scrapeBlog(request: ScrapeRequest): Promise<ScrapeResponse> {
      const { data: { session } } = await supabase.auth.getSession()
      if (!session) {
        throw new Error('Not authenticated')
      }

      const response = await fetch('/api/scrape', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${session.access_token}`,
        },
        body: JSON.stringify(request),
      })

      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.errors?.[0] || 'Failed to scrape blog')
      }

      return data as ScrapeResponse
    }
    ```

    Replace `addArticleManually()`:
    ```typescript
    export async function addArticleManually(projectId: string, url: string): Promise<ScrapeResponse> {
      const { data: { session } } = await supabase.auth.getSession()
      if (!session) {
        throw new Error('Not authenticated')
      }

      const response = await fetch('/api/scrape/single', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${session.access_token}`,
        },
        body: JSON.stringify({
          blog_project_id: projectId,
          url,
        }),
      })

      const data = await response.json()

      if (!response.ok) {
        throw new Error(data.errors?.[0] || 'Failed to add article')
      }

      return data as ScrapeResponse
    }
    ```

    Key changes:
    - Replace `supabase.functions.invoke('scrape-blog', { body })` with `fetch('/api/scrape', { ... })`
    - Pass Supabase session access_token as Bearer auth header (server uses this to verify user and get tenant_id)
    - The `/api/scrape` path is relative (will be proxied by Vite in dev, needs reverse proxy in prod)
    - Remove the `ScrapeRequest` import if it's no longer needed for the Edge Function call (check: it's still used for the `scrapeBlog(request: ScrapeRequest)` parameter type, so keep it)

    **2. Update `vite.config.ts`** — Add dev proxy for `/api/*`:

    Add a `server.proxy` configuration to proxy API requests to the Express server:
    ```typescript
    export default defineConfig({
      server: {
        port: 3000,
        proxy: {
          '/api': {
            target: 'http://localhost:3001',
            changeOrigin: true,
          },
        },
      },
      plugins: [
        tsConfigPaths(),
        devtools(),
        tanstackStart(),
        tailwindcss(),
      ],
    })
    ```

    This ensures that during development, any request to `/api/*` (e.g., `/api/scrape`, `/api/scrape/single`, `/api/inngest`) is proxied from the Vite dev server (port 3000) to the Express server (port 3001). This eliminates CORS issues because the client makes same-origin requests.

    **Important:** The proxy only works in dev. For production, a reverse proxy (nginx, Vercel rewrites, or similar) must route `/api/*` to the Express server. This is a production deployment concern that can be addressed later.
  </action>
  <verify>
    - `npm run build` passes (no TypeScript errors in client code)
    - `vite.config.ts` has proxy configuration for '/api'
    - `src/lib/api/articles.ts` no longer references `supabase.functions.invoke`
    - `src/lib/api/articles.ts` uses `fetch('/api/scrape', ...)` with Bearer auth
    - grep confirms: `grep -c "supabase.functions.invoke" src/lib/api/articles.ts` returns 0
    - grep confirms: `grep -c "fetch('/api/scrape" src/lib/api/articles.ts` returns at least 1
  </verify>
  <done>
    Client API functions call Express scraping endpoints instead of Edge Function. Vite dev proxy routes /api/* to Express server on port 3001.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    End-to-end blog scraping via Inngest-powered Express server, replacing the CORS-blocked Supabase Edge Function.
  </what-built>
  <how-to-verify>
    **Prerequisites:** Run both servers in separate terminals:
    - Terminal 1: `npm run dev` (Vite dev server on port 3000)
    - Terminal 2: `npm run dev:server` (Express server on port 3001)

    Ensure `.env.local` has the new server env vars:
    ```
    SUPABASE_URL=<your-project-url>
    SUPABASE_SERVICE_ROLE_KEY=<your-service-role-key>
    ```

    **Test 1: Scrape Blog**
    1. Navigate to a blog project detail page
    2. Click the "Scrape Blog" button
    3. The button should show "Scraping..." with spinner
    4. After completion, a success message with article counts should appear
    5. Articles should populate the table

    **Test 2: Add Article**
    1. Click the "Add Article" button
    2. Enter a valid article URL from your blog
    3. Submit the form
    4. The dialog should close and the article should appear in the table

    **Test 3: Article Detail**
    1. Click on a scraped article title in the table
    2. The article detail page should display with title, date, URL, and content
  </how-to-verify>
  <resume-signal>Type "approved" if scraping works, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. `npm run dev` + `npm run dev:server` — both servers start without errors
3. Clicking "Scrape Blog" on a project detail page returns articles (no CORS error)
4. Clicking "Add Article" with a valid URL adds the article (no CORS error)
5. No references to `supabase.functions.invoke` remain in `src/lib/api/articles.ts`
</verification>

<success_criteria>
- Both UAT blocker gaps closed: Scrape Blog works, Add Article works
- No CORS errors in browser console during scraping
- Articles appear in the table after scraping
- Vite dev proxy correctly forwards /api/* requests to Express server
</success_criteria>

<output>
After completion, create `.planning/phases/03-blog-scraping-articles/03-07-SUMMARY.md`
</output>
