---
phase: 08-pinterest-oauth
plan: 04
type: execute
wave: 4
depends_on: ["08-03"]
files_modified:
  - src/lib/server/pinterest-publishing.ts
  - server/inngest/functions/publish-scheduled-pins.ts
  - server/inngest/functions/refresh-pinterest-tokens.ts
  - server/inngest/index.ts
autonomous: true

must_haves:
  truths:
    - "A single pin can be published to Pinterest via server function"
    - "Scheduled pins auto-publish via Inngest cron job"
    - "Publish failure sets pin to 'error' status with error message"
    - "Successful publish stores pinterest_pin_id and pinterest_pin_url on pin record"
    - "Token refresh runs daily and proactively refreshes tokens expiring within 7 days"
    - "Failed token refresh marks connection as inactive"
  artifacts:
    - path: "src/lib/server/pinterest-publishing.ts"
      provides: "Server functions for manual pin publishing"
      exports: ["publishPinFn", "publishPinsBulkFn"]
    - path: "server/inngest/functions/publish-scheduled-pins.ts"
      provides: "Inngest cron function for auto-publishing scheduled pins"
      exports: ["publishScheduledPins"]
    - path: "server/inngest/functions/refresh-pinterest-tokens.ts"
      provides: "Inngest cron function for proactive token refresh"
      exports: ["refreshPinterestTokens"]
  key_links:
    - from: "src/lib/server/pinterest-publishing.ts"
      to: "src/lib/server/pinterest-api.ts"
      via: "createPinterestPin import"
      pattern: "import.*createPinterestPin"
    - from: "server/inngest/functions/publish-scheduled-pins.ts"
      to: "src/lib/server/pinterest-api.ts"
      via: "createPinterestPin import"
      pattern: "createPinterestPin"
    - from: "server/inngest/functions/refresh-pinterest-tokens.ts"
      to: "src/lib/server/pinterest-api.ts"
      via: "refreshPinterestToken import"
      pattern: "refreshPinterestToken"
    - from: "server/inngest/index.ts"
      to: "server/inngest/functions/publish-scheduled-pins.ts"
      via: "functions array registration"
      pattern: "publishScheduledPins"
---

<objective>
Implement pin publishing to Pinterest (both manual and automatic) and background token refresh.

Purpose: This is the core value delivery — actually creating pins on Pinterest. The auto-publish cron ensures scheduled pins go live on time without user intervention. Token refresh ensures connections stay healthy without requiring users to re-authorize every 30 days.

Output: Server functions for manual publish (single + bulk), Inngest cron for auto-publishing every 15 minutes, Inngest cron for daily token refresh, registered in Inngest function list.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-pinterest-oauth-authentication-for-multi-account-publishing/08-CONTEXT.md
@.planning/phases/08-pinterest-oauth-authentication-for-multi-account-publishing/08-RESEARCH.md
@.planning/phases/08-pinterest-oauth-authentication-for-multi-account-publishing/08-01-SUMMARY.md
@.planning/phases/08-pinterest-oauth-authentication-for-multi-account-publishing/08-03-SUMMARY.md
@src/lib/server/pinterest-api.ts
@src/lib/server/supabase.ts
@src/lib/api/pins.ts
@src/types/pins.ts
@src/types/pinterest.ts
@server/inngest/index.ts
@server/inngest/client.ts
@server/inngest/functions/generate-metadata.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Manual pin publishing server functions</name>
  <files>src/lib/server/pinterest-publishing.ts</files>
  <action>
Create `src/lib/server/pinterest-publishing.ts` with server functions for manual publishing (user-triggered).

**Helper function `publishSinglePin(supabase, serviceClient, pinId: string)`:**
This is the core publish logic shared by manual and bulk operations:

1. Fetch pin with related data: `pins` joined with `blog_articles(url)` and `boards(pinterest_board_id)` and `blog_projects(pinterest_connection_id)` — use `.select('*, blog_articles(url), boards(pinterest_board_id), blog_projects(pinterest_connection_id)')`
2. Validate pin is ready:
   - Has a board_id with a pinterest_board_id (throw "Pin must have a Pinterest board assigned")
   - Has blog_projects.pinterest_connection_id (throw "No Pinterest account connected to this project")
   - Has image_path (throw "Pin must have an image")
3. Update pin status to 'publishing'
4. Get access token from Vault via service client: `serviceClient.rpc('get_pinterest_access_token', { p_connection_id: pin.blog_projects.pinterest_connection_id })`
5. Get public URL for pin image: construct from Supabase storage URL (use `SUPABASE_URL` env + `/storage/v1/object/public/pin-images/` + image_path)
6. Build `PinterestCreatePinPayload`:
   - `board_id`: pin.boards.pinterest_board_id
   - `title`: pin.title (optional, max 100 chars — truncate if needed)
   - `description`: pin.description (optional, max 800 chars)
   - `alt_text`: pin.alt_text (optional, max 500 chars)
   - `link`: pin.blog_articles.url
   - `media_source`: `{ source_type: 'image_url', url: imagePublicUrl }`
7. Call `createPinterestPin(accessToken, payload)` from pinterest-api.ts
8. On success: update pin with `{ status: 'published', published_at: new Date().toISOString(), pinterest_pin_id: result.id, pinterest_pin_url: 'https://www.pinterest.com/pin/' + result.id + '/' }`
9. On error: update pin with `{ status: 'error', error_message: errorMessage }`
10. Return `{ success: boolean, pinterest_pin_id?: string, error?: string }`

**`publishPinFn`** (method: 'POST', input: `{ pin_id: string }`):
- Authenticate user via getSupabaseServerClient
- Verify pin belongs to user's tenant
- Call `publishSinglePin(supabase, serviceClient, pin_id)`
- Return result

**`publishPinsBulkFn`** (method: 'POST', input: `{ pin_ids: string[] }`):
- Authenticate user
- Process pins sequentially (per existing pattern — avoid rate limits)
- Add 10-second delay between each pin (conservative rate limiting per research recommendation)
- Collect results: `{ total, published, failed, results: Array<{ id, success, error? }> }`
- Return summary

Both functions use `getSupabaseServerClient()` for authenticated operations and `getSupabaseServiceClient()` for Vault access.

Export: `publishPinFn`, `publishPinsBulkFn`, and `publishSinglePin` (the helper is exported for use by Inngest cron).
  </action>
  <verify>`npm run build` succeeds. Verify all three exports. Check that Pinterest API payload includes all fields per user decision (image, title, description, link, board, alt_text).</verify>
  <done>publishPinFn and publishPinsBulkFn server functions handle manual publishing with proper validation, Vault token retrieval, Pinterest API calls, status updates, and error handling. publishSinglePin helper exported for Inngest reuse.</done>
</task>

<task type="auto">
  <name>Task 2: Inngest cron jobs for auto-publishing and token refresh</name>
  <files>server/inngest/functions/publish-scheduled-pins.ts, server/inngest/functions/refresh-pinterest-tokens.ts, server/inngest/index.ts</files>
  <action>
**Create `server/inngest/functions/publish-scheduled-pins.ts`:**

Inngest cron function that runs every 15 minutes, finds pins due for publishing, and publishes them.

```typescript
import { inngest } from '../client'
import { createClient } from '@supabase/supabase-js'
import { createPinterestPin } from '../../../src/lib/server/pinterest-api'
import type { PinterestCreatePinPayload } from '../../../src/types/pinterest'
```

Function: `inngest.createFunction({ id: 'publish-scheduled-pins', retries: 0 }, { cron: 'TZ=UTC */15 * * * *' }, handler)`

Handler logic:
1. Create service-role Supabase client (SUPABASE_URL + SUPABASE_SECRET_KEY env vars)
2. Find pins due for publishing:
   - Status is 'ready_to_schedule' (per existing workflow)
   - Has `scheduled_at` that is <= now
   - Has blog_project with active pinterest_connection
   - Select with joins: `*, blog_articles(url), boards(pinterest_board_id), blog_projects(pinterest_connection_id)`
3. If no pins found, return `{ published: 0, message: 'No pins to publish' }`
4. Group pins by `blog_projects.pinterest_connection_id` for batch token retrieval
5. For each connection group:
   - Retrieve access token from Vault: `serviceClient.rpc('get_pinterest_access_token', { p_connection_id })`
   - If token retrieval fails, mark all pins in group as error status
   - Process pins sequentially with 10-second delay between each:
     - Use `step.run()` for each pin (Inngest durable execution)
     - Set status to 'publishing'
     - Build payload (same as publishSinglePin logic)
     - Call `createPinterestPin(accessToken, payload)`
     - On success: update pin with published status, pinterest_pin_id, pinterest_pin_url
     - On 429 (rate limited): respect Retry-After header, wait and retry up to 3 times
     - On 401 (auth failed): mark connection as inactive, set pin to error
     - On other error: set pin to error with error_message
6. Return summary: `{ total, published, failed, details }`

**Create `server/inngest/functions/refresh-pinterest-tokens.ts`:**

Inngest cron function that runs daily at 2 AM UTC, refreshes tokens expiring within 7 days.

```typescript
import { inngest } from '../client'
import { createClient } from '@supabase/supabase-js'
import { refreshPinterestToken } from '../../../src/lib/server/pinterest-api'
```

Function: `inngest.createFunction({ id: 'refresh-pinterest-tokens', retries: 3 }, { cron: 'TZ=UTC 0 2 * * *' }, handler)`

Handler logic:
1. Create service-role Supabase client
2. Find connections with `token_expires_at < now + 7 days` AND `is_active = true`
3. If none found, return `{ refreshed: 0, message: 'No tokens need refreshing' }`
4. For each connection (use `step.run()` per connection):
   - Get refresh token from Vault: `serviceClient.rpc('get_pinterest_refresh_token', { p_connection_id })`
   - Call `refreshPinterestToken(refreshToken)` from pinterest-api.ts
   - On success: store new tokens via `store_pinterest_tokens` RPC, update `token_expires_at` on connection
   - On failure: mark connection `is_active = false`, set `last_error = 'Token refresh failed: {error}'`
5. Return summary: `{ total, refreshed, failed, details }`

**Update `server/inngest/index.ts`:**

Add imports and register both new functions:

```typescript
import { publishScheduledPins } from './functions/publish-scheduled-pins'
import { refreshPinterestTokens } from './functions/refresh-pinterest-tokens'

export const functions = [
  scrapeBlog,
  scrapeSingle,
  generateMetadataBulk,
  publishScheduledPins,
  refreshPinterestTokens
]
```

Also add the corresponding named exports.

Note on imports: Inngest functions run in the server/Express context. The imports from `../../../src/lib/server/pinterest-api` should work since these are pure TypeScript functions with no client-side dependencies. If path resolution issues arise, consider creating a shared barrel export. The existing `generate-metadata.ts` Inngest function already imports from `src/` paths — follow the same pattern.
  </action>
  <verify>`npm run build` succeeds. Verify `server/inngest/index.ts` exports 5 functions total. Check that cron expressions are valid (every 15 min and daily 2 AM UTC).</verify>
  <done>Auto-publish cron runs every 15 minutes, publishes due pins with rate limit handling. Token refresh cron runs daily, proactively refreshes expiring tokens. Both registered in Inngest functions array. Failed tokens mark connections inactive, failed publishes set pin to error status.</done>
</task>

</tasks>

<verification>
- `src/lib/server/pinterest-publishing.ts` exports publishPinFn, publishPinsBulkFn, publishSinglePin
- `server/inngest/functions/publish-scheduled-pins.ts` exports publishScheduledPins with 15-min cron
- `server/inngest/functions/refresh-pinterest-tokens.ts` exports refreshPinterestTokens with daily cron
- `server/inngest/index.ts` registers all 5 functions
- Pin publishing sends all required fields per user decision: image, title, description, link, board, alt_text
- Publish failure sets pin to 'error' with error_message (no auto-retry per user decision)
- Success stores pinterest_pin_id AND pinterest_pin_url per user decision
- Build passes
</verification>

<success_criteria>
Manual publishing works via server function (single pin and bulk). Auto-publishing via Inngest cron finds scheduled pins and publishes them every 15 minutes. Token refresh cron keeps connections healthy by refreshing tokens 7 days before expiry. All publish operations send complete pin data including alt_text. Failures are handled gracefully with error status and messages.
</success_criteria>

<output>
After completion, create `.planning/phases/08-pinterest-oauth-authentication-for-multi-account-publishing/08-04-SUMMARY.md`
</output>
