---
phase: 08-pinterest-oauth
plan: 05
type: execute
wave: 5
depends_on: ["08-04"]
files_modified:
  - src/lib/hooks/use-pinterest-publishing.ts
  - src/components/pins/publish-pin-button.tsx
  - src/routes/_authed/pins/$pinId.tsx
  - src/components/pins/pins-list.tsx
  - src/components/calendar/pin-sidebar.tsx
autonomous: false
user_setup:
  - service: pinterest
    why: "OAuth application for Pinterest API access"
    env_vars:
      - name: PINTEREST_APP_ID
        source: "Pinterest Developer Portal -> My Apps -> App ID"
      - name: PINTEREST_APP_SECRET
        source: "Pinterest Developer Portal -> My Apps -> App Secret"
      - name: PINTEREST_REDIRECT_URI
        source: "Set to http://localhost:3000/auth/pinterest/callback for dev, production URL for prod. Must match exactly in Pinterest Developer Portal -> My Apps -> Redirect URIs"
    dashboard_config:
      - task: "Create a Pinterest App (or use existing)"
        location: "https://developers.pinterest.com/apps/"
      - task: "Add redirect URI matching PINTEREST_REDIRECT_URI"
        location: "Pinterest Developer Portal -> My Apps -> Edit -> Redirect URIs"
      - task: "Request access to boards:read, boards:write, pins:read, pins:write scopes"
        location: "Pinterest Developer Portal -> My Apps -> Permissions"

must_haves:
  truths:
    - "User can click 'Publish' on a single pin from pin detail page"
    - "User can click 'Publish' on a single pin from calendar sidebar"
    - "User can bulk publish selected pins from pins list"
    - "Publishing shows loading state and updates pin status"
    - "Published pins show Pinterest URL link"
    - "Pin status workflow includes 'publishing' as visible system state"
  artifacts:
    - path: "src/lib/hooks/use-pinterest-publishing.ts"
      provides: "TanStack Query hooks for publish operations"
      exports: ["usePublishPin", "usePublishPinsBulk"]
    - path: "src/components/pins/publish-pin-button.tsx"
      provides: "Reusable publish button component"
      exports: ["PublishPinButton"]
  key_links:
    - from: "src/lib/hooks/use-pinterest-publishing.ts"
      to: "src/lib/server/pinterest-publishing.ts"
      via: "publishPinFn and publishPinsBulkFn calls"
      pattern: "import.*publishPinFn|publishPinsBulkFn"
    - from: "src/components/pins/publish-pin-button.tsx"
      to: "src/lib/hooks/use-pinterest-publishing.ts"
      via: "usePublishPin hook"
      pattern: "usePublishPin"
    - from: "src/routes/_authed/pins/$pinId.tsx"
      to: "src/components/pins/publish-pin-button.tsx"
      via: "component import"
      pattern: "import.*PublishPinButton"
---

<objective>
Wire pin publishing into the UI across all pin interaction surfaces (detail page, calendar sidebar, pins list).

Purpose: This is the final user-facing integration. Users need to manually publish pins and see their published status with Pinterest URLs. Bulk publishing from the pins list enables efficient batch operations.

Output: Publishing hooks, reusable publish button component, integration into pin detail page, calendar sidebar, and pins list bulk actions. End-to-end checkpoint to verify the complete OAuth -> connect -> sync -> publish flow.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-pinterest-oauth-authentication-for-multi-account-publishing/08-CONTEXT.md
@.planning/phases/08-pinterest-oauth-authentication-for-multi-account-publishing/08-04-SUMMARY.md
@src/routes/_authed/pins/$pinId.tsx
@src/components/pins/pins-list.tsx
@src/components/calendar/pin-sidebar.tsx
@src/lib/hooks/use-pins.ts
@src/types/pins.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Publishing hooks and reusable button component</name>
  <files>src/lib/hooks/use-pinterest-publishing.ts, src/components/pins/publish-pin-button.tsx</files>
  <action>
**Create `src/lib/hooks/use-pinterest-publishing.ts`:**

1. `usePublishPin()` — TanStack Query mutation:
   - mutationFn: accepts `{ pin_id: string }`, calls `publishPinFn({ data: { pin_id } })`
   - onSuccess: invalidate `['pins']` queries, toast.success("Pin published to Pinterest!")
   - onError: invalidate `['pins']` (status may have changed to error), toast.error(`Publish failed: ${error.message}`)

2. `usePublishPinsBulk()` — TanStack Query mutation:
   - mutationFn: accepts `{ pin_ids: string[] }`, calls `publishPinsBulkFn({ data: { pin_ids } })`
   - onSuccess: invalidate `['pins']`, toast.success(`Published ${result.published}/${result.total} pins`)
   - onError: invalidate `['pins']`, toast.error with message

Import toast from sonner.

**Create `src/components/pins/publish-pin-button.tsx`:**

Reusable button that publishes a single pin. Props:
- `pinId: string`
- `pinStatus: PinStatus`
- `hasPinterestConnection: boolean` — whether the pin's project has a Pinterest connection
- `hasPinterestBoard: boolean` — whether the pin has a board with pinterest_board_id
- `pinterestPinUrl?: string | null` — URL of the published pin on Pinterest
- `variant?: 'default' | 'outline' | 'ghost'` (default: 'outline')
- `size?: 'default' | 'sm'` (default: 'sm')

**Render logic:**
- If pin status is 'published': show "Published" badge (emerald) with external link icon. If pinterestPinUrl exists, make it a link to that URL (opens in new tab).
- If pin status is 'publishing': show disabled button with spinner "Publishing..."
- If pin status is 'error': show "Retry Publish" button (red outline)
- If `!hasPinterestConnection`: show disabled button with tooltip "Connect Pinterest in project settings"
- If `!hasPinterestBoard`: show disabled button with tooltip "Assign a Pinterest board first"
- Otherwise (pin is ready): show "Publish" button (primary). On click, call `usePublishPin` mutation.

Use Lucide icons: ExternalLink for published link, Send for publish action, Loader2 for spinner.
  </action>
  <verify>`npm run build` succeeds. Verify hooks and component are exported correctly.</verify>
  <done>usePublishPin and usePublishPinsBulk hooks handle publish mutations with cache invalidation and toasts. PublishPinButton component handles all pin states (published, publishing, error, ready, no connection, no board).</done>
</task>

<task type="auto">
  <name>Task 2: Integrate publishing into pin detail, sidebar, and list</name>
  <files>src/routes/_authed/pins/$pinId.tsx, src/components/pins/pins-list.tsx, src/components/calendar/pin-sidebar.tsx</files>
  <action>
**Update `src/routes/_authed/pins/$pinId.tsx` (Pin detail page):**

1. Import `PublishPinButton` from `@/components/pins/publish-pin-button`
2. Import `usePinterestConnection` from `@/lib/hooks/use-pinterest-connection`
3. In the pin detail component, fetch Pinterest connection status for the pin's blog_project_id: `const { data: connectionData } = usePinterestConnection(pin.blog_project_id)`
4. Determine `hasPinterestBoard`: `!!pin.board_id` AND the board has a pinterest_board_id. This requires looking up the board. Use the existing boards data if available, or add a simple check — if pin.board_id exists, assume it has a Pinterest board for now (the PublishPinButton will get a proper error from the server if not).
5. Add the PublishPinButton in the actions area (near the existing status display or action buttons section):
   ```tsx
   <PublishPinButton
     pinId={pin.id}
     pinStatus={pin.status}
     hasPinterestConnection={connectionData?.connected ?? false}
     hasPinterestBoard={!!pin.board_id}
     pinterestPinUrl={pin.pinterest_pin_url}
   />
   ```
6. If pin.pinterest_pin_url exists, show a link "View on Pinterest" with ExternalLink icon below the publish button or in the pin metadata section.

**Update `src/components/calendar/pin-sidebar.tsx` (Calendar sidebar):**

1. Import `PublishPinButton`
2. Import `usePinterestConnection`
3. In the sidebar, after the scheduling section or in the actions area, add the PublishPinButton with the same props pattern.
4. Fetch connection data using the pin's blog_project_id.

**Update `src/components/pins/pins-list.tsx` (Pins list bulk actions):**

1. Import `usePublishPinsBulk` from `@/lib/hooks/use-pinterest-publishing`
2. Add a "Publish" button to the bulk action bar (appears when pins are selected):
   - Button text: `Publish (${selectedIds.length})`
   - Variant: outline
   - Icon: Send from lucide-react
   - Only enabled when selected pins have boards assigned
   - On click: call `usePublishPinsBulk` mutation with selected pin IDs
   - On success: clear selection (follow existing pattern from bulk generate metadata)
3. Position the Publish button alongside existing bulk actions (Generate Metadata, Schedule, Delete).

**Update `src/types/pins.ts` if not already done in Plan 01:**
Ensure 'publishing' is in SYSTEM_MANAGED_STATUSES and PIN_STATUS constant. (This should already be done in 08-01, but verify and add if missing.)
  </action>
  <verify>`npm run build` succeeds. Navigate to pin detail page — verify PublishPinButton renders. Check calendar sidebar shows publish button. Check pins list has bulk publish in action bar.</verify>
  <done>Publish button appears on pin detail page, calendar sidebar, and pins list bulk actions. Published pins show Pinterest URL link. Publishing state shows loading indicator. All surfaces handle missing connection/board gracefully.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: End-to-end Pinterest integration verification</name>
  <what-built>Complete Pinterest OAuth integration: database schema, OAuth flow with PKCE, connection UX on project page, board syncing, manual and auto publishing, token refresh, publishing UI across all pin surfaces.</what-built>
  <how-to-verify>
    1. Add Pinterest environment variables to .env.local:
       - PINTEREST_APP_ID, PINTEREST_APP_SECRET, PINTEREST_REDIRECT_URI
    2. Run `npm run dev`
    3. Navigate to any blog project detail page
    4. Verify "Pinterest Connection" section appears showing "No Pinterest account connected"
    5. Click "Connect Pinterest" — should redirect to Pinterest OAuth consent screen
    6. Authorize the app on Pinterest — should redirect back to project page
    7. Verify success toast and connected account name (@username) displays
    8. Click "Sync Boards" — should show loading, then toast with board count
    9. Navigate to a pin detail page for this project
    10. Verify "Publish" button appears (or explains why disabled)
    11. If pin has board + image + metadata, click "Publish" — verify it publishes to Pinterest
    12. Check pin now shows "Published" status and "View on Pinterest" link
    13. Verify the Pinterest link opens the actual pin on pinterest.com
    14. Go back to project settings, click "Disconnect" — verify confirmation dialog
    15. Confirm disconnect — verify connection removed
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- PublishPinButton renders correctly on pin detail, sidebar, and list
- Published pins show Pinterest URL as clickable link
- Bulk publish works from pins list with selection
- 'publishing' status shows amber badge
- All publishing surfaces handle missing connection gracefully
- Build passes
</verification>

<success_criteria>
End-to-end Pinterest integration works: connect account via OAuth, sync boards, publish pins (manually and via cron), view published pins on Pinterest. All UI surfaces support publishing. Token refresh keeps connections alive. Complete Phase 8 value delivered.
</success_criteria>

<output>
After completion, create `.planning/phases/08-pinterest-oauth-authentication-for-multi-account-publishing/08-05-SUMMARY.md`
</output>
