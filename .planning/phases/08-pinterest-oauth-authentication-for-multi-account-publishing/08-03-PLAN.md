---
phase: 08-pinterest-oauth
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - src/components/projects/pinterest-connection.tsx
  - src/lib/hooks/use-pinterest-connection.ts
  - src/routes/_authed/projects/$id.tsx
  - src/lib/server/pinterest-boards.ts
autonomous: true

must_haves:
  truths:
    - "User can see Pinterest connection status on project detail page"
    - "User can click 'Connect Pinterest' to start OAuth flow"
    - "Connected account name shows inline after successful OAuth"
    - "User can disconnect Pinterest with confirmation dialog"
    - "User can click 'Sync Boards' to refresh boards from Pinterest API"
    - "Board sync replaces existing boards (not merge) per user decision"
  artifacts:
    - path: "src/components/projects/pinterest-connection.tsx"
      provides: "Pinterest connection UI component for project settings"
      exports: ["PinterestConnection"]
    - path: "src/lib/hooks/use-pinterest-connection.ts"
      provides: "TanStack Query hooks for Pinterest connection state"
      exports: ["usePinterestConnection", "useConnectPinterest", "useDisconnectPinterest", "useSyncBoards"]
    - path: "src/lib/server/pinterest-boards.ts"
      provides: "Server function for board syncing"
      exports: ["syncPinterestBoardsFn"]
  key_links:
    - from: "src/components/projects/pinterest-connection.tsx"
      to: "src/lib/hooks/use-pinterest-connection.ts"
      via: "hook calls"
      pattern: "usePinterestConnection|useConnectPinterest|useDisconnectPinterest|useSyncBoards"
    - from: "src/lib/hooks/use-pinterest-connection.ts"
      to: "src/lib/server/pinterest-oauth.ts"
      via: "server function calls"
      pattern: "initPinterestOAuthFn|disconnectPinterestFn|getPinterestConnectionFn"
    - from: "src/lib/server/pinterest-boards.ts"
      to: "src/lib/server/pinterest-api.ts"
      via: "fetchPinterestBoards import"
      pattern: "import.*fetchPinterestBoards"
    - from: "src/routes/_authed/projects/$id.tsx"
      to: "src/components/projects/pinterest-connection.tsx"
      via: "component import"
      pattern: "import.*PinterestConnection"
---

<objective>
Add Pinterest connection UI to the project detail page and implement board syncing from Pinterest API.

Purpose: Per user decision, Pinterest is connected per-project (not globally). Users need to see connection status, initiate OAuth, disconnect, and sync boards — all from the project settings area. Board syncing replaces existing boards (clean slate per user decision) so the board dropdown always reflects Pinterest's current state.

Output: Pinterest connection component on project detail page, TanStack Query hooks for connection management, board sync server function, and integration into existing project page.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-pinterest-oauth-authentication-for-multi-account-publishing/08-CONTEXT.md
@.planning/phases/08-pinterest-oauth-authentication-for-multi-account-publishing/08-02-SUMMARY.md
@src/routes/_authed/projects/$id.tsx
@src/lib/hooks/use-pins.ts
@src/lib/api/pins.ts
@src/lib/server/pinterest-oauth.ts
@src/lib/server/pinterest-api.ts
@src/types/pinterest.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Board sync server function</name>
  <files>src/lib/server/pinterest-boards.ts</files>
  <action>
Create `src/lib/server/pinterest-boards.ts` with a server function for syncing boards from Pinterest API.

**`syncPinterestBoardsFn`** (method: 'POST', input: `{ blog_project_id: string }`):
- Authenticate user via `getSupabaseServerClient()` + `supabase.auth.getUser()`
- Get tenant_id from profiles
- Fetch blog_project, verify tenant ownership, get pinterest_connection_id
- If no pinterest_connection_id, throw error "No Pinterest account connected"
- Get access token from Vault using service client: `supabase.rpc('get_pinterest_access_token', { p_connection_id })`
- If token retrieval fails or returns null, throw error "Could not retrieve access token"
- Call `fetchPinterestBoards(accessToken)` from pinterest-api.ts to get all boards (paginated)
- **Replace boards** (per user decision — clean slate, not merge):
  1. Delete ALL existing boards for this blog_project_id using authenticated client (RLS-safe)
  2. Insert new boards from Pinterest response, mapping each to: `{ tenant_id, blog_project_id, name: board.name, pinterest_board_id: board.id, cover_image_url: board.media?.image_cover_url || null }`
- Return `{ success: true, synced_count: allBoards.length }`
- On error: return `{ success: false, error: message }`

Note: Use `getSupabaseServiceClient()` for Vault access (RPC call). Use authenticated client for blog_project ownership check and board delete/insert (RLS enforced).

Actually, since delete+insert of boards needs to work reliably and the authenticated user has proper RLS policies for boards, use the authenticated client for the board operations. Use service client only for Vault RPC.
  </action>
  <verify>`npm run build` succeeds. Verify the function is exported.</verify>
  <done>syncPinterestBoardsFn exported, fetches boards from Pinterest API, replaces all project boards with fresh data, uses Vault for token retrieval.</done>
</task>

<task type="auto">
  <name>Task 2: Pinterest connection hooks and UI component</name>
  <files>src/lib/hooks/use-pinterest-connection.ts, src/components/projects/pinterest-connection.tsx</files>
  <action>
**Create `src/lib/hooks/use-pinterest-connection.ts`:**

1. `usePinterestConnection(blogProjectId: string)` — TanStack Query hook wrapping `getPinterestConnectionFn`:
   - queryKey: `['pinterest-connection', blogProjectId]`
   - queryFn: calls `getPinterestConnectionFn({ data: { blog_project_id: blogProjectId } })`
   - staleTime: 30_000 (30s, matches project default)

2. `useConnectPinterest()` — TanStack Query mutation:
   - mutationFn: calls `initPinterestOAuthFn({ data: { blog_project_id } })`
   - onSuccess: `window.location.href = result.authUrl` (full page redirect to Pinterest)
   - onError: toast.error with message

3. `useDisconnectPinterest()` — TanStack Query mutation:
   - mutationFn: calls `disconnectPinterestFn({ data: { blog_project_id } })`
   - onSuccess: invalidate `['pinterest-connection', blogProjectId]` and `['boards']`, toast.success("Pinterest disconnected")
   - onError: toast.error with message

4. `useSyncBoards()` — TanStack Query mutation:
   - mutationFn: calls `syncPinterestBoardsFn({ data: { blog_project_id } })`
   - onSuccess: invalidate `['boards']` and `['pinterest-connection', blogProjectId]`, toast.success(`Synced ${result.synced_count} boards`)
   - onError: toast.error with message

Import toast from sonner. Import server functions from their respective modules.

**Create `src/components/projects/pinterest-connection.tsx`:**

A section component that displays Pinterest connection status and provides connect/disconnect/sync actions. Receives `blogProjectId: string` as prop.

**Layout:** A Card (or bordered section) with title "Pinterest Connection" and the following states:

**State 1: Not connected:**
- Text: "No Pinterest account connected"
- Button: "Connect Pinterest" (primary) — calls useConnectPinterest mutation
- If URL has `pinterest_error` search param: show inline error Alert with "Connection failed: {error}" and "Try again" link (re-trigger connect)

**State 2: Connected + active:**
- Text: "Connected as @{pinterest_username}" with green dot indicator
- Token expiry: "Token expires: {formatted date}" in muted text
- Buttons row:
  - "Sync Boards" (outline) — calls useSyncBoards mutation, shows loading spinner while syncing
  - "Disconnect" (destructive outline) — opens confirmation Dialog

**State 3: Connected but inactive (is_active=false):**
- Warning Alert: "Connection needs attention: {last_error}"
- Button: "Reconnect" — initiates new OAuth flow (same as connect)
- Button: "Disconnect" — same as above

**Disconnect confirmation dialog:**
- Dialog with title "Disconnect Pinterest?"
- Body: "This will disconnect @{username} from this project. Scheduled pins will no longer auto-publish. Are you sure?"
- Actions: "Cancel" (outline) and "Disconnect" (destructive)

**After OAuth redirect (pinterest_connected=true in URL):**
- Show success toast: "Pinterest connected successfully!" (use useEffect to check search params on mount, show toast once, then clean URL params)

Handle loading state: show skeleton/spinner while usePinterestConnection query loads.

Use shadcn components: Card (or just a bordered div), Button, Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter, Alert, AlertDescription.

Use Lucide icons: Link, LinkOff (or Unplug), RefreshCw for sync.
  </action>
  <verify>`npm run build` succeeds. Verify component renders correctly with mock/empty data. Check all hooks are exported.</verify>
  <done>PinterestConnection component shows connection status with connect/disconnect/sync actions. Hooks handle all Pinterest connection mutations with proper cache invalidation and toast feedback.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate Pinterest connection into project detail page</name>
  <files>src/routes/_authed/projects/$id.tsx</files>
  <action>
Update `src/routes/_authed/projects/$id.tsx` to include the Pinterest connection section.

1. Import `PinterestConnection` from `@/components/projects/pinterest-connection`

2. Add the Pinterest connection section between the "Action buttons" div and the "Articles section" div. Use a clear section divider:

```tsx
{/* Pinterest Connection */}
<div className="mb-8">
  <PinterestConnection blogProjectId={id} />
</div>
```

3. Update `validateSearch` on the Route to accept Pinterest-related URL params:
- Add `pinterest_connected` and `pinterest_error` to the search validation
- These are read by the PinterestConnection component for post-OAuth feedback

```typescript
export const Route = createFileRoute('/_authed/projects/$id')({
  validateSearch: (search: Record<string, unknown>) => ({
    pinterest_connected: (search.pinterest_connected as string) || undefined,
    pinterest_error: (search.pinterest_error as string) || undefined,
  }),
  component: ProjectDetail,
})
```

4. Pass search params to PinterestConnection if it needs them, OR let PinterestConnection read them via `Route.useSearch()` internally (simpler). Since PinterestConnection is rendered within the Route context, it can use `useSearch` from the route — but that creates coupling. Better approach: pass as props:

```tsx
<PinterestConnection
  blogProjectId={id}
  pinterestConnected={search.pinterest_connected === 'true'}
  pinterestError={search.pinterest_error}
/>
```

Where `const search = Route.useSearch()` is called in ProjectDetail.
  </action>
  <verify>`npm run build` succeeds. Navigate to a project detail page and verify the Pinterest connection section renders (shows "No Pinterest account connected" for projects without a connection).</verify>
  <done>Project detail page shows Pinterest connection section with connect/disconnect/sync capability between action buttons and articles section.</done>
</task>

</tasks>

<verification>
- Project detail page shows Pinterest connection section
- "Connect Pinterest" button visible for unconnected projects
- Connected state shows username, sync button, disconnect button
- Board sync replaces boards (not merges)
- All hooks properly invalidate caches
- Build passes
</verification>

<success_criteria>
Users can see Pinterest connection status on any project page. Connect initiates OAuth flow. After successful OAuth return, connected account name is displayed inline. Disconnect removes the connection with confirmation. Sync Boards button fetches fresh boards from Pinterest and replaces existing ones. All per user decisions in CONTEXT.md.
</success_criteria>

<output>
After completion, create `.planning/phases/08-pinterest-oauth-authentication-for-multi-account-publishing/08-03-SUMMARY.md`
</output>
