---
phase: 08-pinterest-oauth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00009_pinterest_oauth.sql
  - src/lib/server/pinterest-api.ts
  - src/types/pinterest.ts
autonomous: true

must_haves:
  truths:
    - "pinterest_connections table exists with encrypted token storage via Vault"
    - "oauth_state_mapping table exists for CSRF/PKCE state management"
    - "pins table has pinterest_pin_url column for storing published pin URLs"
    - "Pinterest API v5 client can make authenticated requests"
  artifacts:
    - path: "supabase/migrations/00009_pinterest_oauth.sql"
      provides: "pinterest_connections, oauth_state_mapping tables, Vault setup, pins column additions"
      contains: "CREATE TABLE"
    - path: "src/lib/server/pinterest-api.ts"
      provides: "Pinterest API v5 client with auth, board listing, pin creation"
      exports: ["pinterestFetch", "fetchPinterestBoards", "createPinterestPin", "refreshPinterestToken", "exchangePinterestCode"]
    - path: "src/types/pinterest.ts"
      provides: "TypeScript types for Pinterest connections, boards, OAuth"
      exports: ["PinterestConnection", "PinterestBoard", "PinterestPin", "OAuthState"]
  key_links:
    - from: "src/lib/server/pinterest-api.ts"
      to: "https://api.pinterest.com/v5/"
      via: "fetch with Bearer token"
      pattern: "Authorization.*Bearer"
---

<objective>
Create the database foundation for Pinterest OAuth integration and a reusable Pinterest API v5 client.

Purpose: All subsequent plans (OAuth flow, board syncing, publishing) depend on the database schema for storing connections/tokens and the API client for communicating with Pinterest. This foundation must exist before any Pinterest functionality can be built.

Output: Database migration with pinterest_connections + oauth_state_mapping tables, Supabase Vault for encrypted token storage, pinterest_pin_url column on pins, and a Pinterest API v5 client utility with authenticated fetch, board listing, pin creation, and token refresh/exchange functions.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-pinterest-oauth-authentication-for-multi-account-publishing/08-CONTEXT.md
@.planning/phases/08-pinterest-oauth-authentication-for-multi-account-publishing/08-RESEARCH.md
@supabase/migrations/00005_pins_and_boards.sql
@supabase/migrations/00007_english_pin_statuses.sql
@src/types/pins.ts
@src/lib/server/supabase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for Pinterest OAuth</name>
  <files>supabase/migrations/00009_pinterest_oauth.sql</files>
  <action>
Create migration `00009_pinterest_oauth.sql` with the following:

**1. Enable Supabase Vault extension:**
```sql
CREATE EXTENSION IF NOT EXISTS supabase_vault;
```

**2. Create `pinterest_connections` table:**
- `id` UUID PRIMARY KEY DEFAULT gen_random_uuid()
- `tenant_id` UUID NOT NULL
- `pinterest_user_id` TEXT NOT NULL — Pinterest account identifier
- `pinterest_username` TEXT — Display name for connected account
- `scope` TEXT — Granted OAuth scopes
- `token_expires_at` TIMESTAMPTZ NOT NULL — When access token expires
- `is_active` BOOLEAN NOT NULL DEFAULT true — False when token refresh fails
- `last_error` TEXT — Last error message (null when healthy)
- `created_at` TIMESTAMPTZ NOT NULL DEFAULT NOW()
- `updated_at` TIMESTAMPTZ NOT NULL DEFAULT NOW()

Add unique constraint on `(tenant_id, pinterest_user_id)` to prevent duplicate connections to the same Pinterest account within a tenant.

Enable RLS. Add policies matching existing pattern (authenticated users, tenant_id IN profiles check). Also add service_role bypass policies for Inngest background jobs:
```sql
CREATE POLICY "Service role full access pinterest_connections"
  ON public.pinterest_connections FOR ALL TO service_role USING (true) WITH CHECK (true);
```

Add updated_at trigger using existing `handle_updated_at()` function.
Add index on `tenant_id`.

**3. Create `oauth_state_mapping` table** (short-lived, for CSRF/PKCE state):
- `id` UUID PRIMARY KEY DEFAULT gen_random_uuid()
- `state` TEXT NOT NULL UNIQUE — Random state parameter
- `code_verifier` TEXT NOT NULL — PKCE code verifier
- `blog_project_id` UUID NOT NULL REFERENCES blog_projects(id) ON DELETE CASCADE
- `tenant_id` UUID NOT NULL
- `user_id` UUID NOT NULL — auth.uid() of initiator
- `created_at` TIMESTAMPTZ NOT NULL DEFAULT NOW()
- `expires_at` TIMESTAMPTZ NOT NULL DEFAULT (NOW() + INTERVAL '10 minutes')

Enable RLS. Add policy for authenticated users (user_id = auth.uid()). Add service_role bypass.
Add index on `state` for fast lookup during callback.

**4. Add `pinterest_connection_id` to `blog_projects` table:**
```sql
ALTER TABLE public.blog_projects
  ADD COLUMN IF NOT EXISTS pinterest_connection_id UUID REFERENCES public.pinterest_connections(id) ON DELETE SET NULL;
```

**5. Add `pinterest_pin_url` to `pins` table:**
```sql
ALTER TABLE public.pins
  ADD COLUMN IF NOT EXISTS pinterest_pin_url TEXT;
```

**6. Update pins status CHECK constraint** to add 'publishing' status (for in-progress publish):
- Drop existing `pins_status_check` constraint
- Re-add with 'publishing' added to allowed values
- Drop and re-add `pins_previous_status_check` similarly

**7. Create Vault helper RPC functions** (SECURITY DEFINER to access vault from authenticated context):

`store_pinterest_tokens(p_connection_id UUID, p_access_token TEXT, p_refresh_token TEXT)`:
- Delete any existing secrets for this connection_id
- Insert access token: `INSERT INTO vault.secrets (name, secret) VALUES ('pinterest_access_token_' || p_connection_id, p_access_token)`
- Insert refresh token: `INSERT INTO vault.secrets (name, secret) VALUES ('pinterest_refresh_token_' || p_connection_id, p_refresh_token)`

`get_pinterest_access_token(p_connection_id UUID) RETURNS TEXT`:
- `SELECT decrypted_secret FROM vault.decrypted_secrets WHERE name = 'pinterest_access_token_' || p_connection_id`

`get_pinterest_refresh_token(p_connection_id UUID) RETURNS TEXT`:
- `SELECT decrypted_secret FROM vault.decrypted_secrets WHERE name = 'pinterest_refresh_token_' || p_connection_id`

`delete_pinterest_tokens(p_connection_id UUID)`:
- Delete both secrets by name pattern

All four functions should be `SECURITY DEFINER` with `SET search_path = public`.

**8. Add service_role bypass policies to pins and boards tables** for Inngest background publishing:
```sql
CREATE POLICY "Service role full access pins" ON public.pins FOR ALL TO service_role USING (true) WITH CHECK (true);
CREATE POLICY "Service role full access boards" ON public.boards FOR ALL TO service_role USING (true) WITH CHECK (true);
```
  </action>
  <verify>Apply migration via Supabase MCP `apply_migration` or verify SQL syntax is valid by reviewing the file. Check that all tables, columns, policies, and functions are defined.</verify>
  <done>Migration file exists with pinterest_connections table, oauth_state_mapping table, blog_projects.pinterest_connection_id FK, pins.pinterest_pin_url column, 'publishing' status added, Vault RPC functions, and service_role policies.</done>
</task>

<task type="auto">
  <name>Task 2: Pinterest API v5 client and TypeScript types</name>
  <files>src/lib/server/pinterest-api.ts, src/types/pinterest.ts</files>
  <action>
**Create `src/types/pinterest.ts`:**

```typescript
export interface PinterestConnection {
  id: string
  tenant_id: string
  pinterest_user_id: string
  pinterest_username: string | null
  scope: string | null
  token_expires_at: string
  is_active: boolean
  last_error: string | null
  created_at: string
  updated_at: string
}

export interface OAuthState {
  id: string
  state: string
  code_verifier: string
  blog_project_id: string
  tenant_id: string
  user_id: string
  created_at: string
  expires_at: string
}

// Pinterest API v5 response types
export interface PinterestTokenResponse {
  access_token: string
  token_type: string
  expires_in: number // seconds (2592000 = 30 days)
  refresh_token: string
  scope: string
}

export interface PinterestUserResponse {
  username: string
  account_type: string
}

export interface PinterestBoardResponse {
  id: string
  name: string
  description: string
  privacy: 'PUBLIC' | 'PROTECTED' | 'SECRET'
  pin_count: number
  media?: { image_cover_url?: string }
}

export interface PinterestBoardsListResponse {
  items: PinterestBoardResponse[]
  bookmark?: string
}

export interface PinterestPinResponse {
  id: string
  board_id: string
  created_at: string
  link: string
  media: Record<string, unknown>
}

export interface PinterestCreatePinPayload {
  board_id: string
  title?: string
  description?: string
  alt_text?: string
  link?: string
  media_source: {
    source_type: 'image_url'
    url: string
  }
}
```

**Create `src/lib/server/pinterest-api.ts`:**

This is a server-only utility. All functions accept an access token parameter (never store tokens in module scope).

1. `PINTEREST_API_BASE = 'https://api.pinterest.com/v5'`

2. `async function pinterestFetch<T>(endpoint: string, accessToken: string, options?: RequestInit): Promise<T>` — Wrapper that adds Bearer auth header, handles JSON parsing, and throws on non-2xx responses with the Pinterest error message. Include `Content-Type: application/json` for non-GET requests.

3. `async function exchangePinterestCode(code: string, codeVerifier: string): Promise<PinterestTokenResponse>` — POST to `/v5/oauth/token` with HTTP Basic Auth header (`Buffer.from(PINTEREST_APP_ID:PINTEREST_APP_SECRET).toString('base64')`), body: `grant_type=authorization_code`, `code`, `redirect_uri` from env var, `code_verifier`. Content-Type: `application/x-www-form-urlencoded`. Returns parsed token response. Throws on error with Pinterest error message.

4. `async function refreshPinterestToken(refreshToken: string): Promise<PinterestTokenResponse>` — POST to `/v5/oauth/token` with HTTP Basic Auth, body: `grant_type=refresh_token`, `refresh_token`. Returns new token pair.

5. `async function fetchPinterestUser(accessToken: string): Promise<PinterestUserResponse>` — GET `/v5/user_account`, returns username and account_type.

6. `async function fetchPinterestBoards(accessToken: string): Promise<PinterestBoardResponse[]>` — Paginated GET `/v5/boards` with `page_size=100` and bookmark pagination. Collects all boards across pages and returns flat array.

7. `async function createPinterestPin(accessToken: string, payload: PinterestCreatePinPayload): Promise<PinterestPinResponse>` — POST `/v5/pins` with JSON body. Returns created pin with id. Handle rate limiting (429) by reading `Retry-After` header and retrying up to 3 times with exponential backoff + jitter.

8. Helper `generateCodeVerifier(): string` — crypto.randomBytes(64).toString('base64url')

9. Helper `generateCodeChallenge(verifier: string): Promise<string>` — SHA-256 hash of verifier, base64url encoded

10. Helper `generateState(): string` — crypto.randomBytes(32).toString('base64url')

Export all functions. Use `process.env.PINTEREST_APP_ID` and `process.env.PINTEREST_APP_SECRET` (read at call time, not module scope). Use `process.env.PINTEREST_REDIRECT_URI` for redirect URI.

Add the 'publishing' status to `src/types/pins.ts` PIN_STATUS constant:
```typescript
publishing: { label: 'Wird veroffentlicht', color: 'amber' },
```
Add 'publishing' to SYSTEM_MANAGED_STATUSES array. Add 'amber' to the colorMap in `getStatusBadgeClasses`.
  </action>
  <verify>`npm run build` succeeds (TypeScript compilation). Verify types are exported correctly and pinterest-api.ts has no import errors.</verify>
  <done>Pinterest types defined, API client with all 7+ functions exported, pins.ts updated with 'publishing' status, build passes.</done>
</task>

</tasks>

<verification>
- Migration file `00009_pinterest_oauth.sql` exists and contains all required DDL
- `src/types/pinterest.ts` exports all Pinterest-related types
- `src/lib/server/pinterest-api.ts` exports all API client functions
- `src/types/pins.ts` includes 'publishing' status with amber color
- `npm run build` passes
</verification>

<success_criteria>
Database schema ready for Pinterest OAuth (connections, state mapping, Vault, pins columns). Pinterest API v5 client ready for use by OAuth flow, board syncing, and publishing plans. Pin status workflow extended with 'publishing' state.
</success_criteria>

<output>
After completion, create `.planning/phases/08-pinterest-oauth-authentication-for-multi-account-publishing/08-01-SUMMARY.md`
</output>
