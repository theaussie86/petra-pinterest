---
phase: 01-foundation-security
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - src/lib/supabase.ts
  - src/server/auth.ts
  - src/routes/__root.tsx
  - src/routes/login.tsx
  - src/routes/auth.callback.tsx
  - src/components/ui/button.tsx
  - src/components/ui/sonner.tsx
  - src/lib/utils.ts
autonomous: true

must_haves:
  truths:
    - "User can click 'Sign in with Google' and be redirected to Google OAuth"
    - "After Google auth, user is redirected back to the app"
    - "User session persists across browser refresh"
    - "OAuth errors show as toast notifications"
  artifacts:
    - path: "src/lib/supabase.ts"
      provides: "Supabase client configuration"
      exports: ["supabase", "getSupabaseServerClient"]
    - path: "src/server/auth.ts"
      provides: "Auth server functions"
      exports: ["signInWithGoogle", "signOut", "getUser"]
    - path: "src/routes/login.tsx"
      provides: "Login page with Google OAuth button"
      exports: ["Route"]
    - path: "src/routes/auth.callback.tsx"
      provides: "OAuth callback handler"
      exports: ["Route"]
  key_links:
    - from: "src/routes/login.tsx"
      to: "src/server/auth.ts"
      via: "signInWithGoogle function call"
      pattern: "signInWithGoogle"
    - from: "src/routes/auth.callback.tsx"
      to: "src/lib/supabase.ts"
      via: "supabase.auth.exchangeCodeForSession"
      pattern: "exchangeCodeForSession"
    - from: "src/routes/__root.tsx"
      to: "src/server/auth.ts"
      via: "getUser in beforeLoad"
      pattern: "getUser"
---

<objective>
Implement Google OAuth authentication using Supabase Auth with TanStack Start server functions.

Purpose: Enable users to securely sign in with their Google account, establishing the foundation for multi-tenant data access. This is requirement AUTH-01.

Output: Working Google OAuth flow with login page, callback handler, and session management.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation-security/01-CONTEXT.md
@.planning/phases/01-foundation-security/01-01-SUMMARY.md
@.planning/phases/01-foundation-security/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase client and auth server functions</name>
  <files>src/lib/supabase.ts, src/lib/utils.ts, src/server/auth.ts</files>
  <action>
Set up Supabase client and authentication server functions:

1. Create src/lib/utils.ts:
   - Import clsx and twMerge
   - Export cn() utility for combining Tailwind classes

2. Create src/lib/supabase.ts:
   - Import createClient from @supabase/supabase-js
   - Create browser client using import.meta.env.VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY
   - Export supabase client for browser use
   - Export getSupabaseServerClient() function that returns the same client (for server functions)
   - Add TypeScript types for Database (placeholder, will generate later)

3. Create src/server/auth.ts with server functions:

   a) signInWithGoogle server function:
      - createServerFn({ method: 'POST' })
      - Get origin from request headers for redirect URL
      - Call supabase.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: origin + '/auth/callback' } })
      - Return the auth URL for client to redirect

   b) signOut server function:
      - createServerFn({ method: 'POST' })
      - Call supabase.auth.signOut()
      - Use redirect() to send to '/'

   c) getUser server function:
      - createServerFn({ method: 'GET' })
      - Call supabase.auth.getUser()
      - If no user, return null
      - Query profiles table for tenant_id and display_name
      - Return user object with email, id, tenantId, displayName, avatarUrl

IMPORTANT: Use (SELECT auth.uid()) pattern in any direct SQL for RLS performance.
  </action>
  <verify>
TypeScript compilation succeeds with `npx tsc --noEmit`.
Files exist at specified paths with correct exports.
  </verify>
  <done>
Supabase client configured, auth server functions created with proper types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create login page and OAuth callback route</name>
  <files>src/routes/login.tsx, src/routes/auth.callback.tsx, src/components/ui/button.tsx, src/components/ui/sonner.tsx</files>
  <action>
Create authentication routes and UI components:

1. Create src/components/ui/button.tsx:
   - Simple styled button component using Tailwind
   - Variants: default (primary), outline, ghost
   - Sizes: default, sm, lg
   - Use cn() for class merging

2. Create src/components/ui/sonner.tsx:
   - Import Toaster from sonner
   - Export configured Toaster with position="top-right"

3. Update src/routes/__root.tsx:
   - Import Toaster from components/ui/sonner
   - Add Toaster to RootDocument body
   - Import getUser from server/auth
   - Add beforeLoad that calls getUser() and returns { user }
   - Update RootDocument to show user info in header if logged in

4. Create src/routes/login.tsx:
   - createFileRoute('/login')
   - Minimal centered layout as per CONTEXT.md decisions
   - Logo placeholder (just text "Petra" for now) + app name
   - Single "Sign in with Google" button
   - On click: call signInWithGoogle(), then redirect to returned URL
   - Handle errors with toast.error()
   - If user already logged in (from route context), redirect to /dashboard
   - Style: centered vertically and horizontally, clean minimal design

5. Create src/routes/auth.callback.tsx:
   - createFileRoute('/auth/callback')
   - In loader: extract code from URL search params
   - Call supabase.auth.exchangeCodeForSession(code)
   - On success: redirect to /dashboard (or redirect param if present)
   - On error: redirect to /login with error toast
   - Show loading state while processing

Use sonner for toast notifications as per CONTEXT.md decisions.
  </action>
  <verify>
Run `npm run dev` and visit /login - should show centered sign-in page.
Click sign-in button - should redirect to Google (will fail without Supabase config, that's expected).
  </verify>
  <done>
Login page renders with Google sign-in button, callback route handles OAuth response, toasts configured for error handling.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` starts without errors
2. /login page shows minimal centered layout with Google sign-in button
3. Clicking sign-in initiates OAuth flow (redirects to Supabase/Google)
4. /auth/callback route exists and handles code exchange
5. Toaster component renders for notifications
6. TypeScript compiles without errors
</verification>

<success_criteria>
- Google OAuth flow initiates correctly when button clicked
- Callback route processes OAuth response
- User session is created after successful auth
- Errors display as toast notifications
- Login page follows CONTEXT.md design decisions (minimal, centered)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-security/01-03-SUMMARY.md`
</output>
