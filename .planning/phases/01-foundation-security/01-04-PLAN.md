---
phase: 01-foundation-security
plan: 04
type: execute
wave: 3
depends_on: ["01-03"]
files_modified:
  - src/routes/_authed.tsx
  - src/routes/_authed/dashboard.tsx
  - src/routes/logout.tsx
  - src/components/layout/header.tsx
  - src/components/dashboard/empty-state.tsx
autonomous: true

must_haves:
  truths:
    - "Unauthenticated users are redirected to /login when accessing /dashboard"
    - "Authenticated users see dashboard with their avatar and name in header"
    - "Empty dashboard shows welcome message and CTA to create first blog"
    - "User can sign out via dropdown menu"
    - "Session persists across browser refresh (AUTH-02)"
  artifacts:
    - path: "src/routes/_authed.tsx"
      provides: "Protected route layout with auth guard"
      exports: ["Route"]
    - path: "src/routes/_authed/dashboard.tsx"
      provides: "Dashboard page with empty state"
      exports: ["Route"]
    - path: "src/components/layout/header.tsx"
      provides: "Header with user menu"
      exports: ["Header"]
    - path: "src/components/dashboard/empty-state.tsx"
      provides: "Empty dashboard welcome component"
      exports: ["EmptyDashboardState"]
  key_links:
    - from: "src/routes/_authed.tsx"
      to: "src/server/auth.ts"
      via: "getUser in beforeLoad"
      pattern: "getUser"
    - from: "src/routes/_authed.tsx"
      to: "/login"
      via: "redirect when not authenticated"
      pattern: "redirect.*login"
    - from: "src/components/layout/header.tsx"
      to: "src/server/auth.ts"
      via: "signOut function"
      pattern: "signOut"
---

<objective>
Create protected dashboard with auth guard, user header, and empty state for new users.

Purpose: Complete the authentication flow by creating protected routes that only authenticated users can access. This completes AUTH-01, AUTH-02, and AUTH-03 requirements.

Output: Protected dashboard that shows user info, handles session persistence, and guides new users to their first action.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation-security/01-CONTEXT.md
@.planning/phases/01-foundation-security/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create protected route layout with auth guard</name>
  <files>src/routes/_authed.tsx, src/routes/logout.tsx</files>
  <action>
Create authentication guard layout route:

1. Create src/routes/_authed.tsx:
   - Import createFileRoute, redirect, Outlet from @tanstack/react-router
   - Import getUser from ~/server/auth

   - beforeLoad function:
     - Call getUser()
     - If no user, throw redirect({ to: '/login', search: { redirect: location.href } })
     - Return { user } to make available to child routes

   - component function:
     - Return Outlet (children will render here)

   This creates a layout route that protects all routes under /_authed/*

2. Create src/routes/logout.tsx:
   - createFileRoute('/logout')
   - In loader: call signOut server function
   - signOut already redirects to '/', so component can be minimal
   - Show "Signing out..." text briefly during transition
  </action>
  <verify>
Visit /dashboard while not logged in - should redirect to /login.
After login, /dashboard should be accessible.
  </verify>
  <done>
_authed layout route guards all child routes, logout route clears session.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create dashboard page with header and empty state</name>
  <files>src/routes/_authed/dashboard.tsx, src/components/layout/header.tsx, src/components/dashboard/empty-state.tsx</files>
  <action>
Create the protected dashboard with user-friendly empty state:

1. Create src/components/layout/header.tsx:
   - Accept user prop with { email, displayName, avatarUrl }
   - Left side: App logo/name "Petra"
   - Right side: User dropdown with avatar image (or initials fallback)
   - Dropdown contains:
     - User name and email (display only)
     - Divider
     - "Sign out" link to /logout
   - Use Tailwind for styling: fixed top, shadow, white background
   - Avatar: 32x32px rounded-full, border

2. Create src/components/dashboard/empty-state.tsx:
   - Centered content with friendly message
   - Per CONTEXT.md: "Hey! Let's get you set up with your first blog."
   - Single CTA button: "Create your first blog" (links to /blogs/new - not implemented yet, just href)
   - Clean, minimal design with some visual interest (maybe a simple illustration placeholder)
   - Friendly casual tone as specified

3. Create src/routes/_authed/dashboard.tsx:
   - createFileRoute('/_authed/dashboard')
   - Get user from Route.useRouteContext()
   - Render Header component with user
   - Main content area with EmptyDashboardState
   - Later phases will replace empty state with actual dashboard content
   - Use Tailwind: min-h-screen, bg-gray-50, proper spacing

Layout structure:
- Header (fixed or sticky top)
- Main content area (padding, max-width container)
- EmptyDashboardState centered in main area
  </action>
  <verify>
After logging in, /dashboard shows:
- Header with user avatar and name
- Empty state with welcome message and CTA button
- Sign out works from dropdown
  </verify>
  <done>
Dashboard renders with header showing user info, empty state displays welcome message and CTA, sign out functionality works.
  </done>
</task>

</tasks>

<verification>
1. Unauthenticated access to /dashboard redirects to /login
2. After login, user lands on /dashboard
3. Header shows user avatar (or initials) and display name
4. Empty state shows friendly welcome message
5. CTA button is visible and styled
6. Sign out dropdown works and redirects to home
7. Refreshing page maintains session (AUTH-02)
8. RLS ensures user only sees their own data (AUTH-03)
</verification>

<success_criteria>
- Protected routes work correctly (redirect if not logged in)
- User info displays in header after authentication
- Empty dashboard follows CONTEXT.md design decisions
- Sign out functionality clears session
- Session persists across page refresh
- Clean, minimal UI matching project aesthetics
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-security/01-04-SUMMARY.md`
</output>
