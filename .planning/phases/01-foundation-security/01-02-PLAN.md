---
phase: 01-foundation-security
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00001_initial_schema.sql
autonomous: true

must_haves:
  truths:
    - "RLS is enabled on ALL tables before any production data"
    - "Each user can only access their own tenant's data"
    - "Unauthenticated users cannot access any data"
  artifacts:
    - path: "supabase/migrations/00001_initial_schema.sql"
      provides: "Database schema with RLS policies"
      contains: "ENABLE ROW LEVEL SECURITY"
  key_links:
    - from: "profiles table"
      to: "auth.users"
      via: "foreign key reference"
      pattern: "REFERENCES auth.users"
    - from: "RLS policies"
      to: "auth.uid()"
      via: "user identification"
      pattern: "auth.uid\\(\\)"
---

<objective>
Create Supabase database schema with multi-tenant Row Level Security for the Pinterest scheduling dashboard.

Purpose: Establish secure data isolation from day one - this is CRITICAL for multi-tenant security. RLS must be enabled on ALL tables before any production data enters the system.

Output: SQL migration file ready to apply to Supabase that creates the profiles table with proper RLS policies.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/research/ARCHITECTURE.md
@.planning/research/PITFALLS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create initial database schema with RLS</name>
  <files>supabase/migrations/00001_initial_schema.sql</files>
  <action>
Create the foundation database schema with multi-tenant RLS:

1. Create supabase/migrations/ directory

2. Create 00001_initial_schema.sql with:

-- Profiles table (extends auth.users)
CREATE TABLE IF NOT EXISTS public.profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  tenant_id UUID NOT NULL DEFAULT gen_random_uuid(),
  display_name TEXT,
  avatar_url TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- CRITICAL: Enable RLS immediately
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- Performance index on tenant_id
CREATE INDEX IF NOT EXISTS idx_profiles_tenant_id ON public.profiles(tenant_id);

-- RLS Policies for profiles
-- Policy 1: Users can view their own profile
CREATE POLICY "Users can view own profile"
  ON public.profiles
  FOR SELECT
  TO authenticated
  USING ((SELECT auth.uid()) = id);

-- Policy 2: Users can update their own profile
CREATE POLICY "Users can update own profile"
  ON public.profiles
  FOR UPDATE
  TO authenticated
  USING ((SELECT auth.uid()) = id)
  WITH CHECK ((SELECT auth.uid()) = id);

-- Trigger to auto-create profile on user signup
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, tenant_id, display_name, avatar_url)
  VALUES (
    NEW.id,
    gen_random_uuid(),
    COALESCE(NEW.raw_user_meta_data->>'full_name', NEW.raw_user_meta_data->>'name'),
    NEW.raw_user_meta_data->>'avatar_url'
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Drop trigger if exists (for idempotency)
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;

-- Create trigger
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION public.handle_new_user();

-- Updated_at trigger function
CREATE OR REPLACE FUNCTION public.handle_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Apply updated_at trigger to profiles
DROP TRIGGER IF EXISTS set_profiles_updated_at ON public.profiles;
CREATE TRIGGER set_profiles_updated_at
  BEFORE UPDATE ON public.profiles
  FOR EACH ROW
  EXECUTE FUNCTION public.handle_updated_at();

KEY SECURITY NOTES in comments:
- (SELECT auth.uid()) wraps the function call for caching (performance)
- TO authenticated ensures policies only apply to logged-in users
- SECURITY DEFINER on trigger allows it to bypass RLS for profile creation
  </action>
  <verify>
Review SQL syntax for correctness.
File should contain:
- CREATE TABLE profiles with tenant_id
- ALTER TABLE ... ENABLE ROW LEVEL SECURITY
- At least 2 RLS policies (SELECT, UPDATE)
- Trigger for auto-creating profiles
  </verify>
  <done>
Migration file exists at supabase/migrations/00001_initial_schema.sql with profiles table, RLS enabled, policies created, and auto-profile trigger configured.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create helper SQL for testing RLS</name>
  <files>supabase/tests/test_rls.sql</files>
  <action>
Create a test SQL file that can be run to verify RLS is working correctly:

1. Create supabase/tests/ directory

2. Create test_rls.sql with:

-- RLS Test Suite for Petra Pinterest
-- Run these queries in Supabase SQL Editor to verify RLS

-- Test 1: Verify RLS is enabled
SELECT tablename, rowsecurity
FROM pg_tables
WHERE schemaname = 'public' AND tablename = 'profiles';
-- Expected: rowsecurity = true

-- Test 2: Verify policies exist
SELECT pol.polname, pol.polcmd, pol.polroles::regrole[]
FROM pg_policy pol
JOIN pg_class cls ON pol.polrelid = cls.oid
WHERE cls.relname = 'profiles';
-- Expected: At least 2 policies (SELECT, UPDATE)

-- Test 3: Anon user cannot access profiles
-- Run with anon key (should return empty)
-- SET ROLE anon;
-- SELECT * FROM profiles LIMIT 1;
-- Expected: Empty result or permission denied

-- Test 4: Check index exists for performance
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'profiles' AND indexname LIKE '%tenant_id%';
-- Expected: idx_profiles_tenant_id exists

-- Instructions for manual testing:
-- 1. Create a test user via Supabase Auth
-- 2. Verify profile was auto-created
-- 3. Try to access other users' profiles (should fail)
  </action>
  <verify>
File exists with SQL queries that can test RLS configuration.
  </verify>
  <done>
Test SQL file provides queries to verify RLS is properly configured.
  </done>
</task>

</tasks>

<verification>
1. supabase/migrations/00001_initial_schema.sql exists
2. SQL file contains CREATE TABLE profiles with tenant_id column
3. SQL file contains ALTER TABLE ... ENABLE ROW LEVEL SECURITY
4. SQL file contains RLS policies for SELECT and UPDATE
5. SQL file contains trigger for auto-creating profiles
6. Test file exists for RLS verification
</verification>

<success_criteria>
- Migration file is syntactically correct SQL
- RLS is enabled on profiles table
- Policies restrict access to own data only
- Performance index on tenant_id exists
- Auto-profile creation trigger is set up
- Test queries provided for verification
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-security/01-02-SUMMARY.md`
</output>
