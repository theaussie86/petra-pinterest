---
phase: 05-ai-metadata-publishing
plan: 04
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/components/pins/schedule-pin-section.tsx
  - src/components/pins/bulk-schedule-dialog.tsx
  - src/components/ui/calendar.tsx
  - src/components/ui/popover.tsx
  - src/lib/api/pins.ts
  - src/lib/hooks/use-pins.ts
autonomous: true

must_haves:
  truths:
    - "User can pick a date and time to schedule a pin"
    - "Date/time picker is disabled until pin has title and description"
    - "Scheduling auto-advances pin status to bereit_zum_planen"
    - "User can clear a scheduled date"
    - "Bulk schedule dialog lets user spread pins across dates with interval"
  artifacts:
    - path: "src/components/pins/schedule-pin-section.tsx"
      provides: "Date/time picker for scheduling a single pin"
      exports: ["SchedulePinSection"]
    - path: "src/components/pins/bulk-schedule-dialog.tsx"
      provides: "Bulk scheduling with date spreading"
      exports: ["BulkScheduleDialog"]
    - path: "src/components/ui/calendar.tsx"
      provides: "shadcn/ui Calendar component"
    - path: "src/components/ui/popover.tsx"
      provides: "shadcn/ui Popover component"
  key_links:
    - from: "src/components/pins/schedule-pin-section.tsx"
      to: "src/lib/hooks/use-pins.ts"
      via: "useUpdatePin hook"
      pattern: "useUpdatePin"
    - from: "src/components/pins/schedule-pin-section.tsx"
      to: "src/components/ui/calendar.tsx"
      via: "Calendar component"
      pattern: "Calendar"
    - from: "src/components/pins/bulk-schedule-dialog.tsx"
      to: "src/lib/api/pins.ts"
      via: "schedulePinsBulk function"
      pattern: "schedulePinsBulk"
---

<objective>
Build scheduling UI components: date/time picker for single pin scheduling and bulk schedule dialog for spreading pins across dates.

Purpose: Users can schedule pins to specific dates and times, with prerequisite enforcement (metadata required first).
Output: SchedulePinSection component, BulkScheduleDialog, shadcn/ui Calendar and Popover components, updated API/hooks.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ai-metadata-publishing/05-CONTEXT.md
@.planning/phases/05-ai-metadata-publishing/05-RESEARCH.md
@.planning/phases/05-ai-metadata-publishing/05-01-SUMMARY.md
@src/lib/api/pins.ts
@src/lib/hooks/use-pins.ts
@src/types/pins.ts
@src/components/ui/button.tsx
@src/components/ui/dialog.tsx
@src/components/ui/input.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn/ui Calendar and Popover, create scheduling components</name>
  <files>
    src/components/ui/calendar.tsx
    src/components/ui/popover.tsx
    src/components/pins/schedule-pin-section.tsx
    src/components/pins/bulk-schedule-dialog.tsx
  </files>
  <action>
1. Install shadcn/ui Calendar and Popover components:
   - Run: `npx shadcn@latest add calendar popover` (this installs react-day-picker and date-fns as dependencies)

2. Create `src/components/pins/schedule-pin-section.tsx`:
   - Props: `{ pin: Pin }`
   - Import useUpdatePin from '@/lib/hooks/use-pins'
   - Import Calendar from '@/components/ui/calendar'
   - Import Popover, PopoverContent, PopoverTrigger from '@/components/ui/popover'
   - Import Button from '@/components/ui/button'
   - Import format from 'date-fns'
   - Import CalendarIcon, Clock, X from 'lucide-react'
   - Import Card, CardContent from '@/components/ui/card'

   - Prerequisite check: `const hasMetadata = !!pin.title && !!pin.description`
   - Initialize date/time from pin.scheduled_at if exists:
     ```
     const existingDate = pin.scheduled_at ? new Date(pin.scheduled_at) : undefined
     const [date, setDate] = useState<Date | undefined>(existingDate)
     const [time, setTime] = useState<string>(existingDate ? format(existingDate, 'HH:mm') : '')
     ```

   - Layout: Card with title "Schedule":
     - If !hasMetadata: show disabled state with message "Generate metadata before scheduling" in muted text
     - If hasMetadata:
       - Date picker: Popover with Calendar (mode="single", selected={date}, onSelect={setDate}, disabled={(d) => d < new Date()} — can't schedule in the past)
         - Trigger button shows formatted date or "Pick a date" placeholder
       - Time picker section:
         - Preset quick-pick times as small buttons:
           ```
           const PRESET_TIMES = [
             { label: '6:00', value: '06:00' },
             { label: '9:00', value: '09:00' },
             { label: '12:00', value: '12:00' },
             { label: '15:00', value: '15:00' },
             { label: '18:00', value: '18:00' },
             { label: '21:00', value: '21:00' },
           ]
           ```
         - Selected preset highlighted with default variant, others outline
         - Native `<input type="time">` for custom time entry (styled with Tailwind: border rounded px-2 py-1 text-sm)
       - "Schedule" button: disabled when !date || !time or mutation pending
         - onClick: combine date + time into ISO string, call `updatePin.mutate({ id: pin.id, scheduled_at: isoString, status: 'bereit_zum_planen' })`
       - "Clear Schedule" link button (text-sm, text-slate-500): visible when pin.scheduled_at exists
         - onClick: call `updatePin.mutate({ id: pin.id, scheduled_at: null })`, reset local date/time state
         - NOTE: Do NOT auto-change status on clear — user decides

3. Create `src/components/pins/bulk-schedule-dialog.tsx`:
   - Props: `{ pinIds: string[]; open: boolean; onOpenChange: (open: boolean) => void }`
   - Import Calendar, Popover, Button, Dialog, Input from shadcn/ui
   - Import useBulkSchedulePins from '@/lib/hooks/use-pins' (will be added in Task 2)
   - State: startDate, time (string), intervalDays (number, default 2)
   - Layout:
     - Dialog with title "Schedule Pins" and description: `Schedule ${pinIds.length} pins across dates`
     - Date picker for start date (same Popover+Calendar pattern)
     - Time preset buttons + custom time input (same pattern as single schedule)
     - Interval input: `<Input type="number" min="1" max="30" value={intervalDays} onChange={...} />` with label "Days between pins"
     - Preview text: "Pin 1: {startDate formatted}, Pin 2: {startDate + interval formatted}, ..." (show first 3 + "and N more")
     - "Schedule All" button: calls `bulkSchedule.mutate({ pin_ids: pinIds, start_date: startDate, interval_days: intervalDays, time })`
     - Disabled when !startDate || !time or mutation pending
   - Close dialog on success
  </action>
  <verify>
Run `npm run build` — no TypeScript errors. Verify `src/components/ui/calendar.tsx` and `src/components/ui/popover.tsx` exist (from shadcn CLI). Check that SchedulePinSection and BulkScheduleDialog export correctly.
  </verify>
  <done>Scheduling components created: date/time picker with presets for single pins, bulk schedule dialog with date spreading and interval configuration.</done>
</task>

<task type="auto">
  <name>Task 2: Update pins API and hooks for scheduling</name>
  <files>
    src/lib/api/pins.ts
    src/lib/hooks/use-pins.ts
  </files>
  <action>
1. Add to `src/lib/api/pins.ts`:

   a) `schedulePinsBulk(pinIds: string[], startDate: Date, intervalDays: number, time: string): Promise<void>`:
      - For each pin_id at index i:
        - Calculate scheduled date: startDate + (i * intervalDays) days
        - Set hours/minutes from time string (split by ':')
        - Update pin: `supabase.from('pins').update({ scheduled_at: scheduledDate.toISOString(), status: 'bereit_zum_planen' }).eq('id', pinIds[i])`
      - Process sequentially (not Promise.all) to avoid rate limits

2. Add to `src/lib/hooks/use-pins.ts`:

   a) `useBulkSchedulePins()`:
      - useMutation calling `schedulePinsBulk(pin_ids, start_date, interval_days, time)`
      - Input type: `{ pin_ids: string[]; start_date: Date; interval_days: number; time: string }`
      - onSuccess: toast.success(`${ids.length} pins scheduled`), invalidate ['pins']
      - onError: toast.error('Failed to schedule pins')
  </action>
  <verify>
Run `npm run build` — no TypeScript errors. Check that `schedulePinsBulk` is exported from pins API and `useBulkSchedulePins` is exported from hooks.
  </verify>
  <done>Pins API extended with bulk scheduling function. Hook wraps it with toast feedback and cache invalidation.</done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. shadcn/ui Calendar and Popover components are installed
3. SchedulePinSection shows disabled state when metadata is missing
4. Date picker prevents selecting past dates
5. Preset time buttons work with custom time input
6. BulkScheduleDialog shows date spreading preview
7. Bulk scheduling updates pins sequentially
</verification>

<success_criteria>
- User can pick date and time to schedule a pin
- Scheduling is disabled without metadata (title + description required)
- Preset times provide quick selection (6, 9, 12, 15, 18, 21)
- Custom time entry is available
- Status auto-advances to bereit_zum_planen on schedule
- Bulk scheduling spreads pins across dates with configurable interval
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-ai-metadata-publishing/05-04-SUMMARY.md`
</output>
