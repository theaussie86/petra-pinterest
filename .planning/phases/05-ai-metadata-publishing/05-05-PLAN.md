---
phase: 05-ai-metadata-publishing
plan: 05
type: execute
wave: 4
depends_on: ["05-03", "05-04"]
files_modified:
  - src/routes/_authed/pins/$pinId.tsx
  - src/components/pins/pins-list.tsx
  - src/types/pins.ts
  - src/components/pins/edit-pin-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Pin detail page shows scheduling section alongside metadata generation"
    - "Pins list has bulk Generate Metadata action for selected pins"
    - "Pins list has bulk Schedule action for selected pins"
    - "Phase 5 statuses are now selectable in status dropdown"
    - "Edit dialog includes alt_text field"
    - "Error recovery resets to previous_status instead of always to entwurf"
  artifacts:
    - path: "src/routes/_authed/pins/$pinId.tsx"
      provides: "Complete pin detail page with metadata + scheduling"
    - path: "src/components/pins/pins-list.tsx"
      provides: "Pins list with bulk metadata and schedule actions"
    - path: "src/types/pins.ts"
      provides: "Updated active status list for Phase 5"
    - path: "src/components/pins/edit-pin-dialog.tsx"
      provides: "Edit dialog with alt_text field"
  key_links:
    - from: "src/routes/_authed/pins/$pinId.tsx"
      to: "src/components/pins/schedule-pin-section.tsx"
      via: "SchedulePinSection component"
      pattern: "SchedulePinSection"
    - from: "src/components/pins/pins-list.tsx"
      to: "src/lib/hooks/use-metadata.ts"
      via: "useTriggerBulkMetadata hook"
      pattern: "useTriggerBulkMetadata"
    - from: "src/components/pins/pins-list.tsx"
      to: "src/components/pins/bulk-schedule-dialog.tsx"
      via: "BulkScheduleDialog component"
      pattern: "BulkScheduleDialog"
---

<objective>
Wire all Phase 5 components together: integrate scheduling into pin detail page, add bulk actions to pins list, update status constants for Phase 5, and add alt_text to edit dialog.

Purpose: Final integration plan that connects metadata generation and scheduling UI to existing pages and unlocks Phase 5 statuses.
Output: Complete, functional Phase 5 feature set.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ai-metadata-publishing/05-CONTEXT.md
@.planning/phases/05-ai-metadata-publishing/05-03-SUMMARY.md
@.planning/phases/05-ai-metadata-publishing/05-04-SUMMARY.md
@src/routes/_authed/pins/$pinId.tsx
@src/components/pins/pins-list.tsx
@src/components/pins/edit-pin-dialog.tsx
@src/types/pins.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate scheduling into pin detail page and update status/edit</name>
  <files>
    src/routes/_authed/pins/$pinId.tsx
    src/types/pins.ts
    src/components/pins/edit-pin-dialog.tsx
  </files>
  <action>
1. Update `src/routes/_authed/pins/$pinId.tsx`:
   - Import SchedulePinSection from '@/components/pins/schedule-pin-section'
   - Add `<SchedulePinSection pin={pin} />` in the right column, after the GenerateMetadataButton and before the error alert section
   - Update ErrorAlert component: instead of always resetting to 'entwurf', check `pin.previous_status`:
     ```
     const handleResetStatus = async () => {
       await updateMutation.mutateAsync({
         id: pinId,
         status: pin.previous_status || 'entwurf',
         error_message: null,
       })
     }
     ```
     This requires passing `pin` (or `pin.previous_status`) as a prop to ErrorAlert instead of just `pinId`.
     Update ErrorAlert props: `{ pin: Pin }` instead of `{ pinId: string; errorMessage: string | null }`
     Update the component to use `pin.id`, `pin.error_message`, and `pin.previous_status`

2. Update `src/types/pins.ts`:
   - Replace `PHASE4_ACTIVE_STATUSES` with `PHASE5_ACTIVE_STATUSES` (or rename to just `ACTIVE_STATUSES`):
     ```typescript
     export const ACTIVE_STATUSES: PinStatus[] = [
       'entwurf',
       'bereit_fuer_generierung',
       'metadaten_generieren',
       'metadaten_erstellt',
       'bereit_zum_planen',
     ]
     ```
   - Keep `PHASE4_DISABLED_STATUSES` but rename to `DISABLED_STATUSES` — these are statuses that are system-managed (not user-selectable):
     ```typescript
     export const SYSTEM_MANAGED_STATUSES: PinStatus[] = [
       'pin_generieren',
       'pin_wird_generiert',
       'pin_generiert',
       'metadaten_werden_generiert',
       'veroeffentlicht',
     ]
     ```
   - Add `PHASE5_HIDDEN_STATUSES` — statuses hidden from Phase 5 UI (future pin image generation):
     ```typescript
     export const HIDDEN_STATUSES: PinStatus[] = [
       'pin_generieren',
       'pin_wird_generiert',
       'pin_generiert',
     ]
     ```
   - Update any imports of `PHASE4_ACTIVE_STATUSES` and `PHASE4_DISABLED_STATUSES` across the codebase. Search with grep first to find all usages.

3. Update `src/components/pins/edit-pin-dialog.tsx`:
   - Add alt_text field (Textarea) to the edit form, after the description field
   - Label: "Alt Text"
   - Placeholder: "Describe the image for accessibility"
   - Include alt_text in the form submission (PinUpdate already has alt_text from Plan 01)
  </action>
  <verify>
Run `npm run build` — no TypeScript errors. Grep for `PHASE4_ACTIVE_STATUSES` and `PHASE4_DISABLED_STATUSES` — should find zero results (all renamed). Check that edit dialog includes alt_text textarea. Check ErrorAlert uses previous_status.
  </verify>
  <done>Pin detail page has complete metadata + scheduling sections. Status constants updated for Phase 5. Edit dialog includes alt_text. Error recovery uses previous_status.</done>
</task>

<task type="auto">
  <name>Task 2: Add bulk metadata and schedule actions to pins list</name>
  <files>src/components/pins/pins-list.tsx</files>
  <action>
1. Update `src/components/pins/pins-list.tsx`:

   - Import `useTriggerBulkMetadata` from '@/lib/hooks/use-metadata'
   - Import `BulkScheduleDialog` from '@/components/pins/bulk-schedule-dialog'
   - Import Sparkles, CalendarIcon from 'lucide-react'

   - Add state: `const [bulkScheduleOpen, setBulkScheduleOpen] = useState(false)`
   - Add hook: `const triggerBulkMetadata = useTriggerBulkMetadata()`

   - In the bulk actions toolbar (where "Delete Selected" and "Change Status" already exist), add two new actions:
     a) "Generate Metadata" button (Sparkles icon):
        - onClick: `triggerBulkMetadata.mutate({ pin_ids: Array.from(selectedPins) })`
        - Disabled when mutation pending or no pins selected
        - Show count: "Generate ({selectedPins.size})"

     b) "Schedule" button (CalendarIcon):
        - onClick: `setBulkScheduleOpen(true)`
        - Disabled when no pins selected
        - Show count: "Schedule ({selectedPins.size})"

   - Add BulkScheduleDialog at the bottom of the component:
     ```
     <BulkScheduleDialog
       pinIds={Array.from(selectedPins)}
       open={bulkScheduleOpen}
       onOpenChange={setBulkScheduleOpen}
     />
     ```

   - Update status filter tabs: replace `PHASE4_ACTIVE_STATUSES` reference with the new `ACTIVE_STATUSES` import. Update the status dropdown in the table to use `ACTIVE_STATUSES` and `SYSTEM_MANAGED_STATUSES` for determining which statuses are selectable.

   - In the table view, add "Scheduled" column after Status:
     - Show formatted date if `pin.scheduled_at` exists, otherwise dash
     - Use `new Date(pin.scheduled_at).toLocaleDateString()` for compact display

   - In the grid view (PinCard), show scheduled date as small text below the status badge if pin.scheduled_at exists.
  </action>
  <verify>
Run `npm run build` — no TypeScript errors. Check the pins list has "Generate Metadata" and "Schedule" bulk action buttons. Verify the "Scheduled" column appears in table view. Verify status constants import the new names.
  </verify>
  <done>Pins list has bulk metadata generation and scheduling actions. Table shows scheduled column. Status constants updated to Phase 5 names. Bulk schedule dialog integrated.</done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. Pin detail page shows: metadata generation card + scheduling card + alt_text field
3. Error recovery uses previous_status (not always entwurf)
4. Pins list has bulk "Generate Metadata" and "Schedule" buttons
5. Bulk schedule dialog opens with selected pins
6. Table view shows "Scheduled" column
7. Status dropdown shows Phase 5 active statuses
8. All old PHASE4_* constant references are updated
9. Edit dialog includes alt_text textarea
</verification>

<success_criteria>
- Complete end-to-end Phase 5 functionality:
  - Single pin: generate metadata -> view history -> regenerate with feedback -> schedule
  - Bulk: select pins -> generate metadata (Inngest) -> schedule (spread across dates)
  - Status auto-advances: metadaten_erstellt after generation, bereit_zum_planen after scheduling
  - Error recovery resets to previous_status
- All Phase 5 requirements (PIN-03, PIN-06) are satisfied
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-ai-metadata-publishing/05-05-SUMMARY.md`
</output>
