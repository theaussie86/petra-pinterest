---
phase: 05-ai-metadata-publishing
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/components/pins/generate-metadata-button.tsx
  - src/components/pins/metadata-history-dialog.tsx
  - src/components/pins/regenerate-feedback-dialog.tsx
  - src/routes/_authed/pins/$pinId.tsx
autonomous: true

must_haves:
  truths:
    - "User can click Generate Metadata button on pin detail page"
    - "Button is disabled when pin already has metadata or is in generation state"
    - "User can browse last 3 metadata generations in a history dialog"
    - "User can restore a previous generation from history"
    - "User can regenerate metadata with feedback text"
    - "Pin status updates are reflected in real-time on the detail page"
  artifacts:
    - path: "src/components/pins/generate-metadata-button.tsx"
      provides: "Generate Metadata button with loading state"
      exports: ["GenerateMetadataButton"]
    - path: "src/components/pins/metadata-history-dialog.tsx"
      provides: "Dialog showing generation history with restore"
      exports: ["MetadataHistoryDialog"]
    - path: "src/components/pins/regenerate-feedback-dialog.tsx"
      provides: "Dialog with feedback text input for regeneration"
      exports: ["RegenerateFeedbackDialog"]
    - path: "src/routes/_authed/pins/$pinId.tsx"
      provides: "Pin detail page with metadata generation controls"
  key_links:
    - from: "src/components/pins/generate-metadata-button.tsx"
      to: "src/lib/hooks/use-metadata.ts"
      via: "useGenerateMetadata hook"
      pattern: "useGenerateMetadata"
    - from: "src/components/pins/metadata-history-dialog.tsx"
      to: "src/lib/hooks/use-metadata.ts"
      via: "useMetadataHistory, useRestoreMetadataGeneration"
      pattern: "useMetadataHistory|useRestoreMetadataGeneration"
    - from: "src/routes/_authed/pins/$pinId.tsx"
      to: "src/components/pins/generate-metadata-button.tsx"
      via: "component import"
      pattern: "GenerateMetadataButton"
---

<objective>
Build the single-pin metadata generation UI: generate button, history dialog, and regeneration with feedback dialog on the pin detail page.

Purpose: Users can trigger AI metadata generation, view generation history, and refine metadata with feedback from the pin detail page.
Output: Three new components integrated into the pin detail page.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ai-metadata-publishing/05-CONTEXT.md
@.planning/phases/05-ai-metadata-publishing/05-02-SUMMARY.md
@src/routes/_authed/pins/$pinId.tsx
@src/lib/hooks/use-metadata.ts
@src/types/pins.ts
@src/components/ui/dialog.tsx
@src/components/ui/button.tsx
@src/components/ui/textarea.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Metadata generation components</name>
  <files>
    src/components/pins/generate-metadata-button.tsx
    src/components/pins/metadata-history-dialog.tsx
    src/components/pins/regenerate-feedback-dialog.tsx
  </files>
  <action>
1. Create `src/components/pins/generate-metadata-button.tsx`:
   - Props: `{ pin: Pin; onHistoryOpen: () => void; onRegenerateOpen: () => void }`
   - Import `useGenerateMetadata` from '@/lib/hooks/use-metadata'
   - Import Sparkles, History, RefreshCw from 'lucide-react'
   - Import Button, Card, CardContent from shadcn/ui
   - Layout: A Card section with title "AI Metadata" containing:
     - If pin has NO title AND NO description:
       - "Generate Metadata" primary button (Sparkles icon) — calls `generateMetadata.mutate({ pin_id: pin.id })`
       - Disabled when pin status is 'metadaten_werden_generiert' (show "Generating..." text + spinner)
     - If pin HAS title OR description (metadata exists):
       - Show "Regenerate with Feedback" button (RefreshCw icon) — calls `onRegenerateOpen()`
       - Show "View History" button (History icon) — calls `onHistoryOpen()`
       - Show "Regenerate" button (Sparkles icon) — calls `generateMetadata.mutate({ pin_id: pin.id })` for quick re-gen without feedback
     - All generation buttons disabled during pending mutation state
   - Show generation status: if pin.status is 'metadaten_werden_generiert', show inline "Generating metadata..." with spinner

2. Create `src/components/pins/metadata-history-dialog.tsx`:
   - Props: `{ pinId: string; open: boolean; onOpenChange: (open: boolean) => void }`
   - Import `useMetadataHistory`, `useRestoreMetadataGeneration` from '@/lib/hooks/use-metadata'
   - Dialog with title "Metadata History"
   - Show loading state while fetching
   - List up to 3 generations, most recent first, each showing:
     - Date/time (formatted with toLocaleDateString + toLocaleTimeString)
     - Title preview (truncated to 60 chars)
     - Description preview (truncated to 100 chars)
     - Alt text preview (truncated to 60 chars)
     - If feedback is non-null: show "Feedback: {feedback}" in italic
     - "Use This Version" button — calls `restoreGeneration.mutate({ pinId, generationId: gen.id })`
     - Visually distinguish first item as "Current" with a badge
   - Empty state: "No generation history yet"
   - Close dialog on successful restore

3. Create `src/components/pins/regenerate-feedback-dialog.tsx`:
   - Props: `{ pinId: string; open: boolean; onOpenChange: (open: boolean) => void }`
   - Import `useGenerateMetadataWithFeedback` from '@/lib/hooks/use-metadata'
   - Dialog with title "Regenerate Metadata"
   - Textarea for feedback text with placeholder: "e.g., make it shorter, focus on baking keywords, add more urgency..."
   - "Regenerate" submit button — calls `regenerateWithFeedback.mutate({ pin_id: pinId, feedback })`
   - Disabled when feedback is empty or mutation is pending
   - Close dialog on success, clear feedback text
   - Label above textarea: "How should the metadata be improved?"
  </action>
  <verify>
Run `npm run build` — no TypeScript errors. All three components export correctly.
  </verify>
  <done>Three metadata UI components created: generate button with status awareness, history dialog with restore, feedback dialog for regeneration.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate metadata components into pin detail page</name>
  <files>src/routes/_authed/pins/$pinId.tsx</files>
  <action>
1. Update the pin detail page (`src/routes/_authed/pins/$pinId.tsx`):

   - Add imports for the three new components: GenerateMetadataButton, MetadataHistoryDialog, RegenerateFeedbackDialog

   - Add state variables:
     - `const [historyDialogOpen, setHistoryDialogOpen] = useState(false)`
     - `const [feedbackDialogOpen, setFeedbackDialogOpen] = useState(false)`

   - In the right column metadata Card, add alt_text display:
     - After the Description section, add:
       ```
       <div>
         <h3 className="text-xs font-medium text-slate-500 uppercase mb-1">Alt Text</h3>
         <p className="text-sm text-slate-700">
           {pin.alt_text || <span className="text-slate-400">No alt text</span>}
         </p>
       </div>
       ```

   - In the right column, after the pin info Card and before the error alert, add:
     - `<GenerateMetadataButton pin={pin} onHistoryOpen={() => setHistoryDialogOpen(true)} onRegenerateOpen={() => setFeedbackDialogOpen(true)} />`

   - Add the two dialogs alongside existing dialogs at the bottom:
     - `<MetadataHistoryDialog pinId={pinId} open={historyDialogOpen} onOpenChange={setHistoryDialogOpen} />`
     - `<RegenerateFeedbackDialog pinId={pinId} open={feedbackDialogOpen} onOpenChange={setFeedbackDialogOpen} />`

   - Update the scheduled_at display: After the Created/Updated dates grid, if `pin.scheduled_at` is non-null, show:
     ```
     <div>
       <h3 className="text-xs font-medium text-slate-500 uppercase mb-1">Scheduled</h3>
       <p className="text-sm text-slate-700">{formatDateTime(pin.scheduled_at)}</p>
     </div>
     ```
     Add `formatDateTime` helper: `new Date(dateString).toLocaleString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })`
  </action>
  <verify>
Run `npm run build` — no TypeScript errors. Run `npm run dev` and navigate to a pin detail page. Verify the AI Metadata section appears. The Generate Metadata button should be visible for pins without metadata.
  </verify>
  <done>Pin detail page shows alt_text field, AI metadata generation controls, history dialog, and feedback dialog. Scheduled time is displayed when set.</done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. Pin detail page shows "AI Metadata" card with generate button
3. Clicking "Generate Metadata" triggers server function call
4. After generation, history dialog shows the generation
5. Regenerate with feedback dialog accepts text input
6. Alt text field is displayed on pin detail page
7. All three dialogs open and close correctly
</verification>

<success_criteria>
- User can trigger AI metadata generation from pin detail page
- Generation button shows loading state during processing
- History dialog shows last 3 generations with restore option
- Feedback dialog allows refinement text before regeneration
- Pin detail page displays alt_text field
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-ai-metadata-publishing/05-03-SUMMARY.md`
</output>
