---
phase: 04-pin-management
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/types/pins.ts
  - src/lib/api/pins.ts
  - src/lib/hooks/use-pins.ts
autonomous: true

must_haves:
  truths:
    - "Pin TypeScript types match database schema exactly"
    - "Pin status constants with display labels and colors are exported"
    - "CRUD operations for pins work through Supabase client"
    - "Image upload to Supabase Storage works with tenant folder isolation"
    - "TanStack Query hooks provide caching and mutation with toast feedback"
  artifacts:
    - path: "src/types/pins.ts"
      provides: "Pin, PinInsert, PinUpdate, Board types and PinStatus constants"
      exports: ["Pin", "PinInsert", "PinUpdate", "Board", "PIN_STATUSES", "PinStatus"]
    - path: "src/lib/api/pins.ts"
      provides: "Supabase CRUD operations for pins and image upload"
      exports: ["getPinsByProject", "getPin", "createPin", "updatePin", "deletePin", "uploadPinImage"]
    - path: "src/lib/hooks/use-pins.ts"
      provides: "TanStack Query hooks for pins"
      exports: ["usePins", "usePin", "useCreatePin", "useUpdatePin", "useDeletePin", "useBulkDeletePins", "useBulkUpdatePinStatus"]
  key_links:
    - from: "src/lib/api/pins.ts"
      to: "supabase client"
      via: "import { supabase } from '@/lib/supabase'"
    - from: "src/lib/hooks/use-pins.ts"
      to: "src/lib/api/pins.ts"
      via: "import API functions"
    - from: "src/lib/api/pins.ts"
      to: "supabase.storage.from('pin-images')"
      via: "uploadPinImage function"
---

<objective>
Create the complete TypeScript data layer for pins: types matching the database schema, pin status constants with display metadata (labels, colors), Supabase API functions for CRUD + image upload, and TanStack Query hooks with mutation feedback.

Purpose: Provides the data access layer consumed by all pin UI components in subsequent plans.
Output: Three files establishing the type-safe data pipeline from database to React components.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@src/types/blog-projects.ts
@src/types/articles.ts
@src/lib/api/blog-projects.ts
@src/lib/api/articles.ts
@src/lib/hooks/use-blog-projects.ts
@src/lib/hooks/use-articles.ts
@src/lib/supabase.ts
@src/lib/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pin types and status constants</name>
  <files>src/types/pins.ts</files>
  <action>
Create TypeScript types following the established pattern in `src/types/blog-projects.ts` and `src/types/articles.ts`.

**Pin status type and constants:**
```typescript
export const PIN_STATUS = {
  entwurf: { label: 'Entwurf', color: 'slate' },
  bereit_fuer_generierung: { label: 'Bereit fur Generierung', color: 'blue' },
  pin_generieren: { label: 'Pin generieren', color: 'indigo' },
  pin_wird_generiert: { label: 'Pin wird generiert', color: 'indigo' },
  pin_generiert: { label: 'Pin generiert', color: 'purple' },
  metadaten_generieren: { label: 'Metadaten generieren', color: 'violet' },
  metadaten_werden_generiert: { label: 'Metadaten werden generiert', color: 'violet' },
  metadaten_erstellt: { label: 'Metadaten erstellt', color: 'teal' },
  bereit_zum_planen: { label: 'Bereit zum Planen', color: 'green' },
  veroeffentlicht: { label: 'Veroffentlicht', color: 'emerald' },
  fehler: { label: 'Fehler', color: 'red' },
  loeschen: { label: 'Loschen', color: 'gray' },
} as const

export type PinStatus = keyof typeof PIN_STATUS
```

**Phase 4 active statuses** (used to determine which statuses users can manually set):
```typescript
export const PHASE4_ACTIVE_STATUSES: PinStatus[] = ['entwurf', 'bereit_fuer_generierung']
export const PHASE4_DISABLED_STATUSES: PinStatus[] = [
  'pin_generieren', 'pin_wird_generiert', 'pin_generiert',
  'metadaten_generieren', 'metadaten_werden_generiert', 'metadaten_erstellt',
  'bereit_zum_planen', 'veroeffentlicht'
]
```

**Pin interface:**
```typescript
export interface Pin {
  id: string
  tenant_id: string
  blog_project_id: string
  blog_article_id: string
  board_id: string | null
  image_path: string
  title: string | null
  description: string | null
  status: PinStatus
  error_message: string | null
  scheduled_at: string | null
  published_at: string | null
  pinterest_pin_id: string | null
  created_at: string
  updated_at: string
}
```

**PinInsert type** (required at creation: image_path + blog_article_id):
```typescript
export interface PinInsert {
  blog_project_id: string
  blog_article_id: string
  image_path: string
  board_id?: string | null
  title?: string | null
  description?: string | null
}
```

**PinUpdate type:**
```typescript
export interface PinUpdate {
  id: string
  title?: string | null
  description?: string | null
  board_id?: string | null
  status?: PinStatus
  error_message?: string | null
}
```

**Board interface:**
```typescript
export interface Board {
  id: string
  tenant_id: string
  blog_project_id: string
  name: string
  pinterest_board_id: string | null
  cover_image_url: string | null
  created_at: string
  updated_at: string
}
```

**Sort/filter types:**
```typescript
export type PinSortField = 'title' | 'status' | 'created_at' | 'updated_at'
export type PinViewMode = 'table' | 'grid'
```

**Helper to get status badge colors** (maps to Tailwind classes):
```typescript
export function getStatusBadgeClasses(status: PinStatus): string {
  const colorMap: Record<string, string> = {
    slate: 'bg-slate-100 text-slate-700',
    blue: 'bg-blue-100 text-blue-700',
    indigo: 'bg-indigo-100 text-indigo-700',
    purple: 'bg-purple-100 text-purple-700',
    violet: 'bg-violet-100 text-violet-700',
    teal: 'bg-teal-100 text-teal-700',
    green: 'bg-green-100 text-green-700',
    emerald: 'bg-emerald-100 text-emerald-700',
    red: 'bg-red-100 text-red-700',
    gray: 'bg-gray-100 text-gray-500',
  }
  return colorMap[PIN_STATUS[status].color] || 'bg-slate-100 text-slate-700'
}
```
  </action>
  <verify>Run `npx tsc --noEmit` — no TypeScript errors from the new types file.</verify>
  <done>Pin, Board, PinStatus types and constants exported. getStatusBadgeClasses helper available. Phase 4 active/disabled status arrays exported.</done>
</task>

<task type="auto">
  <name>Task 2: Create pin API functions and TanStack Query hooks</name>
  <files>src/lib/api/pins.ts, src/lib/hooks/use-pins.ts</files>
  <action>
**API layer (`src/lib/api/pins.ts`)** — Follow the pattern in `src/lib/api/blog-projects.ts`:

```typescript
import { supabase } from '@/lib/supabase'
import { ensureProfile } from '@/lib/auth'
import type { Pin, PinInsert, PinUpdate, Board, PinStatus } from '@/types/pins'
```

Functions to implement:

1. `getPinsByProject(projectId: string): Promise<Pin[]>` — Select all pins for a project, ordered by created_at DESC. No archived_at filter (pins use status + loeschen).

2. `getPin(id: string): Promise<Pin>` — Single pin by ID.

3. `createPin(pin: PinInsert): Promise<Pin>` — Get tenant_id via ensureProfile(), insert with tenant_id. Return the created pin.

4. `createPins(pins: PinInsert[]): Promise<Pin[]>` — Bulk create. Get tenant_id once, insert all pins with same tenant_id. Return created pins array.

5. `updatePin({ id, ...updates }: PinUpdate): Promise<Pin>` — Update pin fields. Return updated pin.

6. `deletePin(id: string): Promise<void>` — Hard delete pin. Also delete the image from Storage: first query the pin to get image_path, then `supabase.storage.from('pin-images').remove([image_path])`, then delete the pin row.

7. `deletePins(ids: string[]): Promise<void>` — Bulk delete. Query pins to get image_paths, remove all from Storage, then delete pin rows.

8. `updatePinStatus(id: string, status: PinStatus): Promise<Pin>` — Convenience wrapper for status-only updates.

9. `updatePinsStatus(ids: string[], status: PinStatus): Promise<void>` — Bulk status update using `.in('id', ids)`.

10. `uploadPinImage(file: File, tenantId: string): Promise<string>` — Upload image to Supabase Storage:
    - Generate path: `${tenantId}/${crypto.randomUUID()}.${file.name.split('.').pop()}`
    - Upload via `supabase.storage.from('pin-images').upload(path, file)`
    - Return the path (NOT the full URL — store path, construct URL when needed)

11. `getPinImageUrl(path: string): string` — Construct public URL from path:
    - `supabase.storage.from('pin-images').getPublicUrl(path).data.publicUrl`

12. `getBoardsByProject(projectId: string): Promise<Board[]>` — Get boards for a project, ordered by name.

**Hooks (`src/lib/hooks/use-pins.ts`)** — Follow the pattern in `src/lib/hooks/use-blog-projects.ts`:

1. `usePins(projectId: string)` — useQuery with key `['pins', projectId]`, staleTime 30000.

2. `usePin(id: string)` — useQuery with key `['pins', 'detail', id]`, enabled: !!id.

3. `useCreatePin()` — useMutation calling createPin. On success: toast "Pin created", invalidate `['pins']`. No optimistic update (image upload makes it complex).

4. `useCreatePins()` — useMutation calling createPins. On success: toast "{n} pins created", invalidate `['pins']`.

5. `useUpdatePin()` — useMutation calling updatePin. On success: toast "Pin updated", invalidate `['pins']`.

6. `useDeletePin()` — useMutation calling deletePin. On success: toast "Pin deleted", invalidate `['pins']`.

7. `useBulkDeletePins()` — useMutation calling deletePins. On success: toast "{n} pins deleted", invalidate `['pins']`.

8. `useBulkUpdatePinStatus()` — useMutation calling updatePinsStatus. On success: toast "Status updated for {n} pins", invalidate `['pins']`.

9. `useBoards(projectId: string)` — useQuery with key `['boards', projectId]`, staleTime 30000.
  </action>
  <verify>Run `npx tsc --noEmit` — no TypeScript errors. All hooks and API functions compile correctly with proper type imports.</verify>
  <done>Complete pin data layer: 12 API functions and 9 TanStack Query hooks. Image upload returns Storage path. Bulk operations supported for create, delete, and status change.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- Pin type matches database schema columns exactly
- PIN_STATUS has all 12 workflow states with labels and colors
- API functions use ensureProfile() for write operations
- Hooks use consistent query key structure ['pins', projectId] for lists
- Image upload returns a path string, not a full URL
- Bulk operations (create, delete, status change) are supported
</verification>

<success_criteria>
TypeScript compiles. All 12 API functions and 9 hooks export correctly. Pin status constants cover the full workflow. Image upload path generation uses tenant_id prefix for Storage RLS.
</success_criteria>

<output>
After completion, create `.planning/phases/04-pin-management/04-02-SUMMARY.md`
</output>
