---
phase: 04-pin-management
plan: 05
type: execute
wave: 4
depends_on: ["04-03", "04-04"]
files_modified:
  - src/routes/_authed/pins/$pinId.tsx
  - src/components/pins/edit-pin-dialog.tsx
  - src/components/pins/delete-pin-dialog.tsx
  - src/routes/_authed/projects/$id.tsx
autonomous: true

must_haves:
  truths:
    - "User can view pin detail page with full-size image, metadata, and linked article"
    - "User can edit pin title, description, board, and status"
    - "User can delete a pin from the detail page (with confirmation)"
    - "Pin status dropdown shows active statuses enabled and future statuses greyed out"
    - "Error state pins show error message and allow reset to last good state"
    - "Pins list is integrated into project detail page replacing the placeholder"
  artifacts:
    - path: "src/routes/_authed/pins/$pinId.tsx"
      provides: "Pin detail page with image, metadata, status, and actions"
      min_lines: 100
    - path: "src/components/pins/edit-pin-dialog.tsx"
      provides: "Edit dialog for pin metadata (title, description, board, status)"
      min_lines: 60
    - path: "src/components/pins/delete-pin-dialog.tsx"
      provides: "Delete confirmation dialog for single pin"
      min_lines: 30
    - path: "src/routes/_authed/projects/$id.tsx"
      provides: "Project detail page with PinsList replacing placeholder"
  key_links:
    - from: "src/routes/_authed/pins/$pinId.tsx"
      to: "src/lib/hooks/use-pins.ts"
      via: "usePin, useUpdatePin, useDeletePin hooks"
    - from: "src/components/pins/edit-pin-dialog.tsx"
      to: "src/types/pins.ts"
      via: "PHASE4_ACTIVE_STATUSES for status dropdown options"
    - from: "src/routes/_authed/pins/$pinId.tsx"
      to: "src/lib/api/pins.ts"
      via: "getPinImageUrl for full-size image display"
    - from: "src/routes/_authed/projects/$id.tsx"
      to: "src/components/pins/pins-list.tsx"
      via: "PinsList component replaces pins placeholder"
---

<objective>
Build the pin detail page, edit dialog, delete dialog, and integrate the pins list into the project detail page. This completes the full pin CRUD cycle with status management.

Purpose: Users need to view, edit, and delete individual pins, and see pins listed on their project page.
Output: Pin detail route, edit/delete dialogs, and project page integration.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-pin-management/04-CONTEXT.md
@src/routes/_authed/projects/$id.tsx
@src/routes/_authed/articles/$articleId.tsx
@src/components/projects/project-dialog.tsx
@src/components/projects/delete-dialog.tsx
@src/types/pins.ts
@src/lib/hooks/use-pins.ts
@src/lib/api/pins.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pin detail page with edit and delete dialogs</name>
  <files>src/routes/_authed/pins/$pinId.tsx, src/components/pins/edit-pin-dialog.tsx, src/components/pins/delete-pin-dialog.tsx</files>
  <action>
**Pin detail page (`src/routes/_authed/pins/$pinId.tsx`):**

Create a file-based route following the pattern in `src/routes/_authed/articles/$articleId.tsx`.

```typescript
export const Route = createFileRoute('/_authed/pins/$pinId')({
  component: PinDetail,
})
```

**Page layout:**
1. **Header:** Same site header as all pages (`<Header user={user} />`)
2. **Back navigation:** "Back to Project" button (link to `/projects/${pin.blog_project_id}`)
3. **Two-column layout** (on lg+, single column on mobile):
   - **Left column (2/3 width):** Full-size pin image
     - Use `getPinImageUrl(pin.image_path)` for src
     - Max width constrained, aspect ratio preserved
     - Rounded corners, subtle shadow
   - **Right column (1/3 width):** Pin metadata card:
     - **Title:** pin.title or "Untitled" in italic
     - **Description:** pin.description or "No description" in slate-400
     - **Status:** PinStatusBadge
     - **Article:** Link to article detail page (article title, clickable)
     - **Board:** Board name or "Not assigned" in slate-400
     - **Error message:** If status === 'fehler', show error_message in a red alert box with "Reset Status" button that sets status back to 'entwurf'
     - **Dates:** Created at, Updated at (formatted)
     - **Actions:**
       - "Edit Pin" button (opens EditPinDialog)
       - "Delete Pin" button (opens DeletePinDialog, red variant)

4. **Loading state:** Spinner (same pattern as project detail)
5. **Error state:** "Pin not found" with back button

**Need to fetch article title for display.** Use the existing `useArticle(pin.blog_article_id)` hook from use-articles.ts, but only after pin loads (enabled: !!pin). Or better, create a simple inline fetch — but the hook is cleaner. Use `useArticle` from `@/lib/hooks/use-articles`.

**EditPinDialog (`src/components/pins/edit-pin-dialog.tsx`):**

Follow the pattern of `src/components/projects/project-dialog.tsx`:

```typescript
interface EditPinDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  pin: Pin
  projectId: string
}
```

Form fields (React Hook Form + Zod):
1. **Title:** text input (optional)
2. **Description:** textarea (optional)
3. **Board:** Select dropdown from project boards (optional, nullable). Use `useBoards(projectId)` to fetch options.
4. **Status:** Select dropdown. Show all statuses from `PIN_STATUS`. Items in `PHASE4_ACTIVE_STATUSES` are enabled. Items in `PHASE4_DISABLED_STATUSES` are greyed out and disabled. `fehler` and `loeschen` are always shown but only fehler is selectable (for manual error recovery testing).

On submit: call `useUpdatePin` mutation. Close dialog on success.

**DeletePinDialog (`src/components/pins/delete-pin-dialog.tsx`):**

Follow the pattern of `src/components/projects/delete-dialog.tsx`:

```typescript
interface DeletePinDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  pin: Pin
  onDeleted?: () => void  // Optional navigation callback (navigate back to project)
}
```

- Show pin title (or "Untitled") and a warning that the image will also be deleted from storage
- "Delete" button calls `useDeletePin` mutation
- On success: call `onDeleted()` callback (which navigates to project page)
- Destructive button styling (red)
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Route `/_authed/pins/$pinId` registered in route tree
3. Pin detail page shows image, metadata, status badge, article link
4. Edit dialog opens with current values pre-filled
5. Delete dialog shows confirmation with pin name
  </verify>
  <done>Pin detail page with full image display, metadata card, status badge, article link, edit dialog with status dropdown (Phase 4 active statuses enabled, others greyed), and delete dialog with image cleanup warning.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate PinsList into project detail page</name>
  <files>src/routes/_authed/projects/$id.tsx</files>
  <action>
Update the project detail page to replace the pins placeholder Card with the actual PinsList component.

**Changes to `src/routes/_authed/projects/$id.tsx`:**

1. **Import PinsList:** `import { PinsList } from '@/components/pins/pins-list'`
2. **Import CreatePinDialog:** Already added in Plan 03. Verify it's imported.
3. **Replace the pins placeholder** (the Card with "Pins will appear here once you start creating content") with:

```tsx
{/* Pins section */}
<div className="mb-8">
  <div className="flex items-center justify-between mb-4">
    <h2 className="text-xl font-semibold flex items-center gap-2">
      <Pin className="h-5 w-5" />
      Pins
    </h2>
    <Button variant="outline" size="sm" onClick={() => setCreatePinDialogOpen(true)}>
      <Plus className="h-4 w-4 mr-1" /> Create Pin
    </Button>
  </div>
  <PinsList projectId={id} />
</div>
```

This matches the Articles section layout pattern exactly (heading with icon + action button + list component).

4. **Verify** the CreatePinDialog is rendered at the bottom with other dialogs (should already be added by Plan 03). If not present yet (Plan 03 may not have executed), add it:
```tsx
<CreatePinDialog
  open={createPinDialogOpen}
  onOpenChange={setCreatePinDialogOpen}
  projectId={id}
/>
```

**Note:** If Plan 03 has already modified this file, this task should merge cleanly — the placeholder Card is being replaced with the PinsList, and the CreatePinDialog should already be wired. If Plan 03 hasn't run yet (plans 03 and 04 are same wave), add the state + dialog + button too.

To handle both cases: check if `createPinDialogOpen` state already exists. If not, add `useState` for it. If the CreatePinDialog import/render already exists, don't duplicate it.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Project detail page shows Pins section with PinsList component (not placeholder)
3. Create Pin button opens dialog
4. Pins list shows table/grid views with status tabs
  </verify>
  <done>Project detail page displays actual PinsList with table/grid views, status tabs, and bulk actions. Pins placeholder removed. Create Pin button integrated.</done>
</task>

</tasks>

<verification>
- Pin detail page accessible at /pins/{pinId} with image, metadata, status, article link
- Edit dialog pre-fills current values, status dropdown respects Phase 4 active statuses
- Delete dialog warns about image deletion, navigates back to project on confirm
- Error state pins show error message with "Reset Status" button
- Project detail page has PinsList replacing placeholder Card
- Full CRUD cycle works: create (Plan 03) -> list (Plan 04) -> view detail -> edit -> delete
</verification>

<success_criteria>
Complete pin management CRUD: user can create pins (Plan 03), view in list (Plan 04), view detail, edit metadata/status, and delete with image cleanup. Project page shows real pins list instead of placeholder. Pin status workflow supports Phase 4 active statuses with future statuses shown but disabled.
</success_criteria>

<output>
After completion, create `.planning/phases/04-pin-management/04-05-SUMMARY.md`
</output>
