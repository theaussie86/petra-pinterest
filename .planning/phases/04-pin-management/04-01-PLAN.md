---
phase: 04-pin-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00005_pins_and_boards.sql
autonomous: true

must_haves:
  truths:
    - "pins table exists with tenant isolation via RLS"
    - "boards table exists with tenant isolation via RLS"
    - "Supabase Storage bucket 'pin-images' exists with RLS policies"
    - "Pin status enum covers full workflow"
  artifacts:
    - path: "supabase/migrations/00005_pins_and_boards.sql"
      provides: "pins table, boards table, Storage bucket, RLS policies"
      contains: "CREATE TABLE.*pins"
  key_links:
    - from: "pins.blog_article_id"
      to: "blog_articles.id"
      via: "REFERENCES foreign key"
    - from: "pins.board_id"
      to: "boards.id"
      via: "REFERENCES foreign key (nullable)"
    - from: "pins.image_path"
      to: "pin-images Storage bucket"
      via: "Supabase Storage path reference"
---

<objective>
Create the database foundation for pin management: pins table, boards table, and Supabase Storage bucket for pin images. All tables have multi-tenant RLS policies matching the existing blog_projects and blog_articles patterns.

Purpose: Establishes the data layer that all subsequent pin management plans depend on.
Output: A single migration file creating both tables, indexes, RLS policies, and the Storage bucket with policies.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/migrations/00004_blog_articles.sql
@supabase/migrations/00002_blog_projects.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pins and boards database migration</name>
  <files>supabase/migrations/00005_pins_and_boards.sql</files>
  <action>
Create a single SQL migration file with these sections:

**1. Boards table:**
```sql
CREATE TABLE public.boards (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL,
  blog_project_id UUID NOT NULL REFERENCES public.blog_projects(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  pinterest_board_id TEXT,          -- Pinterest external ID (synced via n8n)
  cover_image_url TEXT,             -- Board cover image URL from Pinterest
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```
- Add unique constraint on (blog_project_id, pinterest_board_id) for upsert support
- Enable RLS, add tenant isolation policies (SELECT, INSERT, UPDATE, DELETE) matching blog_articles pattern exactly
- Add tenant_id and blog_project_id indexes
- Add updated_at trigger using existing handle_updated_at() function

**2. Pins table:**
```sql
CREATE TABLE public.pins (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL,
  blog_project_id UUID NOT NULL REFERENCES public.blog_projects(id) ON DELETE CASCADE,
  blog_article_id UUID NOT NULL REFERENCES public.blog_articles(id) ON DELETE CASCADE,
  board_id UUID REFERENCES public.boards(id) ON DELETE SET NULL,  -- nullable, assigned later
  image_path TEXT NOT NULL,         -- Supabase Storage path (e.g., "{tenant_id}/{pin_id}.jpg")
  title TEXT,                       -- Pin title (filled later, nullable)
  description TEXT,                 -- Pin description (filled later, nullable)
  status TEXT NOT NULL DEFAULT 'entwurf' CHECK (status IN (
    'entwurf',
    'bereit_fuer_generierung',
    'pin_generieren',
    'pin_wird_generiert',
    'pin_generiert',
    'metadaten_generieren',
    'metadaten_werden_generiert',
    'metadaten_erstellt',
    'bereit_zum_planen',
    'veroeffentlicht',
    'fehler',
    'loeschen'
  )),
  error_message TEXT,               -- Error details when status = 'fehler'
  scheduled_at TIMESTAMPTZ,         -- When pin is scheduled (Phase 5+)
  published_at TIMESTAMPTZ,         -- When pin was published (Phase 5+)
  pinterest_pin_id TEXT,            -- Pinterest external ID (after publishing via n8n)
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```
- Enable RLS, add tenant isolation policies (SELECT, INSERT, UPDATE, DELETE) matching blog_articles pattern exactly
- Add indexes: tenant_id, blog_project_id, blog_article_id, board_id, status, scheduled_at
- Add updated_at trigger using existing handle_updated_at() function

**3. Supabase Storage bucket and policies:**
```sql
-- Create Storage bucket for pin images
INSERT INTO storage.buckets (id, name, public)
VALUES ('pin-images', 'pin-images', true)
ON CONFLICT (id) DO NOTHING;

-- Storage RLS policies for pin-images bucket
-- Policy: Authenticated users can upload to their tenant folder
CREATE POLICY "Users can upload pin images to own tenant folder"
  ON storage.objects
  FOR INSERT
  TO authenticated
  WITH CHECK (
    bucket_id = 'pin-images'
    AND (storage.foldername(name))[1] IN (
      SELECT tenant_id::text FROM public.profiles WHERE id = (SELECT auth.uid())
    )
  );

-- Policy: Anyone can view pin images (public bucket)
CREATE POLICY "Pin images are publicly readable"
  ON storage.objects
  FOR SELECT
  TO public
  USING (bucket_id = 'pin-images');

-- Policy: Authenticated users can update their own tenant's images
CREATE POLICY "Users can update pin images in own tenant folder"
  ON storage.objects
  FOR UPDATE
  TO authenticated
  USING (
    bucket_id = 'pin-images'
    AND (storage.foldername(name))[1] IN (
      SELECT tenant_id::text FROM public.profiles WHERE id = (SELECT auth.uid())
    )
  );

-- Policy: Authenticated users can delete their own tenant's images
CREATE POLICY "Users can delete pin images in own tenant folder"
  ON storage.objects
  FOR DELETE
  TO authenticated
  USING (
    bucket_id = 'pin-images'
    AND (storage.foldername(name))[1] IN (
      SELECT tenant_id::text FROM public.profiles WHERE id = (SELECT auth.uid())
    )
  );
```

The bucket is public for reads (pin images displayed in calendar and shared contexts) but tenant-isolated for writes/updates/deletes using the folder structure pattern: `{tenant_id}/{pin_id}.{ext}`.

**RLS policy template** (use for BOTH boards and pins tables):
```sql
CREATE POLICY "Users can {action} own tenant {table}"
  ON public.{table}
  FOR {ACTION}
  TO authenticated
  USING (
    tenant_id IN (
      SELECT tenant_id FROM public.profiles WHERE id = (SELECT auth.uid())
    )
  );
```
For INSERT, use WITH CHECK instead of USING. For UPDATE, use both USING and WITH CHECK.
  </action>
  <verify>
Apply the migration via Supabase MCP `apply_migration` tool. Verify:
1. `SELECT * FROM information_schema.tables WHERE table_name IN ('pins', 'boards')` returns both tables
2. `SELECT * FROM pg_policies WHERE tablename IN ('pins', 'boards')` returns 8 policies (4 per table)
3. `SELECT * FROM storage.buckets WHERE id = 'pin-images'` returns the bucket
4. `SELECT * FROM pg_policies WHERE tablename = 'objects' AND policyname LIKE '%pin images%'` returns 4 storage policies
  </verify>
  <done>pins table, boards table, and pin-images Storage bucket exist with full RLS tenant isolation. All indexes created. Status enum covers the complete workflow.</done>
</task>

</tasks>

<verification>
- pins table has all required columns including status CHECK constraint with 12 values
- boards table has all required columns with pinterest_board_id for n8n sync
- RLS is enabled on both tables with 4 policies each (SELECT, INSERT, UPDATE, DELETE)
- Storage bucket pin-images exists with tenant-folder-based RLS
- Foreign keys link pins to blog_articles, blog_projects, and boards
- Indexes exist on all query-relevant columns
</verification>

<success_criteria>
Migration applies without errors. Both tables have RLS enabled. Storage bucket is accessible. Pin status enum contains all 12 workflow states.
</success_criteria>

<output>
After completion, create `.planning/phases/04-pin-management/04-01-SUMMARY.md`
</output>
