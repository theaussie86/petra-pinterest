---
phase: 04-pin-management
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - src/components/pins/create-pin-dialog.tsx
  - src/components/pins/image-upload-zone.tsx
  - src/routes/_authed/projects/$id.tsx
autonomous: true

must_haves:
  truths:
    - "User can open pin creation dialog from project detail page"
    - "User can upload images via drag-drop, file picker, and clipboard paste"
    - "User can select multiple images for bulk upload in one dialog"
    - "Thumbnail preview grid shows all uploaded images with remove buttons"
    - "User selects which article to link pins to"
    - "Non-2:3 aspect ratio images show a warning (not blocking)"
    - "Each image becomes one pin after creation"
  artifacts:
    - path: "src/components/pins/create-pin-dialog.tsx"
      provides: "Pin creation dialog with article selector and image upload"
      min_lines: 100
    - path: "src/components/pins/image-upload-zone.tsx"
      provides: "Drag-drop, paste, file picker upload zone with previews"
      min_lines: 80
    - path: "src/routes/_authed/projects/$id.tsx"
      provides: "Updated project detail page with Create Pin button"
  key_links:
    - from: "src/components/pins/create-pin-dialog.tsx"
      to: "src/lib/hooks/use-pins.ts"
      via: "useCreatePins mutation for bulk creation"
    - from: "src/components/pins/image-upload-zone.tsx"
      to: "src/lib/api/pins.ts"
      via: "uploadPinImage for Supabase Storage upload"
    - from: "src/routes/_authed/projects/$id.tsx"
      to: "src/components/pins/create-pin-dialog.tsx"
      via: "Dialog open state + button trigger"
---

<objective>
Build the pin creation flow: an image upload zone component (drag-drop, paste, file picker) and a creation dialog that links images to an article, previews thumbnails, warns on non-Pinterest aspect ratio, and creates pins in bulk.

Purpose: The primary entry point for adding pins to the system. Users create pins by uploading images linked to blog articles.
Output: Two new components (upload zone + creation dialog) and updated project detail page with Create Pin button.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-pin-management/04-CONTEXT.md
@src/routes/_authed/projects/$id.tsx
@src/components/projects/project-dialog.tsx
@src/components/articles/add-article-dialog.tsx
@src/lib/hooks/use-pins.ts
@src/lib/api/pins.ts
@src/types/pins.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create image upload zone component</name>
  <files>src/components/pins/image-upload-zone.tsx</files>
  <action>
Create a reusable image upload component that supports three input methods:

**Drag-drop zone:**
- Drop area with dashed border, upload icon, and "Drop images here" text
- Highlight border color on dragover (blue-500)
- Accept multiple files
- Filter to image/* MIME types only

**File picker:**
- "Browse files" button/link inside the drop zone
- Hidden `<input type="file" accept="image/*" multiple />` triggered by click
- Supports selecting multiple files at once

**Clipboard paste:**
- Listen for `paste` events on the component (or document)
- Extract image files from `clipboardData.items`
- Add to the current file list

**Thumbnail preview grid:**
- Show uploaded images as a grid of thumbnail previews (responsive grid, 3-4 cols)
- Each thumbnail shows:
  - Image preview (object-cover, ~120x120px thumbnail)
  - File name (truncated)
  - File size (formatted, e.g., "1.2 MB")
  - Aspect ratio warning badge if not ~2:3 (tolerance: ratio between 0.6-0.7 is acceptable, otherwise show orange "Not 2:3" badge)
  - X button to remove from list
- Show count: "{n} image(s) selected"

**Props interface:**
```typescript
interface ImageUploadZoneProps {
  files: File[]
  onFilesChange: (files: File[]) => void
  disabled?: boolean
}
```

The component manages display only. File state is owned by the parent dialog via `files` prop and `onFilesChange` callback. Use `URL.createObjectURL()` for preview URLs and clean them up with `URL.revokeObjectURL()` on unmount or file removal.
  </action>
  <verify>Component renders without TypeScript errors. Drop zone visible, file input triggers on click.</verify>
  <done>ImageUploadZone component supports drag-drop, file picker, and clipboard paste. Thumbnail grid shows previews with aspect ratio warnings and remove buttons.</done>
</task>

<task type="auto">
  <name>Task 2: Create pin creation dialog and wire to project page</name>
  <files>src/components/pins/create-pin-dialog.tsx, src/routes/_authed/projects/$id.tsx</files>
  <action>
**Create CreatePinDialog component** following the pattern in `src/components/articles/add-article-dialog.tsx`:

**Dialog structure:**
- shadcn/ui Dialog with title "Create Pins" (or "Create Pin" if single)
- Two sections:
  1. **Article selector:** Dropdown (shadcn/ui Select) listing articles from the project. Show article title + truncated URL. Required field — user must select an article.
  2. **Image upload zone:** Embed `<ImageUploadZone />` for image selection
- Optional: Board selector dropdown (Select from project boards, nullable — can be assigned later)
- Footer: "Cancel" and "Create {n} Pin(s)" submit button

**Props:**
```typescript
interface CreatePinDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  projectId: string
  preselectedArticleId?: string  // When opened from article page
}
```

**Submit flow:**
1. Validate: at least one image selected, article selected
2. For each image file:
   a. Call `uploadPinImage(file, tenantId)` to upload to Supabase Storage — get tenant_id from `ensureProfile()`
   b. Collect the returned image paths
3. Call `createPins()` mutation with array of PinInsert objects (one per image, all sharing same article_id and optional board_id)
4. On success: close dialog, reset state
5. Show loading state during upload (disable submit button, show spinner)
6. On error: show toast error, keep dialog open

**Wire into project detail page (`$id.tsx`):**
- Add `useState` for `createPinDialogOpen`
- Replace the Pins placeholder Card with a section header (matching Articles section pattern):
  - h2 "Pins" with Pin icon
  - "Create Pin" button (opens dialog)
- Add `<CreatePinDialog>` to the dialogs section at bottom of page
- Import `useArticles` hook to pass articles list to the dialog for the article selector
- Import `useBoards` hook to pass boards list to the dialog for the board selector

**Article selector** must load articles from the project using `useArticles(projectId)` inside the dialog component (not passed as prop).
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Open project detail page — "Create Pin" button visible in Pins section
3. Click Create Pin — dialog opens with article dropdown and upload zone
  </verify>
  <done>Pin creation dialog with image upload, article selection, optional board selection. Bulk creation (multiple images = multiple pins). Project detail page has Create Pin button replacing placeholder.</done>
</task>

</tasks>

<verification>
- Project detail page shows Pins section with Create Pin button
- Dialog opens with article selector dropdown populated from project articles
- ImageUploadZone supports drag-drop, file picker, and paste
- Thumbnail grid shows previews with aspect ratio warnings
- Submit creates one pin per uploaded image linked to selected article
- Loading state shown during upload
- Dialog closes and pin list refreshes on success
</verification>

<success_criteria>
User can open Create Pin dialog from project page, select an article, upload one or more images (via any of 3 methods), see previews with aspect ratio warnings, and create pins. Each image becomes one pin linked to the selected article.
</success_criteria>

<output>
After completion, create `.planning/phases/04-pin-management/04-03-SUMMARY.md`
</output>
