---
phase: 09-consistent-ui-dashboard-layout
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/routes/_authed.tsx
  - src/routes/_authed/dashboard.tsx
  - src/routes/_authed/calendar.tsx
autonomous: true

must_haves:
  truths:
    - "All authenticated pages render inside a sidebar layout with left navigation"
    - "Sidebar shows Dashboard and Calendar links with active state highlighting"
    - "User can collapse and expand the sidebar"
    - "Dashboard page uses PageLayout component instead of inline wrapper with Header"
    - "Dashboard loading and error states render via PageLayout (no inline spinner)"
    - "Calendar page uses PageLayout component instead of inline wrapper with Header"
    - "Calendar page still supports pin sidebar (right panel) alongside app sidebar (left panel)"
    - "No Header component import exists in dashboard.tsx or calendar.tsx"
  artifacts:
    - path: "src/routes/_authed.tsx"
      provides: "SidebarProvider + AppSidebar + SidebarInset layout wrapper"
      contains: "SidebarProvider"
    - path: "src/routes/_authed/dashboard.tsx"
      provides: "Dashboard using PageLayout"
      contains: "PageLayout"
    - path: "src/routes/_authed/calendar.tsx"
      provides: "Calendar using PageLayout"
      contains: "PageLayout"
  key_links:
    - from: "src/routes/_authed.tsx"
      to: "src/components/layout/app-sidebar.tsx"
      via: "renders AppSidebar inside SidebarProvider"
      pattern: "<AppSidebar"
    - from: "src/routes/_authed/dashboard.tsx"
      to: "src/components/layout/page-layout.tsx"
      via: "wraps content in PageLayout"
      pattern: "<PageLayout"
    - from: "src/routes/_authed/calendar.tsx"
      to: "src/components/layout/page-layout.tsx"
      via: "wraps content in PageLayout"
      pattern: "<PageLayout"
---

<objective>
Wire the sidebar layout into the _authed route and migrate Dashboard and Calendar pages to use PageLayout, eliminating duplicate page wrapper code and Header imports from these two routes.

Purpose: The _authed layout becomes the single source of truth for the app shell (sidebar + content area). Dashboard and Calendar drop their inline `<div className="min-h-screen bg-slate-50"><Header />` wrappers and use PageLayout for consistent container widths, loading, and error states.

Output: 3 modified route files with consistent layout.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-consistent-ui-dashboard-layout/09-01-SUMMARY.md
@src/routes/_authed.tsx
@src/routes/_authed/dashboard.tsx
@src/routes/_authed/calendar.tsx
@src/components/layout/header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire SidebarProvider and AppSidebar into _authed.tsx layout</name>
  <files>
    src/routes/_authed.tsx
  </files>
  <action>
Modify `src/routes/_authed.tsx` to wrap the Outlet with the sidebar layout:

1. Add imports:
   - `SidebarProvider, SidebarInset` from `@/components/ui/sidebar`
   - `AppSidebar` from `@/components/layout/app-sidebar`

2. Change `component: () => <Outlet />` to a named component function `AuthedLayout`:
   ```tsx
   function AuthedLayout() {
     const { user } = Route.useRouteContext()
     return (
       <SidebarProvider>
         <AppSidebar user={user} />
         <SidebarInset>
           <Outlet />
         </SidebarInset>
       </SidebarProvider>
     )
   }
   ```

3. Update the route config to use `component: AuthedLayout`

4. The `beforeLoad` function stays unchanged — it still does the auth guard check and passes `user` via route context.

**Important:** The SidebarInset component provides the `min-h-screen` and background styling, so child routes no longer need `<div className="min-h-screen bg-slate-50">` wrappers. The SidebarInset also handles the left margin offset for the sidebar.
  </action>
  <verify>
    - Run `npx tsc --noEmit` — no type errors
    - Run `npm run dev` and visit `/dashboard` — should see sidebar on left (may look broken until Dashboard is migrated, but no crash)
  </verify>
  <done>
    _authed.tsx wraps all authenticated routes with SidebarProvider + AppSidebar + SidebarInset. Sidebar navigation visible on all authed pages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate Dashboard and Calendar routes to PageLayout</name>
  <files>
    src/routes/_authed/dashboard.tsx
    src/routes/_authed/calendar.tsx
  </files>
  <action>
**Dashboard (`src/routes/_authed/dashboard.tsx`):**

1. Remove import of `Header` from `@/components/layout/header`
2. Add imports:
   - `PageLayout` from `@/components/layout/page-layout`
   - `PageHeader` from `@/components/layout/page-header`
3. Remove the `const { user } = Route.useRouteContext()` line (no longer needed — user is consumed by AppSidebar in parent)
4. Replace the entire return block. Remove the outer `<div className="min-h-screen bg-slate-50">`, `<Header user={user} />`, and `<main className="container mx-auto px-4 py-8">` wrapper.
5. New structure:
   ```tsx
   return (
     <>
       <PageHeader title="Dashboard" />
       <PageLayout maxWidth="wide" isLoading={isLoading} error={error ?? null} onRetry={() => refetch()}>
         {/* Stats bar */}
         <StatsBar />
         {/* Header with create button */}
         {projects && projects.length > 0 && (
           <div className="flex items-center justify-between mb-6">
             <h2 className="text-2xl font-bold text-slate-900">Your Projects</h2>
             <Button onClick={handleCreateProject}>
               <Plus className="h-4 w-4 mr-2" />
               Create Project
             </Button>
           </div>
         )}
         {/* Empty state or project grid */}
         {projects && projects.length === 0 ? (
           <EmptyDashboardState onCreateProject={handleCreateProject} />
         ) : (
           <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
             {projects?.map((project) => (
               <ProjectCard key={project.id} project={project} onEdit={handleEditProject} onDelete={handleDeleteProject} />
             ))}
           </div>
         )}
       </PageLayout>
       {/* Dialogs remain outside PageLayout */}
       <ProjectDialog ... />
       <DeleteDialog ... />
     </>
   )
   ```
6. Remove the inline loading spinner `<div className="flex items-center justify-center py-12">` — PageLayout handles this
7. Remove the inline error state — PageLayout handles this
8. Remove the `{!isLoading && !error && (...)}` conditional wrapping — PageLayout only renders children when not loading and no error
9. Move the page title from inline `<h2>` to PageHeader `title` prop. Keep the "Your Projects" heading inline as a section heading.

**Calendar (`src/routes/_authed/calendar.tsx`):**

1. Remove import of `Header` from `@/components/layout/header`
2. Add imports:
   - `PageLayout` from `@/components/layout/page-layout`
   - `PageHeader` from `@/components/layout/page-header`
3. Remove the outer `<div className="min-h-screen bg-slate-50">`, `<Header user={user} />` wrapper
4. The Calendar page has special requirements:
   - It uses `mr-[350px]` when pin sidebar is open
   - It has its own inline loading skeleton (calendar grid skeleton), not just a spinner
   - It manages PinSidebar (right panel) which is separate from app sidebar (left panel)
5. New structure:
   ```tsx
   return (
     <>
       <PageHeader title="Calendar" />
       <PageLayout maxWidth="wide" className={cn(selectedPinId && "mr-[350px]")}>
         {/* All existing toolbar, status chips, loading skeleton, content */}
         {/* Keep the existing calendar-specific loading skeleton as-is */}
         {/* Do NOT use PageLayout's isLoading — calendar has custom skeleton */}
       </PageLayout>
       {/* Pin Sidebar stays outside PageLayout, positioned fixed on right */}
       <PinSidebar pinId={selectedPinId} onClose={() => setSelectedPinId(null)} />
     </>
   )
   ```
6. Remove the `const { user } = Route.useRouteContext()` line since `user` is no longer needed (was only used for `<Header user={user} />`).
7. **Important:** Do NOT pass `isLoading` to PageLayout for calendar — it has its own custom calendar grid skeleton that should remain. The calendar loading state is a grid skeleton, not a spinner.
8. Keep all existing calendar functionality intact: filters, status chips, view toggle, drag-and-drop, pin sidebar interaction.
  </action>
  <verify>
    - Run `npx tsc --noEmit` — no type errors
    - Run `npm run build` — successful build
    - Grep for `Header` in dashboard.tsx and calendar.tsx — no matches
    - Grep for `min-h-screen bg-slate-50` in dashboard.tsx and calendar.tsx — no matches
    - Confirm `PageLayout` and `PageHeader` are imported in both files
  </verify>
  <done>
    Dashboard and Calendar routes use PageLayout and PageHeader. No more inline page wrappers or Header imports. Dashboard loading/error handled by PageLayout. Calendar retains its custom grid skeleton and pin sidebar interaction.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- `npm run build` succeeds
- _authed.tsx renders SidebarProvider > AppSidebar + SidebarInset > Outlet
- Dashboard uses `<PageHeader title="Dashboard" />` and `<PageLayout maxWidth="wide">`
- Calendar uses `<PageHeader title="Calendar" />` and `<PageLayout maxWidth="wide">`
- No `Header` import in dashboard.tsx or calendar.tsx
- No `min-h-screen bg-slate-50` wrapper in dashboard.tsx or calendar.tsx
- Calendar pin sidebar (right panel) still works alongside app sidebar (left panel)
- Sidebar shows Dashboard and Calendar nav items
</verification>

<success_criteria>
_authed.tsx provides the sidebar shell for all authenticated routes. Dashboard and Calendar are fully migrated to use PageLayout and PageHeader with no duplicate wrapper code.
</success_criteria>

<output>
After completion, create `.planning/phases/09-consistent-ui-dashboard-layout/09-02-SUMMARY.md`
</output>
