---
phase: 09-consistent-ui-dashboard-layout
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - src/routes/_authed/projects/$projectId/articles/$articleId.tsx
  - src/routes/_authed/projects/$projectId/pins/$pinId.tsx
  - src/components/articles/articles-table.tsx
  - src/components/pins/pins-list.tsx
  - src/components/pins/pin-card.tsx
  - src/components/calendar/pin-sidebar.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Article detail URL follows pattern /projects/{projectId}/articles/{articleId}"
    - "Pin detail URL follows pattern /projects/{projectId}/pins/{pinId}"
    - "Article breadcrumbs show Dashboard > [Project Name] > [Article Title]"
    - "Pin breadcrumbs show Dashboard > [Project Name] > [Pin Title]"
    - "All navigation links to article and pin detail pages pass projectId parameter"
  artifacts:
    - path: "src/routes/_authed/projects/$projectId/articles/$articleId.tsx"
      provides: "Article detail page at nested route under projects"
    - path: "src/routes/_authed/projects/$projectId/pins/$pinId.tsx"
      provides: "Pin detail page at nested route under projects"
  key_links:
    - from: "src/components/articles/articles-table.tsx"
      to: "/projects/$projectId/articles/$articleId"
      via: "TanStack Router Link component"
      pattern: 'to="/projects/\\$projectId/articles/\\$articleId"'
    - from: "src/components/pins/pins-list.tsx"
      to: "/projects/$projectId/pins/$pinId"
      via: "TanStack Router Link component"
      pattern: 'to="/projects/\\$projectId/pins/\\$pinId"'
    - from: "src/components/pins/pin-card.tsx"
      to: "/projects/$projectId/pins/$pinId"
      via: "TanStack Router Link component"
      pattern: 'to="/projects/\\$projectId/pins/\\$pinId"'
    - from: "src/components/calendar/pin-sidebar.tsx"
      to: "both article and pin nested routes"
      via: "TanStack Router Link components using pin.blog_project_id"
      pattern: "blog_project_id"
---

<objective>
Move article and pin detail routes from flat paths (/articles/$articleId, /pins/$pinId) to nested paths under projects (/projects/$projectId/articles/$articleId, /projects/$projectId/pins/$pinId). Update all navigation links and breadcrumbs.

Purpose: User wants URLs and breadcrumbs to reflect the project hierarchy: /projects/[project]/articles/[article] and /projects/[project]/pins/[pin].
Output: Nested route files, updated navigation links across 6 files, project-aware breadcrumbs.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move route files to nested paths under projects</name>
  <files>
    src/routes/_authed/projects/$projectId/articles/$articleId.tsx
    src/routes/_authed/projects/$projectId/pins/$pinId.tsx
    src/routes/_authed/articles/$articleId.tsx
    src/routes/_authed/pins/$pinId.tsx
  </files>
  <action>
**Step 1: Create nested route directories and files.**

Create `src/routes/_authed/projects/$projectId/articles/$articleId.tsx`:
- Copy content from `src/routes/_authed/articles/$articleId.tsx`
- Change the route definition from:
  `createFileRoute('/_authed/articles/$articleId')`
  to:
  `createFileRoute('/_authed/projects/$projectId/articles/$articleId')`
- Extract BOTH `projectId` and `articleId` from `Route.useParams()`
- Add a `useBlogProject(projectId)` hook call to get the project name for breadcrumbs
- Update breadcrumbs from:
  `[{ label: "Dashboard", href: "/dashboard" }, { label: article?.title || "Article" }]`
  to:
  `[{ label: "Dashboard", href: "/dashboard" }, { label: project?.name || "Project", href: "/projects/$id" with params { id: projectId } }, { label: article?.title || "Article" }]`
- Import `useBlogProject` from `@/lib/hooks/use-blog-projects`
- Update the handleArchive navigation: it already navigates to `/projects/$id` which is correct
- The `Link` component for breadcrumbs needs `params` for the project link. Since PageHeader breadcrumbs use `href` as a string, you need to construct the URL: `href: \`/projects/${projectId}\`` (template literal, not Link params)

Create `src/routes/_authed/projects/$projectId/pins/$pinId.tsx`:
- Copy content from `src/routes/_authed/pins/$pinId.tsx`
- Change the route definition from:
  `createFileRoute('/_authed/pins/$pinId')`
  to:
  `createFileRoute('/_authed/projects/$projectId/pins/$pinId')`
- Extract BOTH `projectId` and `pinId` from `Route.useParams()`
- Add a `useBlogProject(projectId)` hook call to get the project name for breadcrumbs
- Update breadcrumbs from:
  `[{ label: "Dashboard", href: "/dashboard" }, { label: pin?.title || "Pin" }]`
  to:
  `[{ label: "Dashboard", href: "/dashboard" }, { label: project?.name || "Project", href: \`/projects/${projectId}\` }, { label: pin?.title || "Pin" }]`
- Import `useBlogProject` from `@/lib/hooks/use-blog-projects`
- Update the PinArticleLink sub-component: change the article link from:
  `to="/articles/$articleId" params={{ articleId: article.id }}`
  to:
  `to="/projects/$projectId/articles/$articleId" params={{ projectId, articleId: article.id }}`
  This requires passing `projectId` as a prop to `PinArticleLink`. Update the interface and the call site.
- Update the onDeleted navigation in DeletePinDialog — it already navigates to `/projects/$id` which is correct

**Step 2: Delete old route files.**

Delete `src/routes/_authed/articles/$articleId.tsx` and `src/routes/_authed/pins/$pinId.tsx`.

After deletion, also remove the now-empty directories:
- `src/routes/_authed/articles/` (if empty)
- `src/routes/_authed/pins/` (if empty)

**Step 3: Regenerate route tree.**

Run `npm run dev` briefly (or the TanStack Router CLI if available) to regenerate `src/routeTree.gen.ts`. The route tree auto-generates on file changes during dev. Verify the generated file includes the new nested routes and does NOT include the old flat routes.

**Note on TanStack Router file-based routing:**
- The directory structure `projects/$projectId/articles/$articleId.tsx` creates the route path `/projects/:projectId/articles/:articleId`
- The `$` prefix denotes dynamic segments
- The `_authed` prefix is a layout route (pathless), so the full URL is `/projects/:projectId/articles/:articleId` (not `/_authed/projects/...`)
- The existing `src/routes/_authed/projects/$id.tsx` uses `$id` as the param name. The new nested routes should use `$projectId` for clarity. This means the nested routes will have a DIFFERENT param name than the parent `$id.tsx`. This is fine — TanStack Router resolves params per route segment. But the new route files at `projects/$projectId/articles/$articleId.tsx` will NOT be children of `projects/$id.tsx` since `$projectId` differs from `$id`. They will be separate route branches. This is the desired behavior — article/pin detail pages are standalone pages, not nested within the project detail layout.
  </action>
  <verify>
1. Run `npm run dev` — no compilation errors
2. Check `src/routeTree.gen.ts` includes routes for `/_authed/projects/$projectId/articles/$articleId` and `/_authed/projects/$projectId/pins/$pinId`
3. Check `src/routeTree.gen.ts` does NOT include old routes `/_authed/articles/$articleId` or `/_authed/pins/$pinId`
4. Verify old route files are deleted
5. Verify new route files exist at correct paths
  </verify>
  <done>
- New nested route files exist at `src/routes/_authed/projects/$projectId/articles/$articleId.tsx` and `src/routes/_authed/projects/$projectId/pins/$pinId.tsx`
- Old flat route files deleted
- Route tree regenerated with correct paths
- Breadcrumbs show 3-level hierarchy: Dashboard > Project > Entity
  </done>
</task>

<task type="auto">
  <name>Task 2: Update all navigation links to use nested routes</name>
  <files>
    src/components/articles/articles-table.tsx
    src/components/pins/pins-list.tsx
    src/components/pins/pin-card.tsx
    src/components/calendar/pin-sidebar.tsx
  </files>
  <action>
Update all 7 link locations across 4 component files to use the new nested route paths. Each component already has `projectId` available as a prop.

**1. `src/components/articles/articles-table.tsx` (line ~165-171):**
- The component receives `projectId` as a prop (`ArticlesTableProps`)
- Change:
  `to="/articles/$articleId" params={{ articleId: article.id }}`
  to:
  `to="/projects/$projectId/articles/$articleId" params={{ projectId, articleId: article.id }}`

**2. `src/components/pins/pins-list.tsx` (3 locations):**
- The component receives `projectId` as a prop (`PinsListProps`)
- Location 1 (~line 444-454): Table view title link
  Change: `to="/pins/$pinId" params={{ pinId: pin.id }}`
  to: `to="/projects/$projectId/pins/$pinId" params={{ projectId, pinId: pin.id }}`
- Location 2 (~line 479-481): Dropdown "View / Edit" link
  Change: `to="/pins/$pinId" params={{ pinId: pin.id }}`
  to: `to="/projects/$projectId/pins/$pinId" params={{ projectId, pinId: pin.id }}`
- Location 3: Search for any other `/pins/$pinId` links in this file and update them

**3. `src/components/pins/pin-card.tsx` (line ~17):**
- The component receives `pin` which has `blog_project_id`. However, the component interface (`PinCardProps`) does NOT include `projectId` directly.
- Option A (preferred): Add `projectId: string` to `PinCardProps` interface. Update the parent component (PinsList grid view) to pass `projectId={projectId}` when rendering PinCard.
- Option B: Use `pin.blog_project_id` directly since `Pin` type should have this field.
- Use whichever is cleanest. `pin.blog_project_id` is already available on the Pin type, so Option B avoids interface changes:
  `to="/projects/$projectId/pins/$pinId" params={{ projectId: pin.blog_project_id, pinId: pin.id }}`

**4. `src/components/calendar/pin-sidebar.tsx` (~line 329 and ~line 342):**
- The component fetches `pin` via `usePin(pinId)`, and `pin.blog_project_id` is available
- Article link (~line 329):
  Change: `to="/articles/$articleId" params={{ articleId: article.id }}`
  to: `to="/projects/$projectId/articles/$articleId" params={{ projectId: pin.blog_project_id, articleId: article.id }}`
  Note: Must guard that `pin` is loaded before rendering this link (it already is — the link is inside `{article && (...)}` but also needs `pin` to be available for `blog_project_id`)
- Pin detail link (~line 342):
  Change: `to="/pins/$pinId" params={{ pinId: pin.id }}`
  to: `to="/projects/$projectId/pins/$pinId" params={{ projectId: pin.blog_project_id, pinId: pin.id }}`

**After all changes:**
Run a project-wide search for `/articles/$articleId` and `/pins/$pinId` to confirm NO remaining flat route references exist anywhere in the `src/` directory (excluding `routeTree.gen.ts` which auto-generates).
  </action>
  <verify>
1. `npm run build` passes with no TypeScript errors
2. Grep for `to="/articles/$articleId"` in src/ — should return 0 results (excluding routeTree.gen.ts)
3. Grep for `to="/pins/$pinId"` in src/ — should return 0 results (excluding routeTree.gen.ts)
4. Run `npm run dev`, navigate to a project detail page, click on an article — URL should be `/projects/{projectId}/articles/{articleId}`
5. Click on a pin from pins list — URL should be `/projects/{projectId}/pins/{pinId}`
6. From calendar sidebar, click "Open Full Detail" — URL should be nested
7. Breadcrumbs on article detail: "Dashboard > [Project Name] > [Article Title]"
8. Breadcrumbs on pin detail: "Dashboard > [Project Name] > [Pin Title]"
  </verify>
  <done>
- All 7 link locations updated to nested route paths
- No remaining flat route references in source code
- Article URLs: /projects/{projectId}/articles/{articleId}
- Pin URLs: /projects/{projectId}/pins/{pinId}
- Breadcrumbs show 3-level hierarchy on both article and pin detail pages
- TypeScript compilation passes
  </done>
</task>

</tasks>

<verification>
- Navigate to project detail > click article title > URL is /projects/{id}/articles/{id} with breadcrumbs "Dashboard > Project > Article"
- Navigate to project detail > click pin title > URL is /projects/{id}/pins/{id} with breadcrumbs "Dashboard > Project > Pin"
- Calendar sidebar "Open Full Detail" link goes to nested URL
- Pin detail page article link goes to nested article URL
- `npm run build` passes
- No flat route references remain in source
</verification>

<success_criteria>
UAT gaps (tests 7, 8) resolved: Article and pin detail pages use nested URLs under projects, breadcrumbs show full hierarchy.
</success_criteria>

<output>
After completion, create `.planning/phases/09-consistent-ui-dashboard-layout/09-07-SUMMARY.md`
</output>
